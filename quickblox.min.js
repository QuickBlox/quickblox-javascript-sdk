!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).QB=e()}}(function(){return function(){return function e(t,n,r){function i(o,a){if(!n[o]){if(!t[o]){var c="function"==typeof require&&require;if(!a&&c)return c(o,!0);if(s)return s(o,!0);var d=new Error("Cannot find module '"+o+"'");throw d.code="MODULE_NOT_FOUND",d}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){return i(t[o][1][e]||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var s="function"==typeof require&&require,o=0;o<r.length;o++)i(r[o]);return i}}()({1:[function(e,t,n){var r,i;r=this,i=function(){var e=e||function(e,t){var n={},r=n.lib={},i=r.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var n=new e;return t&&n.mixIn(t),n.hasOwnProperty("init")||(n.init=function(){n.$super.init.apply(this,arguments)}),n.init.prototype=n,n.$super=this,n},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),s=r.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,i=e.sigBytes;if(this.clamp(),r%4)for(var s=0;i>s;s++){var o=255&n[s>>>2]>>>24-s%4*8;t[r+s>>>2]|=o<<24-(r+s)%4*8}else if(n.length>65535)for(s=0;i>s;s+=4)t[r+s>>>2]=n[s>>>2];else t.push.apply(t,n);return this.sigBytes+=i,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;t>r;r+=4)n.push(0|4294967296*e.random());return new s.init(n,t)}}),o=n.enc={},a=o.Hex={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;n>i;i++){var s=255&t[i>>>2]>>>24-i%4*8;r.push((s>>>4).toString(16)),r.push((15&s).toString(16))}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;t>r;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new s.init(n,t/2)}},c=o.Latin1={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;n>i;i++){var s=255&t[i>>>2]>>>24-i%4*8;r.push(String.fromCharCode(s))}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;t>r;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new s.init(n,t)}},d=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},l=r.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,a=i/(4*o),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,d=e.min(4*c,i);if(c){for(var l=0;c>l;l+=o)this._doProcessBlock(r,l);var u=r.splice(0,c);n.sigBytes-=d}return new s.init(u,d)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=l.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new u.HMAC.init(e,n).finalize(t)}}});var u=n.algo={};return n}(Math);return e},"object"==typeof n?t.exports=n=i():r.CryptoJS=i()},{}],2:[function(e,t,n){var r,i;r=this,i=function(e){return e.HmacSHA1},"object"==typeof n?t.exports=n=i(e("./core"),e("./sha1"),e("./hmac")):i(r.CryptoJS)},{"./core":1,"./hmac":4,"./sha1":5}],3:[function(e,t,n){var r,i;r=this,i=function(e){return e.HmacSHA256},"object"==typeof n?t.exports=n=i(e("./core"),e("./sha256"),e("./hmac")):i(r.CryptoJS)},{"./core":1,"./hmac":4,"./sha256":6}],4:[function(e,t,n){var r,i;r=this,i=function(e){var t,n,r;n=(t=e).lib.Base,r=t.enc.Utf8,t.algo.HMAC=n.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=r.parse(t));var n=e.blockSize,i=4*n;t.sigBytes>i&&(t=e.finalize(t)),t.clamp();for(var s=this._oKey=t.clone(),o=this._iKey=t.clone(),a=s.words,c=o.words,d=0;n>d;d++)a[d]^=1549556828,c[d]^=909522486;s.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,n=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(n))}})},"object"==typeof n?t.exports=n=i(e("./core")):i(r.CryptoJS)},{"./core":1}],5:[function(e,t,n){var r,i;r=this,i=function(e){return n=(t=e).lib,r=n.WordArray,i=n.Hasher,s=t.algo,o=[],a=s.SHA1=i.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],a=n[3],c=n[4],d=0;80>d;d++){if(16>d)o[d]=0|e[t+d];else{var l=o[d-3]^o[d-8]^o[d-14]^o[d-16];o[d]=l<<1|l>>>31}var u=(r<<5|r>>>27)+c+o[d];u+=20>d?1518500249+(i&s|~i&a):40>d?1859775393+(i^s^a):60>d?(i&s|i&a|s&a)-1894007588:(i^s^a)-899497514,c=a,a=s,s=i<<30|i>>>2,i=r,r=u}n[0]=0|n[0]+r,n[1]=0|n[1]+i,n[2]=0|n[2]+s,n[3]=0|n[3]+a,n[4]=0|n[4]+c},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=Math.floor(n/4294967296),t[15+(r+64>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}}),t.SHA1=i._createHelper(a),t.HmacSHA1=i._createHmacHelper(a),e.SHA1;var t,n,r,i,s,o,a},"object"==typeof n?t.exports=n=i(e("./core")):i(r.CryptoJS)},{"./core":1}],6:[function(e,t,n){var r,i;r=this,i=function(e){return function(t){var n=e,r=n.lib,i=r.WordArray,s=r.Hasher,o=n.algo,a=[],c=[];!function(){function e(e){for(var n=t.sqrt(e),r=2;n>=r;r++)if(!(e%r))return!1;return!0}function n(e){return 0|4294967296*(e-(0|e))}for(var r=2,i=0;64>i;)e(r)&&(8>i&&(a[i]=n(t.pow(r,.5))),c[i]=n(t.pow(r,1/3)),i++),r++}();var d=[],l=o.SHA256=s.extend({_doReset:function(){this._hash=new i.init(a.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],o=n[3],a=n[4],l=n[5],u=n[6],h=n[7],p=0;64>p;p++){if(16>p)d[p]=0|e[t+p];else{var f=d[p-15],m=(f<<25|f>>>7)^(f<<14|f>>>18)^f>>>3,g=d[p-2],v=(g<<15|g>>>17)^(g<<13|g>>>19)^g>>>10;d[p]=m+d[p-7]+v+d[p-16]}var S=r&i^r&s^i&s,y=(r<<30|r>>>2)^(r<<19|r>>>13)^(r<<10|r>>>22),b=h+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&l^~a&u)+c[p]+d[p];h=u,u=l,l=a,a=0|o+b,o=s,s=i,i=r,r=0|b+(y+S)}n[0]=0|n[0]+r,n[1]=0|n[1]+i,n[2]=0|n[2]+s,n[3]=0|n[3]+o,n[4]=0|n[4]+a,n[5]=0|n[5]+l,n[6]=0|n[6]+u,n[7]=0|n[7]+h},_doFinalize:function(){var e=this._data,n=e.words,r=8*this._nDataBytes,i=8*e.sigBytes;return n[i>>>5]|=128<<24-i%32,n[14+(i+64>>>9<<4)]=t.floor(r/4294967296),n[15+(i+64>>>9<<4)]=r,e.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});n.SHA256=s._createHelper(l),n.HmacSHA256=s._createHmacHelper(l)}(Math),e.SHA256},"object"==typeof n?t.exports=n=i(e("./core")):i(r.CryptoJS)},{"./core":1}],7:[function(e,t,n){"use strict";var r=e("sdp");function i(e,t,n,i,s){var o=r.writeRtpDescription(e.kind,t);if(o+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":s||"active"),o+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var c="msid:"+(i?i.id:"-")+" "+a+"\r\n";o+="a="+c,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),o}function s(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},i=function(e,t,n,i){var s=r(e.parameters.apt,n),o=r(t.parameters.apt,i);return s&&o&&s.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach(function(r){for(var s=0;s<t.codecs.length;s++){var o=t.codecs[s];if(r.name.toLowerCase()===o.name.toLowerCase()&&r.clockRate===o.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&o.parameters.apt&&!i(r,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(r.numChannels,o.numChannels),n.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter(function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var r=0;r<t.headerExtensions.length;r++){var i=t.headerExtensions[r];if(e.uri===i.uri){n.headerExtensions.push(i);break}}}),n}function o(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function a(e,t){var n=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return n||e.addRemoteCandidate(t),!n}function c(e,t){var n=new Error(t);return n.name=e,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],n}t.exports=function(e,t){function n(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function d(t,n,r,i){var s=new Event("track");s.track=n,s.receiver=r,s.transceiver={receiver:r},s.streams=i,e.setTimeout(function(){t._dispatchEvent("track",s)})}var l=function(n){var i=this,s=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){i[e]=s[e].bind(s)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=function(e,t){var n=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var i="string"==typeof r;return i&&(r=[r]),r=r.filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||n?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(n=!0,!0)}),delete e.url,e.urls=i?r[0]:r,!!r.length}})}(n.iceServers||[],t),this._iceGatherers=[],n.iceCandidatePoolSize)for(var o=n.iceCandidatePoolSize;o>0;o--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=r.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e,t){var n=this.transceivers.length>0,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&n)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this._createIceAndDtlsTransports();r.iceTransport=i.iceTransport,r.dtlsTransport=i.dtlsTransport}return t||this.transceivers.push(r),r},l.prototype.addTrack=function(t,n){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var r;if(this.transceivers.find(function(e){return e.track===t}))throw c("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(r=this.transceivers[i]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),r.track=t,r.stream=n,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},l.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach(function(t){n.addTrack(t,e)});else{var r=e.clone();e.getTracks().forEach(function(e,t){var n=r.getTracks()[t];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),r.getTracks().forEach(function(e){n.addTrack(e,r)})}},l.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find(function(e){return e.rtpSender===t});if(!n)throw c("InvalidAccessError","Sender was not created by this connection.");var r=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(r)&&this.localStreams.indexOf(r)>-1&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded()},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var n=t.getSenders().find(function(t){return t.track===e});n&&t.removeTrack(n)})},l.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},l.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},l.prototype._createIceGatherer=function(t,n){var r=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;i.state=n?"completed":"gathering",null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},l.prototype._gather=function(t,n){var i=this,s=this.transceivers[n].iceGatherer;if(!s.onlocalcandidate){var o=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,s.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),s.onlocalcandidate=function(e){if(!(i.usingBundle&&n>0)){var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:n};var a=e.candidate,c=!a||0===Object.keys(a).length;if(c)"new"!==s.state&&"gathering"!==s.state||(s.state="completed");else{"new"===s.state&&(s.state="gathering"),a.component=1,a.ufrag=s.getLocalParameters().usernameFragment;var d=r.writeCandidate(a);o.candidate=Object.assign(o.candidate,r.parseCandidate(d)),o.candidate.candidate=d,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var l=r.getMediaSections(i._localDescription.sdp);l[o.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+o.candidate.candidate+"\r\n",i._localDescription.sdp=r.getDescription(i._localDescription.sdp)+l.join("");var u=i.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),c||i._dispatchEvent("icecandidate",o),u&&(i._dispatchEvent("icecandidate",new Event("icecandidate")),i.iceGatheringState="complete",i._emitGatheringStateChange())}},e.setTimeout(function(){o.forEach(function(e){s.onlocalcandidate(e)})},0)}},l.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var r=new e.RTCDtlsTransport(n);return r.ondtlsstatechange=function(){t._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:n,dtlsTransport:r}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},l.prototype._transceive=function(e,n,i){var o=s(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(o.encodings=e.sendEncodingParameters,o.rtcp={cname:r.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(o.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(o)),i&&e.rtpReceiver&&o.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?o.encodings=e.recvEncodingParameters:o.encodings=[{}],o.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(o.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(o.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(o))},l.prototype.setLocalDescription=function(e){var t,n,i=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!o("setLocalDescription",e.type,i.signalingState)||i._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+i.signalingState));if("offer"===e.type)t=r.splitSections(e.sdp),n=t.shift(),t.forEach(function(e,t){var n=r.parseRtpParameters(e);i.transceivers[t].localCapabilities=n}),i.transceivers.forEach(function(e,t){i._gather(e.mid,t)});else if("answer"===e.type){t=r.splitSections(i._remoteDescription.sdp),n=t.shift();var a=r.matchPrefix(n,"a=ice-lite").length>0;t.forEach(function(e,t){var o=i.transceivers[t],c=o.iceGatherer,d=o.iceTransport,l=o.dtlsTransport,u=o.localCapabilities,h=o.remoteCapabilities;if(!(r.isRejected(e)&&0===r.matchPrefix(e,"a=bundle-only").length)&&!o.rejected){var p=r.getIceParameters(e,n),f=r.getDtlsParameters(e,n);a&&(f.role="server"),i.usingBundle&&0!==t||(i._gather(o.mid,t),"new"===d.state&&d.start(c,p,a?"controlling":"controlled"),"new"===l.state&&l.start(f));var m=s(u,h);i._transceive(o,m.codecs.length>0,!1)}})}return i._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(i){var l=this;if(-1===["offer","answer"].indexOf(i.type))return Promise.reject(c("TypeError",'Unsupported type "'+i.type+'"'));if(!o("setRemoteDescription",i.type,l.signalingState)||l._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+i.type+" in state "+l.signalingState));var u={};l.remoteStreams.forEach(function(e){u[e.id]=e});var h=[],p=r.splitSections(i.sdp),f=p.shift(),m=r.matchPrefix(f,"a=ice-lite").length>0,g=r.matchPrefix(f,"a=group:BUNDLE ").length>0;l.usingBundle=g;var v=r.matchPrefix(f,"a=ice-options:")[0];return l.canTrickleIceCandidates=!!v&&v.substr(14).split(" ").indexOf("trickle")>=0,p.forEach(function(o,c){var d=r.splitLines(o),p=r.getKind(o),v=r.isRejected(o)&&0===r.matchPrefix(o,"a=bundle-only").length,S=d[0].substr(2).split(" ")[2],y=r.getDirection(o,f),b=r.parseMsid(o),C=r.getMid(o)||r.generateIdentifier();if(v||"application"===p&&("DTLS/SCTP"===S||"UDP/DTLS/SCTP"===S))l.transceivers[c]={mid:C,kind:p,protocol:S,rejected:!0};else{var _,T,E,w,x,I,R,k,A;!v&&l.transceivers[c]&&l.transceivers[c].rejected&&(l.transceivers[c]=l._createTransceiver(p,!0));var O,N,D=r.parseRtpParameters(o);v||(O=r.getIceParameters(o,f),(N=r.getDtlsParameters(o,f)).role="client"),R=r.parseRtpEncodingParameters(o);var P=r.parseRtcpParameters(o),L=r.matchPrefix(o,"a=end-of-candidates",f).length>0,M=r.matchPrefix(o,"a=candidate:").map(function(e){return r.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===i.type||"answer"===i.type)&&!v&&g&&c>0&&l.transceivers[c]&&(l._disposeIceAndDtlsTransports(c),l.transceivers[c].iceGatherer=l.transceivers[0].iceGatherer,l.transceivers[c].iceTransport=l.transceivers[0].iceTransport,l.transceivers[c].dtlsTransport=l.transceivers[0].dtlsTransport,l.transceivers[c].rtpSender&&l.transceivers[c].rtpSender.setTransport(l.transceivers[0].dtlsTransport),l.transceivers[c].rtpReceiver&&l.transceivers[c].rtpReceiver.setTransport(l.transceivers[0].dtlsTransport)),"offer"!==i.type||v){if("answer"===i.type&&!v){T=(_=l.transceivers[c]).iceGatherer,E=_.iceTransport,w=_.dtlsTransport,x=_.rtpReceiver,I=_.sendEncodingParameters,k=_.localCapabilities,l.transceivers[c].recvEncodingParameters=R,l.transceivers[c].remoteCapabilities=D,l.transceivers[c].rtcpParameters=P,M.length&&"new"===E.state&&(!m&&!L||g&&0!==c?M.forEach(function(e){a(_.iceTransport,e)}):E.setRemoteCandidates(M)),g&&0!==c||("new"===E.state&&E.start(T,O,"controlling"),"new"===w.state&&w.start(N)),!s(_.localCapabilities,_.remoteCapabilities).codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&_.sendEncodingParameters[0].rtx&&delete _.sendEncodingParameters[0].rtx,l._transceive(_,"sendrecv"===y||"recvonly"===y,"sendrecv"===y||"sendonly"===y),!x||"sendrecv"!==y&&"sendonly"!==y?delete _.rtpReceiver:(A=x.track,b?(u[b.stream]||(u[b.stream]=new e.MediaStream),n(A,u[b.stream]),h.push([A,x,u[b.stream]])):(u.default||(u.default=new e.MediaStream),n(A,u.default),h.push([A,x,u.default])))}}else{(_=l.transceivers[c]||l._createTransceiver(p)).mid=C,_.iceGatherer||(_.iceGatherer=l._createIceGatherer(c,g)),M.length&&"new"===_.iceTransport.state&&(!L||g&&0!==c?M.forEach(function(e){a(_.iceTransport,e)}):_.iceTransport.setRemoteCandidates(M)),k=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(k.codecs=k.codecs.filter(function(e){return"rtx"!==e.name})),I=_.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var j,q=!1;if("sendrecv"===y||"sendonly"===y){if(q=!_.rtpReceiver,x=_.rtpReceiver||new e.RTCRtpReceiver(_.dtlsTransport,p),q)A=x.track,b&&"-"===b.stream||(b?(u[b.stream]||(u[b.stream]=new e.MediaStream,Object.defineProperty(u[b.stream],"id",{get:function(){return b.stream}})),Object.defineProperty(A,"id",{get:function(){return b.track}}),j=u[b.stream]):(u.default||(u.default=new e.MediaStream),j=u.default)),j&&(n(A,j),_.associatedRemoteMediaStreams.push(j)),h.push([A,x,j])}else _.rtpReceiver&&_.rtpReceiver.track&&(_.associatedRemoteMediaStreams.forEach(function(t){var n,r,i=t.getTracks().find(function(e){return e.id===_.rtpReceiver.track.id});i&&(n=i,(r=t).removeTrack(n),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:n})))}),_.associatedRemoteMediaStreams=[]);_.localCapabilities=k,_.remoteCapabilities=D,_.rtpReceiver=x,_.rtcpParameters=P,_.sendEncodingParameters=I,_.recvEncodingParameters=R,l._transceive(l.transceivers[c],!1,q)}}}),void 0===l._dtlsRole&&(l._dtlsRole="offer"===i.type?"active":"passive"),l._remoteDescription={type:i.type,sdp:i.sdp},"offer"===i.type?l._updateSignalingState("have-remote-offer"):l._updateSignalingState("stable"),Object.keys(u).forEach(function(t){var n=u[t];if(n.getTracks().length){if(-1===l.remoteStreams.indexOf(n)){l.remoteStreams.push(n);var r=new Event("addstream");r.stream=n,e.setTimeout(function(){l._dispatchEvent("addstream",r)})}h.forEach(function(e){var t=e[0],r=e[1];n.id===e[2].id&&d(l,t,r,[n])})}}),h.forEach(function(e){e[2]||d(l,e[0],e[1],[])}),e.setTimeout(function(){l&&l.transceivers&&l.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},l.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++}),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",n)}},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)}),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var n=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",n)}},l.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var s=n.transceivers.filter(function(e){return"audio"===e.kind}).length,o=n.transceivers.filter(function(e){return"video"===e.kind}).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(s=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(o=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(n.transceivers.forEach(function(e){"audio"===e.kind?--s<0&&(e.wantReceive=!1):"video"===e.kind&&--o<0&&(e.wantReceive=!1)});s>0||o>0;)s>0&&(n._createTransceiver("audio"),s--),o>0&&(n._createTransceiver("video"),o--);var d=r.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.transceivers.forEach(function(i,s){var o=i.track,a=i.kind,c=i.mid||r.generateIdentifier();i.mid=c,i.iceGatherer||(i.iceGatherer=n._createIceGatherer(s,n.usingBundle));var d=e.RTCRtpSender.getCapabilities(a);t<15019&&(d.codecs=d.codecs.filter(function(e){return"rtx"!==e.name})),d.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),i.remoteCapabilities&&i.remoteCapabilities.codecs&&i.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),d.headerExtensions.forEach(function(e){(i.remoteCapabilities&&i.remoteCapabilities.headerExtensions||[]).forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var l=i.sendEncodingParameters||[{ssrc:1001*(2*s+1)}];o&&t>=15019&&"video"===a&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),i.wantReceive&&(i.rtpReceiver=new e.RTCRtpReceiver(i.dtlsTransport,a)),i.localCapabilities=d,i.sendEncodingParameters=l}),"max-compat"!==n._config.bundlePolicy&&(d+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n",n.transceivers.forEach(function(e,t){d+=i(e,e.localCapabilities,"offer",e.stream,n._dtlsRole),d+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===n.iceGatheringState||0!==t&&n.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,d+="a="+r.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(d+="a=end-of-candidates\r\n"))});var l=new e.RTCSessionDescription({type:"offer",sdp:d});return Promise.resolve(l)},l.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==n.signalingState&&"have-local-pranswer"!==n.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+n.signalingState));var o=r.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(o+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n";var a=r.getMediaSections(n._remoteDescription.sdp).length;n.transceivers.forEach(function(e,r){if(!(r+1>a)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?o+="m=application 0 DTLS/SCTP 5000\r\n":o+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?o+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(o+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(o+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;if(e.stream)"audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var d=s(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,o+=i(e,d,"answer",e.stream,n._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(o+="a=rtcp-rsize\r\n")}});var d=new e.RTCSessionDescription({type:"answer",sdp:o});return Promise.resolve(d)},l.prototype.addIceCandidate=function(e){var t,n=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(i,s){if(!n._remoteDescription)return s(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var o=e.sdpMLineIndex;if(e.sdpMid)for(var d=0;d<n.transceivers.length;d++)if(n.transceivers[d].mid===e.sdpMid){o=d;break}var l=n.transceivers[o];if(!l)return s(c("OperationError","Can not add ICE candidate"));if(l.rejected)return i();var u=Object.keys(e.candidate).length>0?r.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return i();if(u.component&&1!==u.component)return i();if((0===o||o>0&&l.iceTransport!==n.transceivers[0].iceTransport)&&!a(l.iceTransport,u))return s(c("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=r.getMediaSections(n._remoteDescription.sdp))[o]+="a="+(u.type?h:"end-of-candidates")+"\r\n",n._remoteDescription.sdp=r.getDescription(n._remoteDescription.sdp)+t.join("")}else for(var p=0;p<n.transceivers.length&&(n.transceivers[p].rejected||(n.transceivers[p].iceTransport.addRemoteCandidate({}),(t=r.getMediaSections(n._remoteDescription.sdp))[p]+="a=end-of-candidates\r\n",n._remoteDescription.sdp=r.getDescription(n._remoteDescription.sdp)+t.join(""),!n.usingBundle));p++);i()})},l.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var n=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?n=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(n=e.rtpReceiver)}),!n)throw c("InvalidAccessError","Invalid selector.");return n.getStats()}var r=[];return this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){e[t]&&r.push(e[t].getStats())})}),Promise.all(r).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(t){var n=e[t];if(n&&n.prototype&&n.prototype.getStats){var r=n.prototype.getStats;n.prototype.getStats=function(){return r.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(n){var r;e[n].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(r=e[n]).type]||r.type,t.set(n,e[n])}),t})}}});var u=["createOffer","createAnswer"];return u.forEach(function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),l}},{sdp:12}],8:[function(e,t,n){var r=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{push:"invalid",names:["value"]}]};Object.keys(r).forEach(function(e){r[e].forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})})},{}],9:[function(e,t,n){var r=e("./parser"),i=e("./writer");n.write=i,n.parse=r.parse,n.parseFmtpConfig=r.parseFmtpConfig,n.parseParams=r.parseParams,n.parsePayloads=r.parsePayloads,n.parseRemoteCandidates=r.parseRemoteCandidates,n.parseImageAttributes=r.parseImageAttributes,n.parseSimulcastStreamList=r.parseSimulcastStreamList},{"./parser":10,"./writer":11}],10:[function(e,t,n){var r=function(e){return String(Number(e))===e?Number(e):e},i=function(e,t,n){var i=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:i&&!t[e.name]&&(t[e.name]={});var s=e.push?{}:i?t[e.name]:t;!function(e,t,n,i){if(i&&!n)t[i]=r(e[1]);else for(var s=0;s<n.length;s+=1)null!=e[s+1]&&(t[n[s]]=r(e[s+1]))}(n.match(e.reg),s,e.names,e.name),e.push&&t[e.push].push(s)},s=e("./grammar"),o=RegExp.prototype.test.bind(/^([a-z])=(.*)/);n.parse=function(e){var t={},n=[],r=t;return e.split(/(\r\n|\r|\n)/).filter(o).forEach(function(e){var t=e[0],o=e.slice(2);"m"===t&&(n.push({rtp:[],fmtp:[]}),r=n[n.length-1]);for(var a=0;a<(s[t]||[]).length;a+=1){var c=s[t][a];if(c.reg.test(o))return i(c,r,o)}}),t.media=n,t};var a=function(e,t){var n=t.split(/=(.+)/,2);return 2===n.length?e[n[0]]=r(n[1]):1===n.length&&t.length>1&&(e[n[0]]=void 0),e};n.parseParams=function(e){return e.split(/;\s?/).reduce(a,{})},n.parseFmtpConfig=n.parseParams,n.parsePayloads=function(e){return e.toString().split(" ").map(Number)},n.parseRemoteCandidates=function(e){for(var t=[],n=e.split(" ").map(r),i=0;i<n.length;i+=3)t.push({component:n[i],ip:n[i+1],port:n[i+2]});return t},n.parseImageAttributes=function(e){return e.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(a,{})})},n.parseSimulcastStreamList=function(e){return e.split(";").map(function(e){return e.split(",").map(function(e){var t,n=!1;return"~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),n=!0),{scid:t,paused:n}})})}},{"./grammar":8}],11:[function(e,t,n){var r=e("./grammar"),i=/%[sdv%]/g,s=function(e,t,n){var r=[e+"="+(t.format instanceof Function?t.format(t.push?n:n[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var o=t.names[s];t.name?r.push(n[t.name][o]):r.push(n[t.names[s]])}else r.push(n[t.name]);return function(e){var t=1,n=arguments,r=n.length;return e.replace(i,function(e){if(t>=r)return e;var i=n[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}})}.apply(null,r)},o=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach(function(e){null==e.payloads&&(e.payloads="")});var n=t.outerOrder||o,i=t.innerOrder||a,c=[];return n.forEach(function(t){r[t].forEach(function(n){n.name in e&&null!=e[n.name]?c.push(s(t,n,e)):n.push in e&&null!=e[n.push]&&e[n.push].forEach(function(e){c.push(s(t,n,e))})})}),e.media.forEach(function(e){c.push(s("m",r.m[0],e)),i.forEach(function(t){r[t].forEach(function(n){n.name in e&&null!=e[n.name]?c.push(s(t,n,e)):n.push in e&&null!=e[n.push]&&e[n.push].forEach(function(e){c.push(s(t,n,e))})})})}),c.join("\r\n")+"\r\n"}},{"./grammar":8}],12:[function(e,t,n){"use strict";var r={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};r.localCName=r.generateIdentifier(),r.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},r.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},r.getDescription=function(e){var t=r.splitSections(e);return t&&t[0]},r.getMediaSections=function(e){var t=r.splitSections(e);return t.shift(),t},r.matchPrefix=function(e,t){return r.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},r.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:n[t[r]]=t[r+1]}return n},r.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},r.parseIceOptions=function(e){return e.substr(14).split(" ")},r.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},r.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},r.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},r.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},r.parseFmtp=function(e){for(var t,n={},r=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<r.length;i++)n[(t=r[i].trim().split("="))[0].trim()]=t[1];return n},r.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)}),t+="a=fmtp:"+n+" "+r.join(";")+"\r\n"}return t},r.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},r.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},r.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},r.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},r.getMid=function(e){var t=r.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},r.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},r.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:r.matchPrefix(e+t,"a=fingerprint:").map(r.parseFingerprint)}},r.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},r.getIceParameters=function(e,t){var n=r.splitLines(e);return{usernameFragment:(n=n.concat(r.splitLines(t))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:n.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},r.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},r.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=r.splitLines(e)[0].split(" "),i=3;i<n.length;i++){var s=n[i],o=r.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(o){var a=r.parseRtpMap(o),c=r.matchPrefix(e,"a=fmtp:"+s+" ");switch(a.parameters=c.length?r.parseFmtp(c[0]):{},a.rtcpFeedback=r.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(r.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase())}}}return r.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(r.parseExtmap(e))}),t},r.writeRtpDescription=function(e,t){var n="";n+="m="+e+" ",n+=t.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n+=r.writeRtpMap(e),n+=r.writeFmtp(e),n+=r.writeRtcpFb(e)});var i=0;return t.codecs.forEach(function(e){e.maxptime>i&&(i=e.maxptime)}),i>0&&(n+="a=maxptime:"+i+"\r\n"),n+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){n+=r.writeExtmap(e)}),n},r.parseRtpEncodingParameters=function(e){var t,n=[],i=r.parseRtpParameters(e),s=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=a.length>0&&a[0].ssrc,d=r.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),i.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var r={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(r.rtx={ssrc:t}),n.push(r),s&&((r=JSON.parse(JSON.stringify(r))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},n.push(r))}}),0===n.length&&c&&n.push({ssrc:c});var l=r.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,n.forEach(function(e){e.maxBitrate=l})),n},r.parseRtcpParameters=function(e){var t={},n=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];n&&(t.cname=n.value,t.ssrc=n.ssrc);var i=r.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0,t.compound=0===i.length;var s=r.matchPrefix(e,"a=rtcp-mux");return t.mux=s.length>0,t},r.parseMsid=function(e){var t,n=r.matchPrefix(e,"a=msid:");if(1===n.length)return{stream:(t=n[0].substr(7).split(" "))[0],track:t[1]};var i=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return i.length>0?{stream:(t=i[0].value.split(" "))[0],track:t[1]}:void 0},r.generateSessionId=function(){return Math.random().toString().substr(2,21)},r.writeSessionBoilerplate=function(e,t,n){var i=void 0!==t?t:2;return"v=0\r\no="+(n||"thisisadapterortc")+" "+(e||r.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},r.writeMediaSection=function(e,t,n,i){var s=r.writeRtpDescription(e.kind,t);if(s+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),s+="a=mid:"+e.mid+"\r\n",e.direction?s+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";s+="a="+o,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),s},r.getDirection=function(e,t){for(var n=r.splitLines(e),i=0;i<n.length;i++)switch(n[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[i].substr(2)}return t?r.getDirection(t):"sendrecv"},r.getKind=function(e){return r.splitLines(e)[0].split(" ")[0].substr(2)},r.isRejected=function(e){return"0"===e.split(" ",2)[1]},r.parseMLine=function(e){var t=r.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},r.parseOLine=function(e){var t=r.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},r.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=r.splitLines(e),n=0;n<t.length;n++)if(t[n].length<2||"="!==t[n].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=r)},{}],13:[function(e,t,n){!function(e){var t;if(t=function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t){var n,r,i,s,o,a,c,d="",l=0;do{s=(n=t.charCodeAt(l++))>>2,o=(3&n)<<4|(r=t.charCodeAt(l++))>>4,a=(15&r)<<2|(i=t.charCodeAt(l++))>>6,c=63&i,isNaN(r)?(o=(3&n)<<4,a=c=64):isNaN(i)&&(c=64),d=d+e.charAt(s)+e.charAt(o)+e.charAt(a)+e.charAt(c)}while(l<t.length);return d},decode:function(t){var n,r,i,s,o,a,c="",d=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{n=e.indexOf(t.charAt(d++))<<2|(s=e.indexOf(t.charAt(d++)))>>4,r=(15&s)<<4|(o=e.indexOf(t.charAt(d++)))>>2,i=(3&o)<<6|(a=e.indexOf(t.charAt(d++))),c+=String.fromCharCode(n),64!=o&&(c+=String.fromCharCode(r)),64!=a&&(c+=String.fromCharCode(i))}while(d<t.length);return c}}},this.Base64=t(),function(e,t){e.SHA1=t()}(this,function(){function e(e,r){e[r>>5]|=128<<24-r%32,e[15+(r+64>>9<<4)]=r;var o,a,c,d,l,u,h,p,f=new Array(80),m=1732584193,g=-271733879,v=-1732584194,S=271733878,y=-1009589776;for(o=0;o<e.length;o+=16){for(d=m,l=g,u=v,h=S,p=y,a=0;a<80;a++)f[a]=a<16?e[o+a]:s(f[a-3]^f[a-8]^f[a-14]^f[a-16],1),c=i(i(s(m,5),t(a,g,v,S)),i(i(y,f[a]),n(a))),y=S,S=v,v=s(g,30),g=m,m=c;m=i(m,d),g=i(g,l),v=i(v,u),S=i(S,h),y=i(y,p)}return[m,g,v,S,y]}function t(e,t,n,r){return e<20?t&n|~t&r:e<40?t^n^r:e<60?t&n|t&r|n&r:t^n^r}function n(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function r(t,n){var r=o(t);r.length>16&&(r=e(r,8*t.length));for(var i=new Array(16),s=new Array(16),a=0;a<16;a++)i[a]=909522486^r[a],s[a]=1549556828^r[a];var c=e(i.concat(o(n)),512+8*n.length);return e(s.concat(c),672)}function i(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function s(e,t){return e<<t|e>>>32-t}function o(e){for(var t=[],n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<24-n%32;return t}function a(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>24-n%32&255);return t}function c(e){for(var t,n,r="",i=0;i<4*e.length;i+=3)for(t=(e[i>>2]>>8*(3-i%4)&255)<<16|(e[i+1>>2]>>8*(3-(i+1)%4)&255)<<8|e[i+2>>2]>>8*(3-(i+2)%4)&255,n=0;n<4;n++)8*i+6*n>32*e.length?r+="=":r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(t>>6*(3-n)&63);return r}return{b64_hmac_sha1:function(e,t){return c(r(e,t))},b64_sha1:function(t){return c(e(o(t),8*t.length))},binb2str:a,core_hmac_sha1:r,str_hmac_sha1:function(e,t){return a(r(e,t))},str_sha1:function(t){return a(e(o(t),8*t.length))}}}),function(e,t){e.MD5=t()}(this,function(e){var t=function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},n=function(e){for(var t=[],n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t},r=function(e,n,r,i,s,o){return t((a=t(t(n,e),t(i,o)))<<(c=s)|a>>>32-c,r);var a,c},i=function(e,t,n,i,s,o,a){return r(t&n|~t&i,e,t,s,o,a)},s=function(e,t,n,i,s,o,a){return r(t&i|n&~i,e,t,s,o,a)},o=function(e,t,n,i,s,o,a){return r(t^n^i,e,t,s,o,a)},a=function(e,t,n,i,s,o,a){return r(n^(t|~i),e,t,s,o,a)},c=function(e,n){e[n>>5]|=128<<n%32,e[14+(n+64>>>9<<4)]=n;for(var r,c,d,l,u=1732584193,h=-271733879,p=-1732584194,f=271733878,m=0;m<e.length;m+=16)r=u,c=h,d=p,l=f,u=i(u,h,p,f,e[m+0],7,-680876936),f=i(f,u,h,p,e[m+1],12,-389564586),p=i(p,f,u,h,e[m+2],17,606105819),h=i(h,p,f,u,e[m+3],22,-1044525330),u=i(u,h,p,f,e[m+4],7,-176418897),f=i(f,u,h,p,e[m+5],12,1200080426),p=i(p,f,u,h,e[m+6],17,-1473231341),h=i(h,p,f,u,e[m+7],22,-45705983),u=i(u,h,p,f,e[m+8],7,1770035416),f=i(f,u,h,p,e[m+9],12,-1958414417),p=i(p,f,u,h,e[m+10],17,-42063),h=i(h,p,f,u,e[m+11],22,-1990404162),u=i(u,h,p,f,e[m+12],7,1804603682),f=i(f,u,h,p,e[m+13],12,-40341101),p=i(p,f,u,h,e[m+14],17,-1502002290),h=i(h,p,f,u,e[m+15],22,1236535329),u=s(u,h,p,f,e[m+1],5,-165796510),f=s(f,u,h,p,e[m+6],9,-1069501632),p=s(p,f,u,h,e[m+11],14,643717713),h=s(h,p,f,u,e[m+0],20,-373897302),u=s(u,h,p,f,e[m+5],5,-701558691),f=s(f,u,h,p,e[m+10],9,38016083),p=s(p,f,u,h,e[m+15],14,-660478335),h=s(h,p,f,u,e[m+4],20,-405537848),u=s(u,h,p,f,e[m+9],5,568446438),f=s(f,u,h,p,e[m+14],9,-1019803690),p=s(p,f,u,h,e[m+3],14,-187363961),h=s(h,p,f,u,e[m+8],20,1163531501),u=s(u,h,p,f,e[m+13],5,-1444681467),f=s(f,u,h,p,e[m+2],9,-51403784),p=s(p,f,u,h,e[m+7],14,1735328473),h=s(h,p,f,u,e[m+12],20,-1926607734),u=o(u,h,p,f,e[m+5],4,-378558),f=o(f,u,h,p,e[m+8],11,-2022574463),p=o(p,f,u,h,e[m+11],16,1839030562),h=o(h,p,f,u,e[m+14],23,-35309556),u=o(u,h,p,f,e[m+1],4,-1530992060),f=o(f,u,h,p,e[m+4],11,1272893353),p=o(p,f,u,h,e[m+7],16,-155497632),h=o(h,p,f,u,e[m+10],23,-1094730640),u=o(u,h,p,f,e[m+13],4,681279174),f=o(f,u,h,p,e[m+0],11,-358537222),p=o(p,f,u,h,e[m+3],16,-722521979),h=o(h,p,f,u,e[m+6],23,76029189),u=o(u,h,p,f,e[m+9],4,-640364487),f=o(f,u,h,p,e[m+12],11,-421815835),p=o(p,f,u,h,e[m+15],16,530742520),h=o(h,p,f,u,e[m+2],23,-995338651),u=a(u,h,p,f,e[m+0],6,-198630844),f=a(f,u,h,p,e[m+7],10,1126891415),p=a(p,f,u,h,e[m+14],15,-1416354905),h=a(h,p,f,u,e[m+5],21,-57434055),u=a(u,h,p,f,e[m+12],6,1700485571),f=a(f,u,h,p,e[m+3],10,-1894986606),p=a(p,f,u,h,e[m+10],15,-1051523),h=a(h,p,f,u,e[m+1],21,-2054922799),u=a(u,h,p,f,e[m+8],6,1873313359),f=a(f,u,h,p,e[m+15],10,-30611744),p=a(p,f,u,h,e[m+6],15,-1560198380),h=a(h,p,f,u,e[m+13],21,1309151649),u=a(u,h,p,f,e[m+4],6,-145523070),f=a(f,u,h,p,e[m+11],10,-1120210379),p=a(p,f,u,h,e[m+2],15,718787259),h=a(h,p,f,u,e[m+9],21,-343485551),u=t(u,r),h=t(h,c),p=t(p,d),f=t(f,l);return[u,h,p,f]};return{hexdigest:function(e){return function(e){for(var t="",n=0;n<4*e.length;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t}(c(n(e),8*e.length))},hash:function(e){return function(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}(c(n(e),8*e.length))}}}),function(e,t){e.stropheUtils=t()}(this,function(){return{utf16to8:function(e){var t,n,r="",i=e.length;for(t=0;t<i;t++)(n=e.charCodeAt(t))>=0&&n<=127?r+=e.charAt(t):n>2047?(r+=String.fromCharCode(224|n>>12&15),r+=String.fromCharCode(128|n>>6&63),r+=String.fromCharCode(128|n>>0&63)):(r+=String.fromCharCode(192|n>>6&31),r+=String.fromCharCode(128|n>>0&63));return r},addCookies:function(e){var t,n,r,i,s,o,a;for(t in e||{})s="",o="",a="",r="object"==typeof(n=e[t]),i=escape(unescape(r?n.value:n)),r&&(s=n.expires?";expires="+n.expires:"",o=n.domain?";domain="+n.domain:"",a=n.path?";path="+n.path:""),document.cookie=t+"="+i+s+o+a}}}),function(e,t){t()}(0,function(){Function.prototype.bind||(Function.prototype.bind=function(e){var t=this,n=Array.prototype.slice,r=Array.prototype.concat,i=n.call(arguments,1);return function(){return t.apply(e||this,r.call(i,n.call(arguments,0)))}}),Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=Number(arguments[1])||0;for((n=n<0?Math.ceil(n):Math.floor(n))<0&&(n+=t);n<t;n++)if(n in this&&this[n]===e)return n;return-1})}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n,r;if(null===this)throw new TypeError(" this is null or not defined");var i=Object(this),s=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),r=0;r<s;){var o;r in i&&(o=i[r],e.call(n,o,r,i)),r++}}),function(e,t){var n=t(e.SHA1,e.Base64,e.MD5,e.stropheUtils);window.Strophe=n.Strophe,window.$build=n.$build,window.$iq=n.$iq,window.$msg=n.$msg,window.$pres=n.$pres,window.SHA1=n.SHA1,window.Base64=n.Base64,window.MD5=n.MD5,window.b64_hmac_sha1=n.SHA1.b64_hmac_sha1,window.b64_sha1=n.SHA1.b64_sha1,window.str_hmac_sha1=n.SHA1.str_hmac_sha1,window.str_sha1=n.SHA1.str_sha1}(this,function(e,t,n,r){var i;function s(e,t){return new i.Builder(e,t)}function o(e){return new i.Builder("iq",e)}function a(e){return new i.Builder("presence",e)}return(i={VERSION:"1.2.12",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(e){for(var t=0;t<i.XHTML.tags.length;t++)if(e==i.XHTML.tags[t])return!0;return!1},validAttribute:function(e,t){if(void 0!==i.XHTML.attributes[e]&&i.XHTML.attributes[e].length>0)for(var n=0;n<i.XHTML.attributes[e].length;n++)if(t==i.XHTML.attributes[e][n])return!0;return!1},validCSS:function(e){for(var t=0;t<i.XHTML.css.length;t++)if(e==i.XHTML.css[t])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(e,t){i.NS[e]=t},forEachChild:function(e,t,n){var r,s;for(r=0;r<e.childNodes.length;r++)(s=e.childNodes[r]).nodeType!=i.ElementType.NORMAL||t&&!this.isTagEqual(s,t)||n(s)},isTagEqual:function(e,t){return e.tagName==t},_xmlGenerator:null,_makeGenerator:function(){var e;return void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&document.documentMode<10?(e=this._getIEXmlDom()).appendChild(e.createElement("strophe")):e=document.implementation.createDocument("jabber:client","strophe",null),e},xmlGenerator:function(){return i._xmlGenerator||(i._xmlGenerator=i._makeGenerator()),i._xmlGenerator},_getIEXmlDom:function(){for(var e=null,t=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],n=0;n<t.length&&null===e;n++)try{e=new ActiveXObject(t[n])}catch(t){e=null}return e},xmlElement:function(e){if(!e)return null;var t,n,r,s=i.xmlGenerator().createElement(e);for(t=1;t<arguments.length;t++){var o=arguments[t];if(o)if("string"==typeof o||"number"==typeof o)s.appendChild(i.xmlTextNode(o));else if("object"==typeof o&&"function"==typeof o.sort)for(n=0;n<o.length;n++){var a=o[n];"object"==typeof a&&"function"==typeof a.sort&&void 0!==a[1]&&null!==a[1]&&s.setAttribute(a[0],a[1])}else if("object"==typeof o)for(r in o)o.hasOwnProperty(r)&&void 0!==o[r]&&null!==o[r]&&s.setAttribute(r,o[r])}return s},xmlescape:function(e){return e=(e=(e=(e=(e=e.replace(/\&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/'/g,"&apos;")).replace(/"/g,"&quot;")},xmlunescape:function(e){return e=(e=(e=(e=(e=e.replace(/\&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&apos;/g,"'")).replace(/&quot;/g,'"')},xmlTextNode:function(e){return i.xmlGenerator().createTextNode(e)},xmlHtmlNode:function(e){var t;window.DOMParser?t=(new DOMParser).parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e));return t},getText:function(e){if(!e)return null;var t="";0===e.childNodes.length&&e.nodeType==i.ElementType.TEXT&&(t+=e.nodeValue);for(var n=0;n<e.childNodes.length;n++)e.childNodes[n].nodeType==i.ElementType.TEXT&&(t+=e.childNodes[n].nodeValue);return i.xmlescape(t)},copyElement:function(e){var t,n;if(e.nodeType==i.ElementType.NORMAL){for(n=i.xmlElement(e.tagName),t=0;t<e.attributes.length;t++)n.setAttribute(e.attributes[t].nodeName,e.attributes[t].value);for(t=0;t<e.childNodes.length;t++)n.appendChild(i.copyElement(e.childNodes[t]))}else e.nodeType==i.ElementType.TEXT&&(n=i.xmlGenerator().createTextNode(e.nodeValue));return n},createHtml:function(e){var t,n,r,s,o,a,c,d,l,u,h;if(e.nodeType==i.ElementType.NORMAL)if(s=e.nodeName.toLowerCase(),i.XHTML.validTag(s))try{for(n=i.xmlElement(s),t=0;t<i.XHTML.attributes[s].length;t++)if(o=i.XHTML.attributes[s][t],null!=(a=e.getAttribute(o))&&""!==a&&!1!==a&&0!==a)if("style"==o&&"object"==typeof a&&void 0!==a.cssText&&(a=a.cssText),"style"==o){for(c=[],d=a.split(";"),r=0;r<d.length;r++)u=(l=d[r].split(":"))[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),i.XHTML.validCSS(u)&&(h=l[1].replace(/^\s*/,"").replace(/\s*$/,""),c.push(u+": "+h));c.length>0&&(a=c.join("; "),n.setAttribute(o,a))}else n.setAttribute(o,a);for(t=0;t<e.childNodes.length;t++)n.appendChild(i.createHtml(e.childNodes[t]))}catch(e){n=i.xmlTextNode("")}else for(n=i.xmlGenerator().createDocumentFragment(),t=0;t<e.childNodes.length;t++)n.appendChild(i.createHtml(e.childNodes[t]));else if(e.nodeType==i.ElementType.FRAGMENT)for(n=i.xmlGenerator().createDocumentFragment(),t=0;t<e.childNodes.length;t++)n.appendChild(i.createHtml(e.childNodes[t]));else e.nodeType==i.ElementType.TEXT&&(n=i.xmlTextNode(e.nodeValue));return n},escapeNode:function(e){return"string"!=typeof e?e:e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(e){return"string"!=typeof e?e:e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(e){return e.indexOf("@")<0?null:e.split("@")[0]},getDomainFromJid:function(e){var t=i.getBareJidFromJid(e);if(t.indexOf("@")<0)return t;var n=t.split("@");return n.splice(0,1),n.join("@")},getResourceFromJid:function(e){var t=e.split("/");return t.length<2?null:(t.splice(0,1),t.join("/"))},getBareJidFromJid:function(e){return e?e.split("/")[0]:null},_handleError:function(e){void 0!==e.stack&&i.fatal(e.stack),e.sourceURL?i.fatal("error: "+this.handler+" "+e.sourceURL+":"+e.line+" - "+e.name+": "+e.message):e.fileName?i.fatal("error: "+this.handler+" "+e.fileName+":"+e.lineNumber+" - "+e.name+": "+e.message):i.fatal("error: "+e.message)},log:function(e,t){},debug:function(e){this.log(this.LogLevel.DEBUG,e)},info:function(e){this.log(this.LogLevel.INFO,e)},warn:function(e){this.log(this.LogLevel.WARN,e)},error:function(e){this.log(this.LogLevel.ERROR,e)},fatal:function(e){this.log(this.LogLevel.FATAL,e)},serialize:function(e){var t;if(!e)return null;"function"==typeof e.tree&&(e=e.tree());var n,r,s=e.nodeName;for(e.getAttribute("_realname")&&(s=e.getAttribute("_realname")),t="<"+s,n=0;n<e.attributes.length;n++)"_realname"!=e.attributes[n].nodeName&&(t+=" "+e.attributes[n].nodeName+"='"+i.xmlescape(e.attributes[n].value)+"'");if(e.childNodes.length>0){for(t+=">",n=0;n<e.childNodes.length;n++)switch((r=e.childNodes[n]).nodeType){case i.ElementType.NORMAL:t+=i.serialize(r);break;case i.ElementType.TEXT:t+=i.xmlescape(r.nodeValue);break;case i.ElementType.CDATA:t+="<![CDATA["+r.nodeValue+"]]>"}t+="</"+s+">"}else t+="/>";return t},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(e,t){i._connectionPlugins[e]=t}}).Builder=function(e,t){"presence"!=e&&"message"!=e&&"iq"!=e||(t&&!t.xmlns?t.xmlns=i.NS.CLIENT:t||(t={xmlns:i.NS.CLIENT})),this.nodeTree=i.xmlElement(e,t),this.node=this.nodeTree},i.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return i.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},root:function(){return this.node=this.nodeTree,this},attrs:function(e){for(var t in e)e.hasOwnProperty(t)&&(void 0===e[t]?this.node.removeAttribute(t):this.node.setAttribute(t,e[t]));return this},c:function(e,t,n){var r=i.xmlElement(e,t,n);return this.node.appendChild(r),"string"!=typeof n&&"number"!=typeof n&&(this.node=r),this},cnode:function(e){var t,n=i.xmlGenerator();try{t=void 0!==n.importNode}catch(e){t=!1}var r=t?n.importNode(e,!0):i.copyElement(e);return this.node.appendChild(r),this.node=r,this},t:function(e){var t=i.xmlTextNode(e);return this.node.appendChild(t),this},h:function(e){var t=document.createElement("body");t.innerHTML=e;for(var n=i.createHtml(t);n.childNodes.length>0;)this.node.appendChild(n.childNodes[0]);return this}},i.Handler=function(e,t,n,r,s,o,a){this.handler=e,this.ns=t,this.name=n,this.type=r,this.id=s,this.options=a||{matchBareFromJid:!1,ignoreNamespaceFragment:!1},this.options.matchBare&&(i.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare),this.options.matchBareFromJid?this.from=o?i.getBareJidFromJid(o):null:this.from=o,this.user=!0},i.Handler.prototype={getNamespace:function(e){var t=e.getAttribute("xmlns");return t&&this.options.ignoreNamespaceFragment&&(t=t.split("#")[0]),t},namespaceMatch:function(e){var t=!1;if(!this.ns)return!0;var n=this;return i.forEachChild(e,null,function(e){n.getNamespace(e)===n.ns&&(t=!0)}),t=t||this.getNamespace(e)===this.ns},isMatch:function(e){var t=e.getAttribute("from");this.options.matchBareFromJid&&(t=i.getBareJidFromJid(t));var n=e.getAttribute("type");return!(!this.namespaceMatch(e)||this.name&&!i.isTagEqual(e,this.name)||this.type&&(Array.isArray(this.type)?-1==this.type.indexOf(n):n!=this.type)||this.id&&e.getAttribute("id")!=this.id||this.from&&t!=this.from)},run:function(e){var t=null;try{t=this.handler(e)}catch(e){throw i._handleError(e),e}return t},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},i.TimedHandler=function(e,t){this.period=e,this.handler=t,this.lastCalled=(new Date).getTime(),this.user=!0},i.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},i.Connection=function(e,t){this.service=e,this.options=t||{};var n=this.options.protocol||"";for(var s in 0===e.indexOf("ws:")||0===e.indexOf("wss:")||0===n.indexOf("ws")?this._proto=new i.Websocket(this):this._proto=new i.Bosh(this),this.jid="",this.domain=null,this.features=null,this._sasl_data={},this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.protocolErrorHandlers={HTTP:{},websocket:{}},this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.do_authentication=!0,this.paused=!1,this.restored=!1,this._data=[],this._uniqueId=0,this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this.maxRetries=5,this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100),r.addCookies(this.options.cookies),this.registerSASLMechanisms(this.options.mechanisms),i._connectionPlugins)if(i._connectionPlugins.hasOwnProperty(s)){var o=i._connectionPlugins[s],a=function(){};a.prototype=o,this[s]=new a,this[s].init(this)}},i.Connection.prototype={reset:function(){this._proto._reset(),this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.restored=!1,this._data=[],this._requests=[],this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)});return"string"==typeof e||"number"==typeof e?t+":"+e:t+""},addProtocolErrorHandler:function(e,t,n){this.protocolErrorHandlers[e][t]=n},connect:function(e,t,n,r,s,o,a){this.jid=e,this.authzid=i.getBareJidFromJid(this.jid),this.authcid=a||i.getNodeFromJid(this.jid),this.pass=t,this.servtype="xmpp",this.connect_callback=n,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.restored=!1,this.domain=i.getDomainFromJid(this.jid),this._changeConnectStatus(i.Status.CONNECTING,null),this._proto._connect(r,s,o)},attach:function(e,t,n,r,s,o,a){if(!(this._proto instanceof i.Bosh))throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};this._proto._attach(e,t,n,r,s,o,a)},restore:function(e,t,n,r,i){if(!this._sessionCachingSupported())throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};this._proto._restore(e,t,n,r,i)},_sessionCachingSupported:function(){if(this._proto instanceof i.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_","_strophe_"),window.sessionStorage.removeItem("_strophe_")}catch(e){return!1}return!0}return!1},xmlInput:function(e){},xmlOutput:function(e){},rawInput:function(e){},rawOutput:function(e){},nextValidRid:function(e){},send:function(e){if(null!==e){if("function"==typeof e.sort)for(var t=0;t<e.length;t++)this._queueData(e[t]);else"function"==typeof e.tree?this._queueData(e.tree()):this._queueData(e);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendPresence:function(e,t,n,r){var i=null,s=this;"function"==typeof e.tree&&(e=e.tree());var o=e.getAttribute("id");if(o||(o=this.getUniqueId("sendPresence"),e.setAttribute("id",o)),"function"==typeof t||"function"==typeof n){var a=this.addHandler(function(e){i&&s.deleteTimedHandler(i),"error"==e.getAttribute("type")?n&&n(e):t&&t(e)},null,"presence",null,o);r&&(i=this.addTimedHandler(r,function(){return s.deleteHandler(a),n&&n(null),!1}))}return this.send(e),o},sendIQ:function(e,t,n,r){var i=null,s=this;"function"==typeof e.tree&&(e=e.tree());var o=e.getAttribute("id");if(o||(o=this.getUniqueId("sendIQ"),e.setAttribute("id",o)),"function"==typeof t||"function"==typeof n){var a=this.addHandler(function(e){i&&s.deleteTimedHandler(i);var r=e.getAttribute("type");if("result"==r)t&&t(e);else{if("error"!=r)throw{name:"StropheError",message:"Got bad IQ type of "+r};n&&n(e)}},null,"iq",["error","result"],o);r&&(i=this.addTimedHandler(r,function(){return s.deleteHandler(a),n&&n(null),!1}))}return this.send(e),o},_queueData:function(e){if(null===e||!e.tagName||!e.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(e)},_sendRestart:function(){this._data.push("restart"),this._proto._sendRestart(),this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(e,t){var n=new i.TimedHandler(e,t);return this.addTimeds.push(n),n},deleteTimedHandler:function(e){this.removeTimeds.push(e)},addHandler:function(e,t,n,r,s,o,a){var c=new i.Handler(e,t,n,r,s,o,a);return this.addHandlers.push(c),c},deleteHandler:function(e){this.removeHandlers.push(e);var t=this.addHandlers.indexOf(e);t>=0&&this.addHandlers.splice(t,1)},registerSASLMechanisms:function(e){this.mechanisms={},(e=e||[i.SASLAnonymous,i.SASLExternal,i.SASLMD5,i.SASLOAuthBearer,i.SASLPlain,i.SASLSHA1]).forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(e){this.mechanisms[e.prototype.name]=e},disconnect:function(e){if(this._changeConnectStatus(i.Status.DISCONNECTING,e),i.info("Disconnect was called because: "+e),this.connected){var t=!1;this.disconnecting=!0,this.authenticated&&(t=a({xmlns:i.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(t)}else i.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect()},_changeConnectStatus:function(e,t){for(var n in i._connectionPlugins)if(i._connectionPlugins.hasOwnProperty(n)){var r=this[n];if(r.statusChanged)try{r.statusChanged(e,t)}catch(e){i.error(n+" plugin caused an exception changing status: "+e)}}if(this.connect_callback)try{this.connect_callback(e,t)}catch(e){i._handleError(e),i.error("User connection callback caused an exception: "+e)}},_doDisconnect:function(e){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout),null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null),i.info("_doDisconnect was called"),this._proto._doDisconnect(),this.authenticated=!1,this.disconnecting=!1,this.restored=!1,this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._changeConnectStatus(i.Status.DISCONNECTED,e),this.connected=!1},_dataRecv:function(e,t){i.info("_dataRecv called");var n=this._proto._reqToData(e);if(null!==n){var r,s;for(this.xmlInput!==i.Connection.prototype.xmlInput&&(n.nodeName===this._proto.strip&&n.childNodes.length?this.xmlInput(n.childNodes[0]):this.xmlInput(n)),this.rawInput!==i.Connection.prototype.rawInput&&(t?this.rawInput(t):this.rawInput(i.serialize(n)));this.removeHandlers.length>0;)s=this.removeHandlers.pop(),(r=this.handlers.indexOf(s))>=0&&this.handlers.splice(r,1);for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else{var o,a,c=n.getAttribute("type");if(null!==c&&"terminate"==c){if(this.disconnecting)return;return o=n.getAttribute("condition"),a=n.getElementsByTagName("conflict"),null!==o?("remote-stream-error"==o&&a.length>0&&(o="conflict"),this._changeConnectStatus(i.Status.CONNFAIL,o)):this._changeConnectStatus(i.Status.CONNFAIL,"unknown"),void this._doDisconnect(o)}var d=this;i.forEachChild(n,null,function(e){var t,n;for(n=d.handlers,d.handlers=[],t=0;t<n.length;t++){var r=n[t];try{!r.isMatch(e)||!d.authenticated&&r.user?d.handlers.push(r):r.run(e)&&d.handlers.push(r)}catch(e){i.warn("Removing Strophe handlers due to uncaught exception: "+e.message)}}})}}},mechanisms:{},_connect_cb:function(e,t,n){var r;i.info("_connect_cb was called"),this.connected=!0;try{r=this._proto._reqToData(e)}catch(e){if("badformat"!=e)throw e;this._changeConnectStatus(i.Status.CONNFAIL,"bad-format"),this._doDisconnect("bad-format")}if(r&&(this.xmlInput!==i.Connection.prototype.xmlInput&&(r.nodeName===this._proto.strip&&r.childNodes.length?this.xmlInput(r.childNodes[0]):this.xmlInput(r)),this.rawInput!==i.Connection.prototype.rawInput&&(n?this.rawInput(n):this.rawInput(i.serialize(r))),this._proto._connect_cb(r)!==i.Status.CONNFAIL))if(r.getElementsByTagNameNS?r.getElementsByTagNameNS(i.NS.STREAM,"features").length>0:r.getElementsByTagName("stream:features").length>0||r.getElementsByTagName("features").length>0){var s,o,a=[],c=r.getElementsByTagName("mechanism");if(c.length>0)for(s=0;s<c.length;s++)o=i.getText(c[s]),this.mechanisms[o]&&a.push(this.mechanisms[o]);0!==a.length||0!==r.getElementsByTagName("auth").length?!1!==this.do_authentication&&this.authenticate(a):this._proto._no_auth_received(t)}else this._proto._no_auth_received(t)},sortMechanismsByPriority:function(e){var t,n,r,i;for(t=0;t<e.length-1;++t){for(r=t,n=t+1;n<e.length;++n)e[n].prototype.priority>e[r].prototype.priority&&(r=n);r!=t&&(i=e[t],e[t]=e[r],e[r]=i)}return e},_attemptSASLAuth:function(e){e=this.sortMechanismsByPriority(e||[]);var n=0,r=!1;for(n=0;n<e.length;++n)if(e[n].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null),this._sasl_mechanism=new e[n],this._sasl_mechanism.onStart(this);var o=s("auth",{xmlns:i.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var a=this._sasl_mechanism.onChallenge(this,null);o.t(t.encode(a))}this.send(o.tree()),r=!0;break}return r},_attemptLegacyAuth:function(){null===i.getNodeFromJid(this.jid)?(this._changeConnectStatus(i.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(i.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(o({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:i.NS.AUTH}).c("username",{}).t(i.getNodeFromJid(this.jid)).tree()))},authenticate:function(e){this._attemptSASLAuth(e)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(e){var n=t.decode(i.getText(e)),r=this._sasl_mechanism.onChallenge(this,n),o=s("response",{xmlns:i.NS.SASL});return""!==r&&o.t(t.encode(r)),this.send(o.tree()),!0},_auth1_cb:function(e){var t=o({type:"set",id:"_auth_2"}).c("query",{xmlns:i.NS.AUTH}).c("username",{}).t(i.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return i.getResourceFromJid(this.jid)||(this.jid=i.getBareJidFromJid(this.jid)+"/strophe"),t.up().c("resource",{}).t(i.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(t.tree()),!1},_sasl_success_cb:function(e){if(this._sasl_data["server-signature"]){var n,r=t.decode(i.getText(e)).match(/([a-z]+)=([^,]+)(,|$)/);if("v"==r[1]&&(n=r[2]),n!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}i.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var s=[],o=function(e,t){for(;e.length;)this.deleteHandler(e.pop());return this._sasl_auth1_cb.bind(this)(t),!1};return s.push(this._addSysHandler(function(e){o.bind(this)(s,e)}.bind(this),null,"stream:features",null,null)),s.push(this._addSysHandler(function(e){o.bind(this)(s,e)}.bind(this),i.NS.STREAM,"features",null,null)),this._sendRestart(),!1},_sasl_auth1_cb:function(e){var t,n;for(this.features=e,t=0;t<e.childNodes.length;t++)"bind"==(n=e.childNodes[t]).nodeName&&(this.do_bind=!0),"session"==n.nodeName&&(this.do_session=!0);if(!this.do_bind)return this._changeConnectStatus(i.Status.AUTHFAIL,null),!1;this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var r=i.getResourceFromJid(this.jid);return r?this.send(o({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:i.NS.BIND}).c("resource",{}).t(r).tree()):this.send(o({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:i.NS.BIND}).tree()),!1},_sasl_bind_cb:function(e){var t;if("error"==e.getAttribute("type"))return i.info("SASL binding failed."),e.getElementsByTagName("conflict").length>0&&(t="conflict"),this._changeConnectStatus(i.Status.AUTHFAIL,t),!1;var n,r=e.getElementsByTagName("bind");if(!(r.length>0))return i.info("SASL binding failed."),this._changeConnectStatus(i.Status.AUTHFAIL,null),!1;(n=r[0].getElementsByTagName("jid")).length>0&&(this.jid=i.getText(n[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(o({type:"set",id:"_session_auth_2"}).c("session",{xmlns:i.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(i.Status.CONNECTED,null)))},_sasl_session_cb:function(e){if("result"==e.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(i.Status.CONNECTED,null);else if("error"==e.getAttribute("type"))return i.info("Session creation failed."),this._changeConnectStatus(i.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(e){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(i.Status.AUTHFAIL,null),!1},_auth2_cb:function(e){return"result"==e.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(i.Status.CONNECTED,null)):"error"==e.getAttribute("type")&&(this._changeConnectStatus(i.Status.AUTHFAIL,null),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(e,t){var n=new i.TimedHandler(e,t);return n.user=!1,this.addTimeds.push(n),n},_addSysHandler:function(e,t,n,r,s){var o=new i.Handler(e,t,n,r,s);return o.user=!1,this.addHandlers.push(o),o},_onDisconnectTimeout:function(){return i.info("_onDisconnectTimeout was called"),this._changeConnectStatus(i.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var e,t,n;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;)t=this.removeTimeds.pop(),(e=this.timedHandlers.indexOf(t))>=0&&this.timedHandlers.splice(e,1);var r=(new Date).getTime();for(n=[],e=0;e<this.timedHandlers.length;e++)t=this.timedHandlers[e],!this.authenticated&&t.user||(t.lastCalled+t.period-r<=0?t.run()&&n.push(t):n.push(t));this.timedHandlers=n,clearTimeout(this._idleTimeout),this._proto._onIdle(),this.connected&&(this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100))}},i.SASLMechanism=function(e,t,n){this.name=e,this.isClientFirst=t,this.priority=n},i.SASLMechanism.prototype={test:function(e){return!0},onStart:function(e){this._connection=e},onChallenge:function(e,t){throw new Error("You should implement challenge handling!")},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}},i.SASLAnonymous=function(){},i.SASLAnonymous.prototype=new i.SASLMechanism("ANONYMOUS",!1,20),i.SASLAnonymous.prototype.test=function(e){return null===e.authcid},i.SASLPlain=function(){},i.SASLPlain.prototype=new i.SASLMechanism("PLAIN",!0,30),i.SASLPlain.prototype.test=function(e){return null!==e.authcid},i.SASLPlain.prototype.onChallenge=function(e){var t=e.authzid;return t+="\0",t+=e.authcid,t+="\0",t+=e.pass,r.utf16to8(t)},i.SASLSHA1=function(){},i.SASLSHA1.prototype=new i.SASLMechanism("SCRAM-SHA-1",!0,50),i.SASLSHA1.prototype.test=function(e){return null!==e.authcid},i.SASLSHA1.prototype.onChallenge=function(i,s,o){var a=o||n.hexdigest(1234567890*Math.random()),c="n="+r.utf16to8(i.authcid);return c+=",r=",c+=a,i._sasl_data.cnonce=a,i._sasl_data["client-first-message-bare"]=c,c="n,,"+c,this.onChallenge=function(n,i){for(var s,o,a,c,d,l,u,h,p,f,m,g,v="c=biws,",S=n._sasl_data["client-first-message-bare"]+","+i+",",y=n._sasl_data.cnonce,b=/([a-z]+)=([^,]+)(,|$)/;i.match(b);){var C=i.match(b);switch(i=i.replace(C[0],""),C[1]){case"r":s=C[2];break;case"s":o=C[2];break;case"i":a=C[2]}}if(s.substr(0,y.length)!==y)return n._sasl_data={},n._sasl_failure_cb();for(S+=v+="r="+s,o=t.decode(o),o+="\0\0\0",p=r.utf16to8(n.pass),c=l=e.core_hmac_sha1(p,o),u=1;u<a;u++){for(d=e.core_hmac_sha1(p,e.binb2str(l)),h=0;h<5;h++)c[h]^=d[h];l=d}for(c=e.binb2str(c),f=e.core_hmac_sha1(c,"Client Key"),m=e.str_hmac_sha1(c,"Server Key"),g=e.core_hmac_sha1(e.str_sha1(e.binb2str(f)),S),n._sasl_data["server-signature"]=e.b64_hmac_sha1(m,S),h=0;h<5;h++)f[h]^=g[h];return v+=",p="+t.encode(e.binb2str(f))}.bind(this),c},i.SASLMD5=function(){},i.SASLMD5.prototype=new i.SASLMechanism("DIGEST-MD5",!1,40),i.SASLMD5.prototype.test=function(e){return null!==e.authcid},i.SASLMD5.prototype._quote=function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},i.SASLMD5.prototype.onChallenge=function(e,t,i){for(var s,o=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,a=i||n.hexdigest(""+1234567890*Math.random()),c="",d=null,l="";t.match(o);)switch(s=t.match(o),t=t.replace(s[0],""),s[2]=s[2].replace(/^"(.+)"$/,"$1"),s[1]){case"realm":c=s[2];break;case"nonce":l=s[2];break;case"qop":s[2];break;case"host":d=s[2]}var u=e.servtype+"/"+e.domain;null!==d&&(u=u+"/"+d);var h=r.utf16to8(e.authcid+":"+c+":"+this._connection.pass),p=n.hash(h)+":"+l+":"+a,f="AUTHENTICATE:"+u,m="";return m+="charset=utf-8,",m+="username="+this._quote(r.utf16to8(e.authcid))+",",m+="realm="+this._quote(c)+",",m+="nonce="+this._quote(l)+",",m+="nc=00000001,",m+="cnonce="+this._quote(a)+",",m+="digest-uri="+this._quote(u)+",",m+="response="+n.hexdigest(n.hexdigest(p)+":"+l+":00000001:"+a+":auth:"+n.hexdigest(f))+",",m+="qop=auth",this.onChallenge=function(){return""},m},i.SASLOAuthBearer=function(){},i.SASLOAuthBearer.prototype=new i.SASLMechanism("OAUTHBEARER",!0,60),i.SASLOAuthBearer.prototype.test=function(e){return null!==e.authcid},i.SASLOAuthBearer.prototype.onChallenge=function(e){var t="n,a=";return t+=e.authzid,t+=",",t+="",t+="auth=Bearer ",t+=e.pass,t+="",t+="",r.utf16to8(t)},i.SASLExternal=function(){},i.SASLExternal.prototype=new i.SASLMechanism("EXTERNAL",!0,10),i.SASLExternal.prototype.onChallenge=function(e){return e.authcid===e.authzid?"":e.authzid},{Strophe:i,$build:s,$msg:function(e){return new i.Builder("message",e)},$iq:o,$pres:a,SHA1:e,Base64:t,MD5:n}}),function(e,t){t(Strophe,$build)}(0,function(e,t){return e.Request=function(t,n,r,i){this.id=++e._requestId,this.xmlData=t,this.data=e.serialize(t),this.origFunc=n,this.func=n,this.rid=r,this.date=NaN,this.sends=i||0,this.abort=!1,this.dead=null,this.age=function(){return this.date?(new Date-this.date)/1e3:0},this.timeDead=function(){return this.dead?(new Date-this.dead)/1e3:0},this.xhr=this._newXHR()},e.Request.prototype={getResponse:function(){var t=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if("parsererror"==(t=this.xhr.responseXML.documentElement).tagName)throw e.error("invalid response received"),e.error("responseText: "+this.xhr.responseText),e.error("responseXML: "+e.serialize(this.xhr.responseXML)),"parsererror"}else if(this.xhr.responseText)throw e.error("invalid response received"),e.error("responseText: "+this.xhr.responseText),"badformat";return t},_newXHR:function(){var e=null;return window.XMLHttpRequest?(e=new XMLHttpRequest).overrideMimeType&&e.overrideMimeType("text/xml; charset=utf-8"):window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),e.onreadystatechange=this.func.bind(null,this),e}},e.Bosh=function(e){this._conn=e,this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.hold=1,this.wait=60,this.window=5,this.errors=0,this.inactivity=null,this._requests=[]},e.Bosh.prototype={strip:null,_buildBody:function(){var n=t("body",{rid:this.rid++,xmlns:e.NS.HTTPBIND});return null!==this.sid&&n.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),n},_reset:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.errors=0,this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_connect:function(t,n,r){this.wait=t||this.wait,this.hold=n||this.hold,this.errors=0;var i=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":e.NS.BOSH});r&&i.attrs({route:r});var s=this._conn._connect_cb;this._requests.push(new e.Request(i.tree(),this._onRequestStateChange.bind(this,s.bind(this._conn)),i.tree().getAttribute("rid"))),this._throttledRequestHandler()},_attach:function(t,n,r,i,s,o,a){this._conn.jid=t,this.sid=n,this.rid=r,this._conn.connect_callback=i,this._conn.domain=e.getDomainFromJid(this._conn.jid),this._conn.authenticated=!0,this._conn.connected=!0,this.wait=s||this.wait,this.hold=o||this.hold,this.window=a||this.window,this._conn._changeConnectStatus(e.Status.ATTACHED,null)},_restore:function(t,n,r,i,s){var o=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(!(null!=o&&o.rid&&o.sid&&o.jid&&(null==t||e.getBareJidFromJid(o.jid)==e.getBareJidFromJid(t)||null===e.getNodeFromJid(t)&&e.getDomainFromJid(o.jid)==t)))throw{name:"StropheSessionError",message:"_restore: no restoreable session."};this._conn.restored=!0,this._attach(o.jid,o.sid,o.rid,n,r,i,s)},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(t){var n,r,i=t.getAttribute("type");if(null!==i&&"terminate"==i)return n=t.getAttribute("condition"),e.error("BOSH-Connection failed: "+n),r=t.getElementsByTagName("conflict"),null!==n?("remote-stream-error"==n&&r.length>0&&(n="conflict"),this._conn._changeConnectStatus(e.Status.CONNFAIL,n)):this._conn._changeConnectStatus(e.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(n),e.Status.CONNFAIL;this.sid||(this.sid=t.getAttribute("sid"));var s=t.getAttribute("requests");s&&(this.window=parseInt(s,10));var o=t.getAttribute("hold");o&&(this.hold=parseInt(o,10));var a=t.getAttribute("wait");a&&(this.wait=parseInt(a,10));var c=t.getAttribute("inactivity");c&&(this.inactivity=parseInt(c,10))},_disconnect:function(e){this._sendTerminate(e)},_doDisconnect:function(){this.sid=null,this.rid=Math.floor(4294967295*Math.random()),this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return 0===this._requests.length},_callProtocolErrorHandlers:function(e){var t,n=this._getRequestStatus(e);(t=this._conn.protocolErrorHandlers.HTTP[n])&&t.call(this,n)},_hitError:function(t){this.errors++,e.warn("request errored, status: "+t+", number of errors: "+this.errors),this.errors>4&&this._conn._onDisconnectTimeout()},_no_auth_received:function(t){t=t?t.bind(this._conn):this._conn._connect_cb.bind(this._conn);var n=this._buildBody();this._requests.push(new e.Request(n.tree(),this._onRequestStateChange.bind(this,t.bind(this._conn)),n.tree().getAttribute("rid"))),this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var e;this._requests.length>0;)(e=this._requests.pop()).abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){}},_onIdle:function(){var t=this._conn._data;if(this._conn.authenticated&&0===this._requests.length&&0===t.length&&!this._conn.disconnecting&&(e.info("no requests during idle cycle, sending blank request"),t.push(null)),!this._conn.paused){if(this._requests.length<2&&t.length>0){for(var n=this._buildBody(),r=0;r<t.length;r++)null!==t[r]&&("restart"===t[r]?n.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":e.NS.BOSH}):n.cnode(t[r]).up());delete this._conn._data,this._conn._data=[],this._requests.push(new e.Request(n.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),n.tree().getAttribute("rid"))),this._throttledRequestHandler()}if(this._requests.length>0){var i=this._requests[0].age();null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),i>Math.floor(e.TIMEOUT*this.wait)&&(e.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(e.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())}}},_getRequestStatus:function(t,n){var r;if(4==t.xhr.readyState)try{r=t.xhr.status}catch(t){e.error("Caught an error while retrieving a request's status, reqStatus: "+r)}return void 0===r&&(r="number"==typeof n?n:0),r},_onRequestStateChange:function(t,n){if(e.debug("request id "+n.id+"."+n.sends+" state changed to "+n.xhr.readyState),n.abort)n.abort=!1;else if(4===n.xhr.readyState){var r=this._getRequestStatus(n);if(this.disconnecting&&r>=400)return this._hitError(r),void this._callProtocolErrorHandlers(n);if((r>0&&r<500||n.sends>5)&&(this._removeRequest(n),e.debug("request id "+n.id+" should now be removed")),200==r){var i=this._requests[0]==n;(this._requests[1]==n||i&&this._requests.length>0&&this._requests[0].age()>Math.floor(e.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(n.rid)+1),e.debug("request id "+n.id+"."+n.sends+" got 200"),t(n),this.errors=0}else 0===r||r>=400&&r<600||r>=12e3?(e.error("request id "+n.id+"."+n.sends+" error "+r+" happened"),this._hitError(r),this._callProtocolErrorHandlers(n),r>=400&&r<500&&(this._conn._changeConnectStatus(e.Status.DISCONNECTING,null),this._conn._doDisconnect())):e.error("request id "+n.id+"."+n.sends+" error "+r+" happened");r>0&&r<500&&!(n.sends>5)||this._throttledRequestHandler()}},_processRequest:function(t){var n=this,r=this._requests[t],i=this._getRequestStatus(r,-1);if(r.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var s=r.age(),o=!isNaN(s)&&s>Math.floor(e.TIMEOUT*this.wait),a=null!==r.dead&&r.timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait),c=4==r.xhr.readyState&&(i<1||i>=500);if((o||a||c)&&(a&&e.error("Request "+this._requests[t].id+" timed out (secondary), restarting"),r.abort=!0,r.xhr.abort(),r.xhr.onreadystatechange=function(){},this._requests[t]=new e.Request(r.xmlData,r.origFunc,r.rid,r.sends),r=this._requests[t]),0===r.xhr.readyState){e.debug("request id "+r.id+"."+r.sends+" posting");try{var d=this._conn.options.contentType||"text/xml; charset=utf-8";r.xhr.open("POST",this._conn.service,!this._conn.options.sync),void 0!==r.xhr.setRequestHeader&&r.xhr.setRequestHeader("Content-Type",d),this._conn.options.withCredentials&&(r.xhr.withCredentials=!0)}catch(t){return e.error("XHR open failed."),this._conn.connected||this._conn._changeConnectStatus(e.Status.CONNFAIL,"bad-service"),void this._conn.disconnect()}var l=function(){if(r.date=new Date,n._conn.options.customHeaders){var e=n._conn.options.customHeaders;for(var t in e)e.hasOwnProperty(t)&&r.xhr.setRequestHeader(t,e[t])}r.xhr.send(r.data)};if(r.sends>1){var u=1e3*Math.min(Math.floor(e.TIMEOUT*this.wait),Math.pow(r.sends,3));setTimeout(function(){l()},u)}else l();r.sends++,this._conn.xmlOutput!==e.Connection.prototype.xmlOutput&&(r.xmlData.nodeName===this.strip&&r.xmlData.childNodes.length?this._conn.xmlOutput(r.xmlData.childNodes[0]):this._conn.xmlOutput(r.xmlData)),this._conn.rawOutput!==e.Connection.prototype.rawOutput&&this._conn.rawOutput(r.data)}else e.debug("_processRequest: "+(0===t?"first":"second")+" request has readyState of "+r.xhr.readyState)}},_removeRequest:function(t){var n;for(e.debug("removing request"),n=this._requests.length-1;n>=0;n--)t==this._requests[n]&&this._requests.splice(n,1);t.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(e){var t=this._requests[e];null===t.dead&&(t.dead=new Date),this._processRequest(e)},_reqToData:function(e){try{return e.getResponse()}catch(e){if("parsererror"!=e)throw e;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(t){e.info("_sendTerminate was called");var n=this._buildBody().attrs({type:"terminate"});t&&n.cnode(t.tree());var r=new e.Request(n.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),n.tree().getAttribute("rid"));this._requests.push(r),this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout),this._throttledRequestHandler(),this._conn._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler(),clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?e.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):e.debug("_throttledRequestHandler called with undefined requests"),this._requests&&0!==this._requests.length&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}},e}),function(e,t){t(Strophe,$build)}(0,function(e,t){return e.Websocket=function(e){this._conn=e,this.strip="wrapper";var t=e.service;if(0!==t.indexOf("ws:")&&0!==t.indexOf("wss:")){var n="";"ws"===e.options.protocol&&"https:"!==window.location.protocol?n+="ws":n+="wss",n+="://"+window.location.host,0!==t.indexOf("/")?n+=window.location.pathname+t:n+=t,e.service=n}},e.Websocket.prototype={_buildStream:function(){return t("open",{xmlns:e.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(t,n){var r;if(0===(r=t.getElementsByTagNameNS?t.getElementsByTagNameNS(e.NS.STREAM,"error"):t.getElementsByTagName("stream:error")).length)return!1;for(var i=r[0],s="",o="",a=0;a<i.childNodes.length;a++){var c=i.childNodes[a];if("urn:ietf:params:xml:ns:xmpp-streams"!==c.getAttribute("xmlns"))break;"text"===c.nodeName?o=c.textContent:s=c.nodeName}var d="WebSocket stream error: ";return d+=s||"unknown",o&&(d+=" - "+s),e.error(d),this._conn._changeConnectStatus(n,s),this._conn._doDisconnect(),!0},_reset:function(){},_connect:function(){this._closeSocket(),this.socket=new WebSocket(this._conn.service,"xmpp"),this.socket.onopen=this._onOpen.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(t){if(this._check_streamerror(t,e.Status.CONNFAIL))return e.Status.CONNFAIL},_handleStreamStart:function(t){var n=!1,r=t.getAttribute("xmlns");"string"!=typeof r?n="Missing xmlns in <open />":r!==e.NS.FRAMING&&(n="Wrong xmlns in <open />: "+r);var i=t.getAttribute("version");return"string"!=typeof i?n="Missing version in <open />":"1.0"!==i&&(n="Wrong version in <open />: "+i),!n||(this._conn._changeConnectStatus(e.Status.CONNFAIL,n),this._conn._doDisconnect(),!1)},_connect_cb_wrapper:function(t){if(0===t.data.indexOf("<open ")||0===t.data.indexOf("<?xml")){var n=t.data.replace(/^(<\?.*?\?>\s*)*/,"");if(""===n)return;var r=(new DOMParser).parseFromString(n,"text/xml").documentElement;this._conn.xmlInput(r),this._conn.rawInput(t.data),this._handleStreamStart(r)&&this._connect_cb(r)}else if(0===t.data.indexOf("<close ")){this._conn.rawInput(t.data),this._conn.xmlInput(t);var i=t.getAttribute("see-other-uri");i?(this._conn._changeConnectStatus(e.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=i,this._connect()):(this._conn._changeConnectStatus(e.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())}else{var s=this._streamWrap(t.data),o=(new DOMParser).parseFromString(s,"text/xml").documentElement;this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(o,null,t.data)}},_disconnect:function(n){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){n&&this._conn.send(n);var r=t("close",{xmlns:e.NS.FRAMING});this._conn.xmlOutput(r);var i=e.serialize(r);this._conn.rawOutput(i);try{this.socket.send(i)}catch(t){e.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){e.info("WebSockets _doDisconnect was called"),this._closeSocket()},_streamWrap:function(e){return"<wrapper>"+e+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(e){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(){this._conn.connected&&!this._conn.disconnecting?(e.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):e.info("Websocket closed")},_no_auth_received:function(t){e.error("Server did not send any auth methods"),this._conn._changeConnectStatus(e.Status.CONNFAIL,"Server did not send any auth methods"),t&&(t=t.bind(this._conn))(),this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(t){e.error("Websocket error "+t),this._conn._changeConnectStatus(e.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._disconnect()},_onIdle:function(){var t=this._conn._data;if(t.length>0&&!this._conn.paused){for(var n=0;n<t.length;n++){var r,i;if(null!==t[n])r="restart"===t[n]?this._buildStream().tree():t[n],i=e.serialize(r),this._conn.xmlOutput(r),this._conn.rawOutput(i),this.socket.send(i)}this._conn._data=[]}},_onMessage:function(t){var n,r,i='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(t.data===i)return this._conn.rawInput(i),this._conn.xmlInput(t),void(this._conn.disconnecting||this._conn._doDisconnect());if(0===t.data.search("<open ")){if(n=(new DOMParser).parseFromString(t.data,"text/xml").documentElement,!this._handleStreamStart(n))return}else r=this._streamWrap(t.data),n=(new DOMParser).parseFromString(r,"text/xml").documentElement;return this._check_streamerror(n,e.Status.ERROR)?void 0:this._conn.disconnecting&&"presence"===n.firstChild.nodeName&&"unavailable"===n.firstChild.getAttribute("type")?(this._conn.xmlInput(n),void this._conn.rawInput(e.serialize(n))):void this._conn._dataRecv(n,t.data)},_onOpen:function(){e.info("Websocket open");var t=this._buildStream();this._conn.xmlOutput(t.tree());var n=e.serialize(t);this._conn.rawOutput(n),this.socket.send(n)},_reqToData:function(e){return e},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout),this._conn._onIdle.bind(this._conn)()}},e}),e)e(Strophe,$build,$msg,$iq,$pres)}(function(e,t,n,r,i){window.Strophe=e,window.$build=t,window.$msg=n,window.$iq=r,window.$pres=i})},{}],14:[function(e,t,n){(function(n){"use strict";var r=e("./adapter_factory.js");t.exports=r({window:n.window})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter_factory.js":15}],15:[function(e,t,n){"use strict";var r=e("./utils");t.exports=function(t,n){var i=t&&t.window,s={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var o in n)hasOwnProperty.call(n,o)&&(s[o]=n[o]);var a=r.log,c=r.detectBrowser(i),d={browserDetails:c,extractVersion:r.extractVersion,disableLog:r.disableLog,disableWarnings:r.disableWarnings},l=e("./chrome/chrome_shim")||null,u=e("./edge/edge_shim")||null,h=e("./firefox/firefox_shim")||null,p=e("./safari/safari_shim")||null,f=e("./common_shim")||null;switch(c.browser){case"chrome":if(!l||!l.shimPeerConnection||!s.shimChrome)return a("Chrome shim is not included in this adapter release."),d;a("adapter.js shimming chrome."),d.browserShim=l,f.shimCreateObjectURL(i),l.shimGetUserMedia(i),l.shimMediaStream(i),l.shimSourceObject(i),l.shimPeerConnection(i),l.shimOnTrack(i),l.shimAddTrackRemoveTrack(i),l.shimGetSendersWithDtmf(i),f.shimRTCIceCandidate(i);break;case"firefox":if(!h||!h.shimPeerConnection||!s.shimFirefox)return a("Firefox shim is not included in this adapter release."),d;a("adapter.js shimming firefox."),d.browserShim=h,f.shimCreateObjectURL(i),h.shimGetUserMedia(i),h.shimSourceObject(i),h.shimPeerConnection(i),h.shimOnTrack(i),f.shimRTCIceCandidate(i);break;case"edge":if(!u||!u.shimPeerConnection||!s.shimEdge)return a("MS edge shim is not included in this adapter release."),d;a("adapter.js shimming edge."),d.browserShim=u,f.shimCreateObjectURL(i),u.shimGetUserMedia(i),u.shimPeerConnection(i),u.shimReplaceTrack(i);break;case"safari":if(!p||!s.shimSafari)return a("Safari shim is not included in this adapter release."),d;a("adapter.js shimming safari."),d.browserShim=p,f.shimCreateObjectURL(i),p.shimRTCIceServerUrls(i),p.shimCallbacksAPI(i),p.shimLocalStreamsAPI(i),p.shimRemoteStreamsAPI(i),p.shimTrackEventTransceiver(i),p.shimGetUserMedia(i),p.shimCreateOfferLegacy(i),f.shimRTCIceCandidate(i);break;default:a("Unsupported browser!")}return d}},{"./chrome/chrome_shim":16,"./common_shim":18,"./edge/edge_shim":19,"./firefox/firefox_shim":21,"./safari/safari_shim":23,"./utils":24}],16:[function(e,t,n){"use strict";var r=e("../utils.js"),i=r.log,s={shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var n=this;return n._ontrackpoly||(n._ontrackpoly=function(t){t.stream.addEventListener("addtrack",function(r){var i;i=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===r.track.id}):{track:r.track};var s=new Event("track");s.track=r.track,s.receiver=i,s.transceiver={receiver:i},s.streams=[t.stream],n.dispatchEvent(s)}),t.stream.getTracks().forEach(function(r){var i;i=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===r.id}):{track:r};var s=new Event("track");s.track=r,s.receiver=i,s.transceiver={receiver:i},s.streams=[t.stream],n.dispatchEvent(s)})},n.addEventListener("addstream",n._ontrackpoly)),t.apply(n,arguments)}}},shimGetSendersWithDtmf:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){var i=n.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};var r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var n=this;n._senders=n._senders||[],i.apply(n,[e]),e.getTracks().forEach(function(e){n._senders.push(t(n,e))})};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._senders=t._senders||[],s.apply(t,[e]),e.getTracks().forEach(function(e){var n=t._senders.find(function(t){return t.track===e});n&&t._senders.splice(t._senders.indexOf(n),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var o=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=o.apply(e,[]);return t.forEach(function(t){t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSourceObject:function(e){var t=e&&e.URL;"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var n=this;this._srcObject=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e)}),e.addEventListener("removetrack",function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e)})):this.src=""}}))},shimAddTrackRemoveTrack:function(e){var t=r.detectBrowser(e);if(!(e.RTCPeerConnection.prototype.addTrack&&t.version>=63)){var n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=n.apply(this);return e._reverseStreams=e._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var n=this;if(n._streams=n._streams||{},n._reverseStreams=n._reverseStreams||{},t.getTracks().forEach(function(e){if(n.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")}),!n._reverseStreams[t.id]){var r=new e.MediaStream(t.getTracks());n._streams[t.id]=r,n._reverseStreams[r.id]=t,t=r}i.apply(n,[t])};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._streams=t._streams||{},t._reverseStreams=t._reverseStreams||{},s.apply(t,[t._streams[e.id]||e]),delete t._reverseStreams[t._streams[e.id]?t._streams[e.id].id:e.id],delete t._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){var r=this;if("closed"===r.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(r.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError");r._streams=r._streams||{},r._reverseStreams=r._reverseStreams||{};var s=r._streams[n.id];if(s)s.addTrack(t),Promise.resolve().then(function(){r.dispatchEvent(new Event("negotiationneeded"))});else{var o=new e.MediaStream([t]);r._streams[n.id]=o,r._reverseStreams[o.id]=n,r.addStream(o)}return r.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this,t=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(e,[function(n){var r=c(e,n);t[0].apply(null,[r])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):n.apply(e,arguments).then(function(t){return c(e,t)})}});var o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(r.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:n})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};var a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=a.get.apply(this);return""===e.type?e:c(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t,n=this;if("closed"===n.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===n))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");n._streams=n._streams||{},Object.keys(n._streams).forEach(function(r){n._streams[r].getTracks().find(function(t){return e.track===t})&&(t=n._streams[r])}),t&&(1===t.getTracks().length?n.removeStream(n._reverseStreams[t.id]):t.removeTrack(e.track),n.dispatchEvent(new Event("negotiationneeded")))}}function c(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(i.id,"g"),r.id)}),new RTCSessionDescription({type:t.type,sdp:n})}},shimPeerConnection:function(e){var t=r.detectBrowser(e);if(e.RTCPeerConnection){var n=e.RTCPeerConnection;e.RTCPeerConnection=function(e,t){if(e&&e.iceServers){for(var i=[],s=0;s<e.iceServers.length;s++){var o=e.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(r.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,i.push(o)):i.push(e.iceServers[s])}e.iceServers=i}return new n(e,t)},e.RTCPeerConnection.prototype=n.prototype,Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return n.generateCertificate}})}else e.RTCPeerConnection=function(t,n){return i("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,n)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}});var s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,n){var r=this,i=arguments;if(arguments.length>0&&"function"==typeof e)return s.apply(this,arguments);if(0===s.length&&(0===arguments.length||"function"!=typeof arguments[0]))return s.apply(this,[]);var o=function(e){var t={};return e.result().forEach(function(e){var n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){n[t]=e.stat(t)}),t[n.id]=n}),t},a=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};if(arguments.length>=2){return s.apply(this,[function(e){i[1](a(o(e)))},arguments[0]])}return new Promise(function(e,t){s.apply(r,[function(t){e(a(o(t)))},t])}).then(t,n)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,r=new Promise(function(r,i){n.apply(t,[e[0],r,i])});return e.length<2?r:r.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),t.version<52&&["createOffer","createAnswer"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var t=1===arguments.length?arguments[0]:void 0;return new Promise(function(r,i){n.apply(e,[r,i,t])})}return n.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var o=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?o.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}};t.exports={shimMediaStream:s.shimMediaStream,shimOnTrack:s.shimOnTrack,shimAddTrackRemoveTrack:s.shimAddTrackRemoveTrack,shimGetSendersWithDtmf:s.shimGetSendersWithDtmf,shimSourceObject:s.shimSourceObject,shimPeerConnection:s.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":24,"./getusermedia":17}],17:[function(e,t,n){"use strict";var r=e("../utils.js"),i=r.log;t.exports=function(e){var t=r.detectBrowser(e),n=e&&e.navigator,s=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];var s={};"number"==typeof r.ideal?(s[i("min",n)]=r.ideal,t.optional.push(s),(s={})[i("max",n)]=r.ideal,t.optional.push(s)):(s[i("",n)]=r.ideal,t.optional.push(s))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach(function(e){void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},o=function(e,r){if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){var o=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};o((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),o(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=s(e.audio)}if(e&&"object"==typeof e.video){var a=e.video.facingMode;a=a&&("object"==typeof a?a:{ideal:a});var c,d=t.version<66;if(a&&("user"===a.exact||"environment"===a.exact||"user"===a.ideal||"environment"===a.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d))if(delete e.video.facingMode,"environment"===a.exact||"environment"===a.ideal?c=["back","rear"]:"user"!==a.exact&&"user"!==a.ideal||(c=["front"]),c)return n.mediaDevices.enumerateDevices().then(function(t){var n=(t=t.filter(function(e){return"videoinput"===e.kind})).find(function(e){return c.some(function(t){return-1!==e.label.toLowerCase().indexOf(t)})});return!n&&t.length&&-1!==c.indexOf("back")&&(n=t[t.length-1]),n&&(e.video.deviceId=a.exact?{exact:n.deviceId}:{ideal:n.deviceId}),e.video=s(e.video),i("chrome: "+JSON.stringify(e)),r(e)});e.video=s(e.video)}return i("chrome: "+JSON.stringify(e)),r(e)},a=function(e){return{name:{PermissionDeniedError:"NotAllowedError",InvalidStateError:"NotReadableError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotReadableError",MediaDeviceKillSwitchOn:"NotReadableError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};n.getUserMedia=function(e,t,r){o(e,function(e){n.webkitGetUserMedia(e,t,function(e){r&&r(a(e))})})};var c=function(e){return new Promise(function(t,r){n.getUserMedia(e,t,r)})};if(n.mediaDevices||(n.mediaDevices={getUserMedia:c,enumerateDevices:function(){return new Promise(function(t){var n={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:n[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),n.mediaDevices.getUserMedia){var d=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(e){return o(e,function(e){return d(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(a(e))})})}}else n.mediaDevices.getUserMedia=function(e){return c(e)};void 0===n.mediaDevices.addEventListener&&(n.mediaDevices.addEventListener=function(){i("Dummy mediaDevices.addEventListener called.")}),void 0===n.mediaDevices.removeEventListener&&(n.mediaDevices.removeEventListener=function(){i("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":24}],18:[function(e,t,n){"use strict";var r=e("sdp"),i=e("./utils");t.exports={shimRTCIceCandidate:function(e){if(!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){"object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2));var n=new t(e),i=r.parseCandidate(e.candidate),s=Object.assign(n,i);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s},function(e,t,n){if(e.RTCPeerConnection){var r=e.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return i.apply(this,arguments);var s=function(e){r(n(e))};return this._eventMap=this._eventMap||{},this._eventMap[r]=s,i.apply(this,[e,s])};var s=r.removeEventListener;r.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[n])return s.apply(this,arguments);var r=this._eventMap[n];return delete this._eventMap[n],s.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)}})}}(e,"icecandidate",function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})}},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"==typeof e&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var n=t.createObjectURL.bind(t),r=t.revokeObjectURL.bind(t),s=new Map,o=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++o;return s.set(t,e),i.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return n(e)},t.revokeObjectURL=function(e){r(e),s.delete(e)};var a=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return a.get.apply(this)},set:function(e){return this.srcObject=s.get(e)||null,a.set.apply(this,[e])}});var c=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=s.get(arguments[1])||null),c.apply(this,arguments)}}}}},{"./utils":24,sdp:12}],19:[function(e,t,n){"use strict";var r=e("../utils"),i=e("rtcpeerconnection-shim");t.exports={shimGetUserMedia:e("./getusermedia"),shimPeerConnection:function(e){var t=r.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var n=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){n.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCPeerConnection=i(e,t.version)},shimReplaceTrack:function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}}},{"../utils":24,"./getusermedia":20,"rtcpeerconnection-shim":7}],20:[function(e,t,n){"use strict";t.exports=function(e){var t=e&&e.navigator,n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch(function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))})}}},{}],21:[function(e,t,n){"use strict";var r=e("../utils"),i={shimOnTrack:function(e){"object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.transceiver={receiver:n.receiver},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}}),"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(e){"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(e){var t=r.detectBrowser(e);if("object"==typeof e&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(n,r){if(t.version<38&&n&&n.iceServers){for(var i=[],s=0;s<n.iceServers.length;s++){var o=n.iceServers[s];if(o.hasOwnProperty("urls"))for(var a=0;a<o.urls.length;a++){var c={url:o.urls[a]};0===o.urls[a].indexOf("turn")&&(c.username=o.username,c.credential=o.credential),i.push(c)}else i.push(n.iceServers[s])}n.iceServers=i}return new e.mozRTCPeerConnection(n,r)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,n,r){return s.apply(this,[e||null]).then(function(e){if(t.version<48&&(e=function(e){var t=new Map;return Object.keys(e).forEach(function(n){t.set(n,e[n]),t[n]=e[n]}),t}(e)),t.version<53&&!n)try{e.forEach(function(e){e.type=i[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach(function(t,n){e.set(n,Object.assign({},t,{type:i[t.type]||t.type}))})}return e}).then(n,r)}}}};t.exports={shimOnTrack:i.shimOnTrack,shimSourceObject:i.shimSourceObject,shimPeerConnection:i.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":24,"./getusermedia":22}],22:[function(e,t,n){"use strict";var r=e("../utils"),i=r.log;t.exports=function(e){var t=r.detectBrowser(e),n=e&&e.navigator,s=e&&e.MediaStreamTrack,o=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},a=function(e,r,s){var a=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var r=e[n]="object"==typeof e[n]?e[n]:{ideal:e[n]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||t.push(n),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:e[n]=r.exact,delete r.exact),void 0!==r.ideal){e.advanced=e.advanced||[];var i={};"number"==typeof r.ideal?i[n]={min:r.ideal,max:r.ideal}:i[n]=r.ideal,e.advanced.push(i),delete r.ideal,Object.keys(r).length||delete e[n]}}}),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(i("spec: "+JSON.stringify(e)),e.audio&&(e.audio=a(e.audio)),e.video&&(e.video=a(e.video)),i("ff37: "+JSON.stringify(e))),n.mozGetUserMedia(e,r,function(e){s(o(e))})};if(n.mediaDevices||(n.mediaDevices={getUserMedia:function(e){return new Promise(function(t,n){a(e,t,n)})},addEventListener:function(){},removeEventListener:function(){}}),n.mediaDevices.enumerateDevices=n.mediaDevices.enumerateDevices||function(){return new Promise(function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},t.version<41){var c=n.mediaDevices.enumerateDevices.bind(n.mediaDevices);n.mediaDevices.enumerateDevices=function(){return c().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(t.version<49){var d=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(e){return d(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return t},function(e){return Promise.reject(o(e))})}}if(!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){var l=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},u=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(e){return"object"==typeof e&&"object"==typeof e.audio&&(e=JSON.parse(JSON.stringify(e)),l(e.audio,"autoGainControl","mozAutoGainControl"),l(e.audio,"noiseSuppression","mozNoiseSuppression")),u(e)},s&&s.prototype.getSettings){var h=s.prototype.getSettings;s.prototype.getSettings=function(){var e=h.apply(this,arguments);return l(e,"mozAutoGainControl","autoGainControl"),l(e,"mozNoiseSuppression","noiseSuppression"),e}}if(s&&s.prototype.applyConstraints){var p=s.prototype.applyConstraints;s.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"==typeof e&&(e=JSON.parse(JSON.stringify(e)),l(e,"autoGainControl","mozAutoGainControl"),l(e,"noiseSuppression","mozNoiseSuppression")),p.apply(this,[e])}}}n.getUserMedia=function(e,i,s){if(t.version<44)return a(e,i,s);r.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(i,s)}}},{"../utils":24}],23:[function(e,t,n){"use strict";var r=e("../utils"),i={shimLocalStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this._localStreams&&this._localStreams.forEach(function(n){n.id===e&&(t=n)}),this._remoteStreams&&this._remoteStreams.forEach(function(n){n.id===e&&(t=n)}),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(e)&&this._localStreams.push(e);var n=this;e.getTracks().forEach(function(r){t.call(n,r,e)})},e.RTCPeerConnection.prototype.addTrack=function(e,n){n&&(this._localStreams?-1===this._localStreams.indexOf(n)&&this._localStreams.push(n):this._localStreams=[n]),t.call(this,e,n)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);var t=this._localStreams.indexOf(e);if(-1!==t){this._localStreams.splice(t,1);var n=this,r=e.getTracks();this.getSenders().forEach(function(e){-1!==r.indexOf(e.track)&&n.removeTrack(e)})}})}},shimRemoteStreamsAPI:function(e){"object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),"onaddstream"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){var t=e.streams[0];if(this._remoteStreams||(this._remoteStreams=[]),!(this._remoteStreams.indexOf(t)>=0)){this._remoteStreams.push(t);var n=new Event("addstream");n.stream=e.streams[0],this.dispatchEvent(n)}}.bind(this))}}))},shimCallbacksAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,n=t.createOffer,r=t.createAnswer,i=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i};var a=function(e,t,n){var r=i.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r};t.setLocalDescription=a,a=function(e,t,n){var r=s.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.setRemoteDescription=a,a=function(e,t,n){var r=o.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.addIceCandidate=a}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,r){t.mediaDevices.getUserMedia(e).then(n,r)}.bind(t)))},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){for(var i=[],s=0;s<e.iceServers.length;s++){var o=e.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(r.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,delete o.url,i.push(o)):i.push(e.iceServers[s])}e.iceServers=i}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},shimTrackEventTransceiver:function(e){"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var n=this;if(e){var r=n.getTransceivers().find(function(e){return e.sender.track&&"audio"===e.sender.track.kind});!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection("sendonly"):"recvonly"===r.direction&&r.setDirection("inactive"):!0!==e.offerToReceiveAudio||r||n.addTransceiver("audio");var i=n.getTransceivers().find(function(e){return e.sender.track&&"video"===e.sender.track.kind});!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection("sendonly"):"recvonly"===i.direction&&i.setDirection("inactive"):!0!==e.offerToReceiveVideo||i||n.addTransceiver("video")}return t.apply(n,arguments)}}};t.exports={shimCallbacksAPI:i.shimCallbacksAPI,shimLocalStreamsAPI:i.shimLocalStreamsAPI,shimRemoteStreamsAPI:i.shimRemoteStreamsAPI,shimGetUserMedia:i.shimGetUserMedia,shimRTCIceServerUrls:i.shimRTCIceServerUrls,shimTrackEventTransceiver:i.shimTrackEventTransceiver,shimCreateOfferLegacy:i.shimCreateOfferLegacy}},{"../utils":24}],24:[function(e,t,n){"use strict";var r=!0,i=!0,s={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(r=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(i=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},log:function(){if("object"==typeof window){if(r)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(e,t){i&&console.warn(e+" is deprecated, please use "+t+" instead.")},extractVersion:function(e,t,n){var r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)},detectBrowser:function(e){var t=e&&e.navigator,n={browser:null,version:null};if(void 0===e||!e.navigator)return n.browser="Not a browser.",n;if(t.mozGetUserMedia)n.browser="firefox",n.version=this.extractVersion(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)if(e.webkitRTCPeerConnection)n.browser="chrome",n.version=this.extractVersion(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!t.userAgent.match(/Version\/(\d+).(\d+)/))return n.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",n;n.browser="safari",n.version=this.extractVersion(t.userAgent,/AppleWebKit\/(\d+)\./,1)}else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))n.browser="edge",n.version=this.extractVersion(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!t.mediaDevices||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return n.browser="Not a supported browser.",n;n.browser="safari",n.version=this.extractVersion(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return n}};t.exports={log:s.log,deprecated:s.deprecated,disableLog:s.disableLog,disableWarnings:s.disableWarnings,extractVersion:s.extractVersion,shimCreateObjectURL:s.shimCreateObjectURL,detectBrowser:s.detectBrowser.bind(s)}},{}],25:[function(e,t,n){"use strict";var r,i=e("./qbChatHelpers"),s=e("../../qbConfig"),o=e("../../qbUtils"),a=e("../../plugins/streamManagement"),c="This function isn't supported outside of the browser (...yet)";if(o.getEnv().browser){var d=e("../../qbStrophe");Strophe.addNamespace("CARBONS",i.MARKERS.CARBONS),Strophe.addNamespace("CHAT_MARKERS",i.MARKERS.CHAT),Strophe.addNamespace("PRIVACY_LIST",i.MARKERS.PRIVACY),Strophe.addNamespace("CHAT_STATES",i.MARKERS.STATES)}else o.getEnv().nativescript||o.getEnv().node;function l(e){var t,n=this;n.webrtcSignalingProcessor=null,o.getEnv().browser?(n.connection=d(),n.connection.XHandlerReferences=[],n.connection.XAddTrackedHandler=function(e,t,r,i,s,o,a){n.connection.XHandlerReferences.push(n.connection.addHandler(e,t,r,i,s,o,a))},n.connection.XDeleteHandlers=function(){for(;n.connection.XHandlerReferences.length;)n.connection.deleteHandler(n.connection.XHandlerReferences.pop())},t=n.connection.send,n.connection.send=function(e){if(!n.connection.connected)throw new i.ChatNotConnectedError("Chat is not connected");t.call(n.connection,e)}):(o.getEnv().nativescript?n.Client=new r.Client({websocket:{url:s.chatProtocol.websocket},autostart:!1}):o.getEnv().node&&(n.Client=new r({autostart:!1})),t=n.Client.send,n.Client.send=function(e){o.QBLog("[QBChat]","SENT:",e.toString()),t.call(n.Client,e)},n.nodeStanzasCallbacks={}),this.service=e,this.isConnected=!1,this._isConnecting=!1,this._isLogout=!1,this._checkConnectionTimer=void 0,this._pings={},this.helpers=new f;var c={service:e,helpers:n.helpers,stropheClient:n.connection,xmppClient:n.Client,nodeStanzasCallbacks:n.nodeStanzasCallbacks};this.roster=new u(c),this.privacylist=new p(c),this.muc=new h(c),this.chatUtils=i,s.streamManagement.enable&&(2===s.chatProtocol.active?(this.streamManagement=new a(s.streamManagement),n._sentMessageCallback=function(e,t){"function"==typeof n.onSentMessageCallback&&(t?n.onSentMessageCallback(null,t):n.onSentMessageCallback(e))}):o.QBLog("[QBChat] StreamManagement:",'BOSH protocol doesn\'t support stream management. Set WebSocket as the "chatProtocol" parameter to use this functionality. https://quickblox.com/developers/Javascript#Configuration')),this._onMessage=function(e){var t,r,s,a,c=i.getAttr(e,"from"),d=(i.getAttr(e,"to"),i.getAttr(e,"type")),l=i.getAttr(e,"id"),u=i.getElement(e,"markable"),h=i.getElement(e,"received"),p=i.getElement(e,"displayed"),f=i.getElement(e,"composing"),m=i.getElement(e,"paused"),g=i.getElement(e,"invite"),v=i.getElement(e,"delay"),S=i.getElement(e,"extraParams"),y=i.getElementText(e,"body"),b=i.getElement(e,"forwarded");if(o.getEnv().browser)s=e.querySelector("forwarded")?e.querySelector("forwarded").querySelector("message").getAttribute("to"):null,a=n.connection.jid;else{var C=b?i.getElement(b,"message"):null;s=C?i.getAttr(C,"to"):null,a=n.Client.options.jid.user}r=s?n.helpers.getIdFromNode(s):null;var _="groupchat"===d?n.helpers.getDialogIdFromNode(c):null,T="groupchat"===d?n.helpers.getIdFromResource(c):n.helpers.getIdFromNode(c),E=h||p||null;if(g)return!0;if(S&&(t=i.parseExtraParams(S)).dialogId&&(_=t.dialogId),f||m)return"function"!=typeof n.onMessageTypingListener||"chat"!==d&&"groupchat"!==d&&v||o.safeCallbackCall(n.onMessageTypingListener,!!f,T,_),!0;if(E)return h?"function"==typeof n.onDeliveredStatusListener&&"chat"===d&&o.safeCallbackCall(n.onDeliveredStatusListener,i.getAttr(h,"id"),_,T):"function"==typeof n.onReadStatusListener&&"chat"===d&&o.safeCallbackCall(n.onReadStatusListener,i.getAttr(p,"id"),_,T),!0;if(u&&T!=n.helpers.getIdFromNode(a)){var w={messageId:l,userId:T,dialogId:_};n.sendDeliveredStatus(w)}var x={id:l,dialog_id:_,recipient_id:r,type:d,body:y,extension:t?t.extension:null,delay:v};return u&&(x.markable=1),"function"!=typeof n.onMessageListener||"chat"!==d&&"groupchat"!==d||o.safeCallbackCall(n.onMessageListener,T,x),!0},this._onPresence=function(e){var t,s,a,c,d,l=i.getAttr(e,"from"),u=(i.getAttr(e,"to"),i.getAttr(e,"id")),h=i.getAttr(e,"type"),p=n.helpers.getIdFromNode(n.helpers.userCurrentJid(o.getEnv().browser?n.connection:n.Client)),f=i.getElement(e,"x");if(f&&(t=i.getAttr(f,"xmlns"),(s=i.getElement(f,"status"))&&(a=i.getAttr(s,"code"))),t&&"http://jabber.org/protocol/muc#user"==t){if(c=n.helpers.getDialogIdFromNode(l),d=n.helpers.getUserIdFromRoomJid(l),s&&"301"==a){if("function"==typeof n.onKickOccupant){var m=i.getElement(i.getElement(f,"item"),"actor"),g=i.getAttr(m,"jid");o.safeCallbackCall(n.onKickOccupant,c,n.helpers.getIdFromNode(g))}return delete n.muc.joinedRooms[n.helpers.getRoomJidFromRoomFullJid(l)],!0}if(!s&&d!=p)return h&&"unavailable"===h?("function"==typeof n.onLeaveOccupant&&o.safeCallbackCall(n.onLeaveOccupant,c,parseInt(d)),!0):("function"==typeof n.onJoinOccupant&&o.safeCallbackCall(n.onJoinOccupant,c,parseInt(d)),!0)}if(!o.getEnv().browser&&t)if("http://jabber.org/protocol/muc#user"==t){if(h&&"unavailable"===h)return s&&"110"==a&&"function"==typeof n.nodeStanzasCallbacks["muc:leave"]&&o.safeCallbackCall(n.nodeStanzasCallbacks["muc:leave"],null),!0;if(u.endsWith(":join")&&s&&"110"==a)return"function"==typeof n.nodeStanzasCallbacks[u]&&n.nodeStanzasCallbacks[u](e),!0}else if(h&&"error"===h&&"http://jabber.org/protocol/muc"==t)return u.endsWith(":join")&&"function"==typeof n.nodeStanzasCallbacks[u]&&n.nodeStanzasCallbacks[u](e),!0;if(d=n.helpers.getIdFromNode(l),h)switch(h){case"subscribe":n.roster.contacts[d]&&"to"===n.roster.contacts[d].subscription?(n.roster.contacts[d]={subscription:"both",ask:null},n.roster._sendSubscriptionPresence({jid:l,type:"subscribed"})):"function"==typeof n.onSubscribeListener&&o.safeCallbackCall(n.onSubscribeListener,d);break;case"subscribed":n.roster.contacts[d]&&"from"===n.roster.contacts[d].subscription?n.roster.contacts[d]={subscription:"both",ask:null}:(n.roster.contacts[d]={subscription:"to",ask:null},"function"==typeof n.onConfirmSubscribeListener&&o.safeCallbackCall(n.onConfirmSubscribeListener,d));break;case"unsubscribed":n.roster.contacts[d]={subscription:"none",ask:null},"function"==typeof n.onRejectSubscribeListener&&o.safeCallbackCall(n.onRejectSubscribeListener,d);break;case"unsubscribe":n.roster.contacts[d]={subscription:"to",ask:null};break;case"unavailable":"function"==typeof n.onContactListListener&&n.roster.contacts[d]&&"none"!==n.roster.contacts[d].subscription&&o.safeCallbackCall(n.onContactListListener,d,h),d===p&&(o.getEnv().browser?n.connection.send($pres()):n.Client.send(i.createStanza(r.Stanza,null,"presence")))}else"function"==typeof n.onContactListListener&&n.roster.contacts[d]&&"none"!==n.roster.contacts[d].subscription&&o.safeCallbackCall(n.onContactListListener,d);return!0},this._onIQ=function(e){var t=i.getAttr(e,"id"),s=t.indexOf("lastActivity")>-1,a=t.indexOf("ping")>-1,c=i.getElement(e,"ping"),d=i.getAttr(e,"type"),l=i.getAttr(e,"from"),u=l?n.helpers.getIdFromNode(l):null;if("function"==typeof n.onLastUserActivityListener&&s){var h=i.getElement(e,"query"),p=i.getElement(e,"error")?void 0:+i.getAttr(h,"seconds");o.safeCallbackCall(n.onLastUserActivityListener,u,p)}if((c||a)&&d)if("get"===d&&c&&n.isConnected){var f=o.getEnv().browser?$iq:r.Stanza,m={from:n.helpers.getUserCurrentJid(),id:t,to:l,type:"result"},g=i.createStanza(f,m,"iq");o.getEnv().browser?n.connection.send(g):n.Client.send(g)}else{var v=n._pings[t];v&&(v.callback&&v.callback(null),v.interval&&clearInterval(v.interval),n._pings[t]=void 0,delete n._pings[t])}return o.getEnv().browser||n.nodeStanzasCallbacks[t]&&(o.safeCallbackCall(n.nodeStanzasCallbacks[t],e),delete n.nodeStanzasCallbacks[t]),!0},this._onSystemMessageListener=function(e){var t,r=i.getAttr(e,"from"),s=(i.getAttr(e,"to"),i.getAttr(e,"id")),a=i.getElement(e,"extraParams"),c=n.helpers.getIdFromNode(r),d=i.getElement(e,"delay"),l=i.getElementText(a,"moduleIdentifier"),u=i.getElementText(e,"body"),h=i.parseExtraParams(a);return"SystemNotifications"===l&&"function"==typeof n.onSystemMessageListener?(t={id:s,userId:c,body:u,extension:h.extension},o.safeCallbackCall(n.onSystemMessageListener,t)):n.webrtcSignalingProcessor&&!d&&"WebRTCVideoChat"===l&&n.webrtcSignalingProcessor._onMessage(r,a,d,c,h.extension),!0},this._onMessageErrorListener=function(e){var t=i.getAttr(e,"id"),r=i.getErrorFromXMLNode(e);return"function"==typeof n.onMessageErrorListener&&o.safeCallbackCall(n.onMessageErrorListener,t,r),!0}}function u(e){this.service=e.service,this.helpers=e.helpers,this.connection=e.stropheClient,this.Client=e.xmppClient,this.nodeStanzasCallbacks=e.nodeStanzasCallbacks,this.contacts={}}function h(e){this.service=e.service,this.helpers=e.helpers,this.connection=e.stropheClient,this.Client=e.xmppClient,this.nodeStanzasCallbacks=e.nodeStanzasCallbacks,this.joinedRooms={}}function p(e){this.service=e.service,this.helpers=e.helpers,this.connection=e.stropheClient,this.Client=e.xmppClient,this.nodeStanzasCallbacks=e.nodeStanzasCallbacks}function f(){this._userCurrentJid=""}l.prototype={connect:function(e,t){o.QBLog("[QBChat]","Connect with parameters "+JSON.stringify(e));var n,r=this,a=i.buildUserJid(e),c="function"==typeof t;return r._isConnecting?(n=o.getError(422,"Status.REJECT - The connection is still in the Status.CONNECTING state","QBChat"),void(c&&t(n,null))):r.isConnected?(o.QBLog("[QBChat]","Status.CONNECTED - You are already connected"),void(c&&t(null,r.roster.contacts))):(r._isConnecting=!0,r._isLogout=!1,o.getEnv().browser&&r.connection.connect(a,e.password,function(a){switch(a){case Strophe.Status.ERROR:r.isConnected=!1,r._isConnecting=!1,n=o.getError(422,"Status.ERROR - An error has occurred","QBChat"),c&&t(n,null);break;case Strophe.Status.CONNFAIL:r.isConnected=!1,r._isConnecting=!1,n=o.getError(422,"Status.CONNFAIL - The connection attempt failed","QBChat"),c&&t(n,null);break;case Strophe.Status.AUTHENTICATING:o.QBLog("[QBChat]","Status.AUTHENTICATING");break;case Strophe.Status.AUTHFAIL:r.isConnected=!1,r._isConnecting=!1,n=o.getError(401,"Status.AUTHFAIL - The authentication attempt failed","QBChat"),c&&t(n,null),r.isConnected||"function"!=typeof r.onReconnectFailedListener||o.safeCallbackCall(r.onReconnectFailedListener,n);break;case Strophe.Status.CONNECTING:o.QBLog("[QBChat]","Status.CONNECTING","(Chat Protocol - "+(1===s.chatProtocol.active?"BOSH":"WebSocket)"));break;case Strophe.Status.CONNECTED:r.connection.XDeleteHandlers(),r.connection.XAddTrackedHandler(r._onMessage,null,"message","chat"),r.connection.XAddTrackedHandler(r._onMessage,null,"message","groupchat"),r.connection.XAddTrackedHandler(r._onPresence,null,"presence"),r.connection.XAddTrackedHandler(r._onIQ,null,"iq"),r.connection.XAddTrackedHandler(r._onSystemMessageListener,null,"message","headline"),r.connection.XAddTrackedHandler(r._onMessageErrorListener,null,"message","error"),r._postConnectActions(function(e){t(null,e)},c);break;case Strophe.Status.DISCONNECTING:o.QBLog("[QBChat]","Status.DISCONNECTING");break;case Strophe.Status.DISCONNECTED:o.QBLog("[QBChat]","Status.DISCONNECTED at "+i.getLocalTime()),r.isConnected&&"function"==typeof r.onDisconnectedListener&&o.safeCallbackCall(r.onDisconnectedListener),r.isConnected=!1,r._isConnecting=!1,r._establishConnection(e);break;case Strophe.Status.ATTACHED:o.QBLog("[QBChat]","Status.ATTACHED")}}),void(o.getEnv().browser||(r.Client.removeAllListeners(),r.Client.on("connect",function(){o.QBLog("[QBChat]","Status.CONNECTING","(Chat Protocol - "+(1===s.chatProtocol.active?"BOSH":"WebSocket)"))}),r.Client.on("auth",function(){o.QBLog("[QBChat]","Status.AUTHENTICATING")}),r.Client.on("online",function(){r._postConnectActions(function(e){t(null,e)},c)}),r.Client.on("stanza",function(e){o.QBLog("[QBChat] RECV:",e.toString()),e.is("presence")?r._onPresence(e):e.is("iq")?r._onIQ(e):e.is("message")&&("headline"===e.attrs.type?r._onSystemMessageListener(e):"error"===e.attrs.type?r._onMessageErrorListener(e):r._onMessage(e))}),r.Client.on("disconnect",function(){o.QBLog("[QBChat]","Status.DISCONNECTED - "+i.getLocalTime()),"function"==typeof r.onDisconnectedListener&&o.safeCallbackCall(r.onDisconnectedListener),r.isConnected=!1,r._isConnecting=!1,r._establishConnection(e)}),r.Client.on("error",function(){o.QBLog("[QBChat]","Status.ERROR - "+i.getLocalTime()),n=o.getError(422,"Status.ERROR - An error has occurred","QBChat"),c&&t(n,null),r.isConnected=!1,r._isConnecting=!1}),r.Client.on("end",function(){r.Client.removeAllListeners()}),r.Client.options.jid=a,r.Client.options.password=e.password,r.Client.connect())))},_postConnectActions:function(e,t){o.QBLog("[QBChat]","Status.CONNECTED at "+i.getLocalTime());var n=this,a=o.getEnv().browser?n.connection:n.Client,c=o.getEnv().browser?$pres():i.createStanza(r.Stanza,null,"presence");if(s.streamManagement.enable&&2===s.chatProtocol.active&&(n.streamManagement.enable(n.connection,null),n.streamManagement.sentMessageCallback=n._sentMessageCallback),n.helpers.setUserCurrentJid(n.helpers.userCurrentJid(a)),n.isConnected=!0,n._isConnecting=!1,n._enableCarbons(),t)n.roster.get(function(t){a.send(c),n.roster.contacts=t,e(n.roster.contacts)});else{var d=Object.keys(n.muc.joinedRooms);a.send(c),o.QBLog("[QBChat]","Re-joining "+d.length+" rooms...");for(var l=0,u=d.length;l<u;l++)n.muc.join(d[l]);"function"==typeof n.onReconnectListener&&o.safeCallbackCall(n.onReconnectListener)}},_establishConnection:function(e){var t=this;if(!t._isLogout&&!t._checkConnectionTimer){var n=function(){t.isConnected||t._isConnecting?(clearInterval(t._checkConnectionTimer),t._checkConnectionTimer=void 0):t.connect(e)};n(),t._checkConnectionTimer=setInterval(function(){n()},1e3*s.chatReconnectionTimeInterval)}},send:function(e,t){var n=o.getEnv().browser?$msg:r.Stanza,a={from:this.helpers.getUserCurrentJid(),to:this.helpers.jidOrUserId(e),type:t.type?t.type:"chat",id:t.id?t.id:o.getBsonObjectId()},c=i.createStanza(n,a);return t.body&&c.c("body",{xmlns:i.MARKERS.CLIENT}).t(t.body).up(),t.markable&&c.c("markable",{xmlns:i.MARKERS.CHAT}).up(),t.extension&&(c.c("extraParams",{xmlns:i.MARKERS.CLIENT}),c=i.filledExtraParams(c,t.extension)),o.getEnv().browser?s.streamManagement.enable?(t.id=a.id,t.jid_or_user_id=e,this.connection.send(c,t)):this.connection.send(c):s.streamManagement.enable?(t.id=a.id,t.jid_or_user_id=e,this.Client.send(c,t)):this.Client.send(c),a.id},sendSystemMessage:function(e,t){var n=o.getEnv().browser?$msg:r.Stanza,s={type:"headline",id:t.id?t.id:o.getBsonObjectId(),to:this.helpers.jidOrUserId(e)},a=i.createStanza(n,s);return t.body&&a.c("body",{xmlns:i.MARKERS.CLIENT}).t(t.body).up(),o.getEnv().browser?(t.extension&&(a.c("extraParams",{xmlns:i.MARKERS.CLIENT}).c("moduleIdentifier").t("SystemNotifications").up(),a=i.filledExtraParams(a,t.extension)),this.connection.send(a)):(t.extension&&(a.c("extraParams",{xmlns:i.MARKERS.CLIENT}).c("moduleIdentifier").t("SystemNotifications"),a=i.filledExtraParams(a,t.extension)),this.Client.send(a)),s.id},sendIsTypingStatus:function(e){var t={from:this.helpers.getUserCurrentJid(),to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)},n=o.getEnv().browser?$msg:r.Stanza,s=i.createStanza(n,t);s.c("composing",{xmlns:i.MARKERS.STATES}),o.getEnv().browser?this.connection.send(s):this.Client.send(s)},sendIsStopTypingStatus:function(e){var t={from:this.helpers.getUserCurrentJid(),to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)},n=o.getEnv().browser?$msg:r.Stanza,s=i.createStanza(n,t);s.c("paused",{xmlns:i.MARKERS.STATES}),o.getEnv().browser?this.connection.send(s):this.Client.send(s)},sendDeliveredStatus:function(e){var t={type:"chat",from:this.helpers.getUserCurrentJid(),id:o.getBsonObjectId(),to:this.helpers.jidOrUserId(e.userId)},n=o.getEnv().browser?$msg:r.Stanza,s=i.createStanza(n,t);s.c("received",{xmlns:i.MARKERS.MARKERS,id:e.messageId}).up(),s.c("extraParams",{xmlns:i.MARKERS.CLIENT}).c("dialog_id").t(e.dialogId),o.getEnv().browser?this.connection.send(s):this.Client.send(s)},sendReadStatus:function(e){var t={type:"chat",from:this.helpers.getUserCurrentJid(),to:this.helpers.jidOrUserId(e.userId),id:o.getBsonObjectId()},n=o.getEnv().browser?$msg:r.Stanza,s=i.createStanza(n,t);s.c("displayed",{xmlns:i.MARKERS.MARKERS,id:e.messageId}).up(),s.c("extraParams",{xmlns:i.MARKERS.CLIENT}).c("dialog_id").t(e.dialogId),o.getEnv().browser?this.connection.send(s):this.Client.send(s)},getLastUserActivity:function(e){var t,n,s;t={from:this.helpers.getUserCurrentJid(),id:this.helpers.getUniqueId("lastActivity"),to:this.helpers.jidOrUserId(e),type:"get"},n=o.getEnv().browser?$iq:r.Stanza,(s=i.createStanza(n,t,"iq")).c("query",{xmlns:i.MARKERS.LAST}),o.getEnv().browser?this.connection.sendIQ(s):this.Client.send(s)},ping:function(e,t){var n,a,c,d=this,l=this.helpers.getUniqueId("ping"),u=o.getEnv().browser?$iq:r.Stanza;if("string"!=typeof e&&"number"!=typeof e||"function"!=typeof t){if("function"!=typeof e||t)throw new Error("Invalid arguments provided. Either userId/jid (number/string) and callback or only callback should be provided.");n=s.endpoints.chat,a=e}else n=this.helpers.jidOrUserId(e),a=t;var h={from:this.helpers.getUserCurrentJid(),id:l,to:n,type:"get"};(c=i.createStanza(u,h,"iq")).c("ping",{xmlns:"urn:xmpp:ping"});return o.getEnv().browser?this.connection.send(c):this.Client.send(c),this._pings[l]={callback:a,interval:setTimeout(function(){a("No answer"),d._pings[l]=void 0,delete d._pings[l]},1e3*s.pingTimeout)},l},disconnect:function(){clearInterval(this._checkConnectionTimer),this._checkConnectionTimer=void 0,this.muc.joinedRooms={},this._isLogout=!0,this.helpers.setUserCurrentJid(""),o.getEnv().browser?(this.connection.flush(),this.connection.disconnect(),this.connection.reset()):this.Client.end()},addListener:function(e,t){if(o.QBLog("[Deprecated!]","Avoid using it, this feature will be removed in future version."),!o.getEnv().browser)throw new Error(c);return this.connection.XAddTrackedHandler(function(){return t(),!1!==e.live},null,e.name||null,e.type||null,e.id||null,e.from||null)},deleteListener:function(e){if(o.QBLog("[Deprecated!]","Avoid using it, this feature will be removed in future version."),!o.getEnv().browser)throw new Error(c);this.connection.deleteHandler(e)},_enableCarbons:function(e){var t={type:"set",from:this.helpers.getUserCurrentJid(),id:i.getUniqueId("enableCarbons")},n=o.getEnv().browser?$iq:r.Stanza,s=i.createStanza(n,t,"iq");s.c("enable",{xmlns:i.MARKERS.CARBONS}),o.getEnv().browser?this.connection.sendIQ(s):this.Client.send(s)}},u.prototype={get:function(e){var t=this,n={},s={type:"get",from:t.helpers.getUserCurrentJid(),id:i.getUniqueId("getRoster")},a=o.getEnv().browser?$iq:r.Stanza,c=i.createStanza(a,s,"iq");function d(r){for(var s=function(e){return o.getEnv().browser?e.getElementsByTagName("item"):e.getChild("query").children}(r),a=0,c=s.length;a<c;a++){var d=t.helpers.getIdFromNode(i.getAttr(s[a],"jid")),l=i.getAttr(s[a],"ask"),u=i.getAttr(s[a],"subscription");n[d]={subscription:u,ask:l||null}}e(n)}c.c("query",{xmlns:i.MARKERS.ROSTER}),o.getEnv().browser?t.connection.sendIQ(c,d):(t.nodeStanzasCallbacks[s.id]=d,t.Client.send(c))},add:function(e,t){var n=this.helpers.jidOrUserId(e),r=this.helpers.getIdFromNode(n).toString();this.contacts[r]={subscription:"none",ask:"subscribe"},this._sendSubscriptionPresence({jid:n,type:"subscribe"}),"function"==typeof t&&t()},confirm:function(e,t){var n=this.helpers.jidOrUserId(e),r=this.helpers.getIdFromNode(n).toString();this.contacts[r]={subscription:"from",ask:"subscribe"},this._sendSubscriptionPresence({jid:n,type:"subscribed"}),this._sendSubscriptionPresence({jid:n,type:"subscribe"}),"function"==typeof t&&t()},reject:function(e,t){var n=this.helpers.jidOrUserId(e),r=this.helpers.getIdFromNode(n).toString();this.contacts[r]={subscription:"none",ask:null},this._sendSubscriptionPresence({jid:n,type:"unsubscribed"}),"function"==typeof t&&t()},remove:function(e,t){var n=this,s=this.helpers.jidOrUserId(e),a=this.helpers.getIdFromNode(s),c={type:"set",from:n.connection?n.connection.jid:n.Client.jid.user,id:i.getUniqueId("getRoster")},d=o.getEnv().browser?$iq:r.Stanza,l=i.createStanza(d,c,"iq");function u(){delete n.contacts[a],"function"==typeof t&&t()}l.c("query",{xmlns:i.MARKERS.ROSTER}).c("item",{jid:s,subscription:"remove"}),o.getEnv().browser?n.connection.sendIQ(l,u):(n.nodeStanzasCallbacks[c.id]=u,n.Client.send(l))},_sendSubscriptionPresence:function(e){var t=o.getEnv().browser?$pres:r.Stanza,n={to:e.jid,type:e.type},s=i.createStanza(t,n,"presence");o.getEnv().browser?this.connection.send(s):this.Client.send(s)}},h.prototype={join:function(e,t){var n=this,s=i.getUniqueId("join"),a=this.helpers.getDialogJid(e),c={id:s,from:n.helpers.getUserCurrentJid(),to:n.helpers.getRoomJid(a)},d=o.getEnv().browser?$pres:r.Stanza,l=i.createStanza(d,c,"presence");function u(e){var r=i.getAttr(e,"id"),s=i.getAttr(e,"from"),a=n.helpers.getDialogIdFromNode(s),c=i.getElement(e,"x"),d=i.getAttr(c,"xmlns"),l=i.getElement(c,"status"),u=i.getAttr(l,"code");if(1==t.length)return o.safeCallbackCall(t,e),!0;if(l&&"110"==u)o.safeCallbackCall(t,null,{dialogId:a});else{var h=i.getAttr(e,"type");if(h&&"error"===h&&"http://jabber.org/protocol/muc"==d&&r.endsWith(":join")){var p=i.getElement(e,"error"),f=i.getAttr(p,"code"),m=i.getElementText(p,"text");o.safeCallbackCall(t,{code:f||500,message:m||"Unknown issue"},{dialogId:a})}}}l.c("x",{xmlns:i.MARKERS.MUC}).c("history",{maxstanzas:0}),this.joinedRooms[a]=!0,o.getEnv().browser?("function"==typeof t&&n.connection.XAddTrackedHandler(u,null,"presence",null,s),n.connection.send(l)):("function"==typeof t&&(n.nodeStanzasCallbacks[s]=u),n.Client.send(l))},leave:function(e,t){var n={type:"unavailable",from:this.helpers.getUserCurrentJid(),to:this.helpers.getRoomJid(e)},s=o.getEnv().browser?$pres:r.Stanza,a=i.createStanza(s,n,"presence");if(delete this.joinedRooms[e],o.getEnv().browser){var c=this.helpers.getRoomJid(e);"function"==typeof t&&this.connection.XAddTrackedHandler(t,null,"presence",n.type,null,c),this.connection.send(a)}else"function"==typeof t&&(this.nodeStanzasCallbacks["muc:leave"]=t),this.Client.send(a)},listOnlineUsers:function(e,t){var n=this,s=[],a={type:"get",to:e,from:n.helpers.getUserCurrentJid(),id:i.getUniqueId("muc_disco_items")},c=o.getEnv().browser?$iq:r.Stanza,d=i.createStanza(c,a,"iq");d.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),o.getEnv().browser?n.connection.sendIQ(d,function(e){for(var r,i=e.getElementsByTagName("item"),o=0,a=i.length;o<a;o++)r=n.helpers.getUserIdFromRoomJid(i[o].getAttribute("jid")),s.push(parseInt(r));t(s)}):(n.Client.send(d),n.nodeStanzasCallbacks[a.id]=function(e){var r=e.attrs.id;if(n.nodeStanzasCallbacks[r]){for(var i,s=[],o=e.getChild("query").getChildElements("item"),a=0,c=o.length;a<c;a++)i=n.helpers.getUserIdFromRoomJid(o[a].attrs.jid),s.push(parseInt(i));t(s)}})}},p.prototype={create:function(e,t){for(var n,s,a,c,d,l,u={},h=e.items.length-1;h>=0;h--){var p=e.items[h];u[p.user_id]={action:p.action,mutualBlock:!0===p.mutualBlock}}l=Object.keys(u);var f={type:"set",from:this.helpers.getUserCurrentJid(),id:i.getUniqueId("edit")},m=o.getEnv().browser?$iq:r.Stanza,g=i.createStanza(m,f,"iq");function v(e,t){o.getEnv().browser?e.c("item",{type:"jid",value:t.jidOrMuc,action:t.userAction,order:t.order}).c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up():e.getChild("query").getChild("list").c("item",{type:"jid",value:t.jidOrMuc,action:t.userAction,order:t.order}).c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up();return e}function S(e,t){o.getEnv().browser?e.c("item",{type:"jid",value:t.jidOrMuc,action:t.userAction,order:t.order}).up():e.getChild("query").getChild("list").c("item",{type:"jid",value:t.jidOrMuc,action:t.userAction,order:t.order}).up();return e}g.c("query",{xmlns:i.MARKERS.PRIVACY}).c("list",{name:e.name});for(var y=0,b=0,C=l.length;y<C;y++,b+=2)d=u[n=l[y]].mutualBlock,c=u[n].action,s=this.helpers.jidOrUserId(parseInt(n,10)),a=this.helpers.getUserNickWithMucDomain(n),d&&"deny"===c?(g=S(g,{order:b+1,jidOrMuc:s,userAction:c}),g=S(g,{order:b+2,jidOrMuc:a,userAction:c}).up().up()):(g=v(g,{order:b+1,jidOrMuc:s,userAction:c}),g=v(g,{order:b+2,jidOrMuc:a,userAction:c}));o.getEnv().browser?this.connection.sendIQ(g,function(e){t(null)},function(e){if(e){var n=i.getErrorFromXMLNode(e);t(n)}else t(o.getError(408))}):(this.Client.send(g),this.nodeStanzasCallbacks[f.id]=function(e){e.getChildElements("error").length?t(o.getError(408)):t(null)})},getList:function(e,t){var n,s,a,c=this,d=[],l={type:"get",from:c.helpers.getUserCurrentJid(),id:i.getUniqueId("getlist")},u=o.getEnv().browser?$iq:r.Stanza,h=i.createStanza(u,l,"iq");h.c("query",{xmlns:i.MARKERS.PRIVACY}).c("list",{name:e}),o.getEnv().browser?c.connection.sendIQ(h,function(r){for(var i=0,o=(n=r.getElementsByTagName("item")).length;i<o;i+=2)s=n[i].getAttribute("value"),a=c.helpers.getIdFromNode(s),d.push({user_id:a,action:n[i].getAttribute("action")});t(null,{name:e,items:d})},function(e){if(e){var n=i.getErrorFromXMLNode(e);t(n,null)}else t(o.getError(408),null)}):(c.nodeStanzasCallbacks[l.id]=function(e){for(var n,r,i=e.getChild("query"),s=i?i.getChild("list"):null,o=s?s.getChildElements("item"):null,a=[],d=0,u=o.length;d<u;d+=2)n=o[d].attrs.value,r=c.helpers.getIdFromNode(n),a.push({user_id:r,action:o[d].attrs.action});s={name:s.attrs.name,items:a},t(null,s),delete c.nodeStanzasCallbacks[l.id]},c.Client.send(h))},update:function(e,t){var n=this;n.getList(e.name,function(r,i){if(r)t(r,null);else{var s={};s.items=o.MergeArrayOfObjects(i.items,e.items),s.name=e.name,n.create(s,function(e,n){r?t(e,null):t(null,n)})}})},getNames:function(e){var t,n={type:"get",from:this.helpers.getUserCurrentJid(),id:i.getUniqueId("getNames")};o.getEnv().browser?(t=$iq(n).c("query",{xmlns:Strophe.NS.PRIVACY_LIST}),this.connection.sendIQ(t,function(t){for(var n=[],r=t.getElementsByTagName("default"),i=t.getElementsByTagName("active"),s=t.getElementsByTagName("list"),o=r&&r.length>0?r[0].getAttribute("name"):null,a=i&&i.length>0?i[0].getAttribute("name"):null,c=0,d=s.length;c<d;c++)n.push(s[c].getAttribute("name"));e(null,{default:o,active:a,names:n})},function(t){if(t){var n=i.getErrorFromXMLNode(t);e(n,null)}else e(o.getError(408),null)})):((t=new r.Stanza("iq",n)).c("query",{xmlns:i.MARKERS.PRIVACY}),this.nodeStanzasCallbacks[t.attrs.id]=function(t){if("error"!==t.attrs.type){for(var n=[],r=t.getChild("query"),i=r.getChild("default"),s=r.getChild("active"),a=r.getChildElements("list"),c=i?i.attrs.name:null,d=s?s.attrs.name:null,l=0,u=a.length;l<u;l++)n.push(a[l].attrs.name);e(null,{default:c,active:d,names:n})}else e(o.getError(408))},this.Client.send(t))},delete:function(e,t){var n,s={from:this.connection?this.connection.jid:this.Client.jid.user,type:"set",id:i.getUniqueId("remove")};o.getEnv().browser?(n=$iq(s).c("query",{xmlns:Strophe.NS.PRIVACY_LIST}).c("list",{name:e||""}),this.connection.sendIQ(n,function(e){t(null)},function(e){if(e){var n=i.getErrorFromXMLNode(e);t(n)}else t(o.getError(408))})):((n=new r.Stanza("iq",s)).c("query",{xmlns:i.MARKERS.PRIVACY}).c("list",{name:e||""}),this.nodeStanzasCallbacks[s.id]=function(e){e.getChildElements("error").length?t(o.getError(408)):t(null)},this.Client.send(n))},setAsDefault:function(e,t){var n,s=this,a={from:this.connection?this.connection.jid:this.Client.jid.user,type:"set",id:i.getUniqueId("default")};function c(n){var s,a={from:n.connection?n.connection.jid:n.Client.jid.user,type:"set",id:i.getUniqueId("active1")};o.getEnv().browser?(s=$iq(a).c("query",{xmlns:Strophe.NS.PRIVACY_LIST}).c("active",e&&e.length>0?{name:e}:{}),n.connection.sendIQ(s,function(e){t(null)},function(e){if(e){var n=i.getErrorFromXMLNode(e);t(n)}else t(o.getError(408))})):((s=new r.Stanza("iq",a)).c("query",{xmlns:i.MARKERS.PRIVACY}).c("active",e&&e.length>0?{name:e}:{}),n.nodeStanzasCallbacks[a.id]=function(e){e.getChildElements("error").length?t(o.getError(408)):t(null)},n.Client.send(s))}o.getEnv().browser?(n=$iq(a).c("query",{xmlns:Strophe.NS.PRIVACY_LIST}).c("default",e&&e.length>0?{name:e}:{}),this.connection.sendIQ(n,function(e){c(s)},function(e){if(e){var n=i.getErrorFromXMLNode(e);t(n)}else t(o.getError(408))})):((n=new r.Stanza("iq",a)).c("query",{xmlns:i.MARKERS.PRIVACY}).c("default",e&&e.length>0?{name:e}:{}),this.nodeStanzasCallbacks[a.id]=function(e){e.getChildElements("error").length?t(o.getError(408)):c(s)},this.Client.send(n))}},f.prototype={getUniqueId:i.getUniqueId,jidOrUserId:function(e){var t;if("string"==typeof e)t=e;else{if("number"!=typeof e)throw new Error('The method "jidOrUserId" may take jid or id');t=e+"-"+s.creds.appId+"@"+s.endpoints.chat}return t},typeChat:function(e){var t;if("string"==typeof e)t=e.indexOf("muc")>-1?"groupchat":"chat";else{if("number"!=typeof e)throw new Error(c);t="chat"}return t},getRecipientId:function(e,t){var n=null;return e.forEach(function(e){e!=t&&(n=e)}),n},getUserJid:function(e,t){return t?e+"-"+t+"@"+s.endpoints.chat:e+"-"+s.creds.appId+"@"+s.endpoints.chat},getUserNickWithMucDomain:function(e){return s.endpoints.muc+"/"+e},getIdFromNode:function(e){return e.indexOf("@")<0?null:parseInt(e.split("@")[0].split("-")[0])},getDialogIdFromNode:function(e){return e.indexOf("@")<0?null:e.split("@")[0].split("_")[1]},getRoomJidFromDialogId:function(e){return s.creds.appId+"_"+e+"@"+s.endpoints.muc},getRoomJid:function(e){return e+"/"+this.getIdFromNode(this._userCurrentJid)},getIdFromResource:function(e){var t=e.split("/");return t.length<2?null:(t.splice(0,1),parseInt(t.join("/")))},getRoomJidFromRoomFullJid:function(e){var t=e.split("/");return t.length<2?null:t[0]},getBsonObjectId:function(){return o.getBsonObjectId()},getUserIdFromRoomJid:function(e){var t=e.toString().split("/");return 0===t.length?null:t[t.length-1]},userCurrentJid:function(e){try{return e instanceof Strophe.Connection?e.jid:e.jid.user+"@"+e.jid._domain+"/"+e.jid._resource}catch(t){return e.jid.user+"@"+e.jid._domain+"/"+e.jid._resource}},getUserCurrentJid:function(){return this._userCurrentJid},setUserCurrentJid:function(e){this._userCurrentJid=e},getDialogJid:function(e){return e.indexOf("@")>0?e:this.getRoomJidFromDialogId(e)}},t.exports=l},{"../../plugins/streamManagement":42,"../../qbConfig":43,"../../qbStrophe":46,"../../qbUtils":47,"./qbChatHelpers":26}],26:[function(e,t,n){"use strict";var r=e("../../qbUtils"),i=e("../../qbConfig"),s="Unknown interface. SDK support browser / node env.";function o(e,t,n){var r=new Error(e,t,n);return r.name="ChatNotConnectedError",Object.setPrototypeOf(r,Object.getPrototypeOf(this)),Error.captureStackTrace&&Error.captureStackTrace(r,o),r}o.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(o,Error):o.__proto__=Error;var a={MARKERS:{CLIENT:"jabber:client",CHAT:"urn:xmpp:chat-markers:0",STATES:"http://jabber.org/protocol/chatstates",MARKERS:"urn:xmpp:chat-markers:0",CARBONS:"urn:xmpp:carbons:2",ROSTER:"jabber:iq:roster",MUC:"http://jabber.org/protocol/muc",PRIVACY:"jabber:iq:privacy",LAST:"jabber:iq:last"},ChatNotConnectedError:o,buildUserJid:function(e){var t;return"userId"in e?(t=e.userId+"-"+i.creds.appId+"@"+i.endpoints.chat,"resource"in e&&(t=t+"/"+e.resource)):"jid"in e&&(t=e.jid),t},createStanza:function(e,t,n){return r.getEnv().browser?e(t):new e(n||"message",t)},getAttr:function(e,t){var n;return e?("function"==typeof e.getAttribute?n=e.getAttribute(t):e.attrs&&(n=e.attrs[t]),n||null):null},getElement:function(e,t){var n;if("function"==typeof e.querySelector)n=e.querySelector(t);else{if("function"!=typeof e.getChild)throw s;n=e.getChild(t)}return n||null},getAllElements:function(e,t){var n;if("function"==typeof e.querySelectorAll)n=e.querySelectorAll(t);else{if("function"!=typeof e.getChild)throw s;n=e.getChild(t)}return n||null},getElementText:function(e,t){var n,r;if("function"==typeof e.querySelector)r=(n=e.querySelector(t))?n.textContent:null;else{if("function"!=typeof e.getChildText)throw s;r=e.getChildText(t)}return r||null},_JStoXML:function(e,t,n){var r=this;n.c(e),Object.keys(t).forEach(function(e){"object"==typeof t[e]?r._JStoXML(e,t[e],n):n.c(e).t(t[e]).up()}),n.up()},_XMLtoJS:function(e,t,n){e[t]={};for(var r=0,i=n.childNodes.length;r<i;r++)n.childNodes[r].childNodes.length>1?e[t]=this._XMLtoJS(e[t],n.childNodes[r].tagName,n.childNodes[r]):e[t][n.childNodes[r].tagName]=n.childNodes[r].textContent;return e},filledExtraParams:function(e,t){var n=this;return Object.keys(t).forEach(function(i){"attachments"===i?t[i].forEach(function(t){r.getEnv().browser?e.c("attachment",t).up():e.getChild("extraParams").c("attachment",t).up()}):"object"==typeof t[i]?n._JStoXML(i,t[i],e):r.getEnv().browser?e.c(i).t(t[i]).up():e.getChild("extraParams").c(i).t(t[i]).up()}),e.up(),e},parseExtraParams:function(e){if(!e)return null;var t,n,i,s={},o=[];if(r.getEnv().browser)for(var a=0,c=e.childNodes.length;a<c;a++)if("attachment"===e.childNodes[a].tagName){n={};for(var d=0,l=(i=e.childNodes[a].attributes).length;d<l;d++)"size"===i[d].name?n[i[d].name]=parseInt(i[d].value):n[i[d].name]=i[d].value;o.push(n)}else if("dialog_id"===e.childNodes[a].tagName)t=e.childNodes[a].textContent,s.dialog_id=t;else{if(e.childNodes[a].childNodes.length>1)if(e.childNodes[a].textContent.length>4096){for(var u="",h=0;h<e.childNodes[a].childNodes.length;++h)u+=e.childNodes[a].childNodes[h].textContent;s[e.childNodes[a].tagName]=u}else s=this._XMLtoJS(s,e.childNodes[a].tagName,e.childNodes[a]);else s[e.childNodes[a].tagName]=e.childNodes[a].textContent}else for(var p=0,f=e.children.length;p<f;p++){if("attachment"===e.children[p].name){n={},i=e.children[p].attrs;for(var m=Object.keys(i),g=0;g<m.length;g++)"size"===m[g]?n.size=parseInt(i.size):n[m[g]]=i[m[g]];o.push(n)}else"dialog_id"===e.children[p].name&&(t=e.getChildText("dialog_id"),s.dialog_id=t);if(1===e.children[p].children.length){var v=e.children[p];s[v.name]=v.children[0]}}return o.length>0&&(s.attachments=o),s.moduleIdentifier&&delete s.moduleIdentifier,{extension:s,dialogId:t}},getUniqueId:function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)});return"string"==typeof e||"number"==typeof e?t+":"+e:t+""},getErrorFromXMLNode:function(e){var t=this.getElement(e,"error"),n=parseInt(this.getAttr(t,"code")),i=this.getElementText(t,"text");return r.getError(n,i)},getLocalTime:function(){return(new Date).toTimeString().split(" ")[0]}};t.exports=a},{"../../qbConfig":43,"../../qbUtils":47}],27:[function(e,t,n){"use strict";var r=e("../../qbConfig"),i=e("../../qbUtils"),s=r.urls.chat+"/Dialog";function o(e){this.service=e}o.prototype={list:function(e,t){"function"==typeof e&&void 0===t&&(t=e,e={}),this.service.ajax({url:i.getUrl(s),data:e},t)},create:function(e,t){e&&e.occupants_ids&&i.isArray(e.occupants_ids)&&(e.occupants_ids=e.occupants_ids.join(", ")),this.service.ajax({url:i.getUrl(s),type:"POST",data:e},t)},update:function(e,t,n){this.service.ajax({url:i.getUrl(s,e),type:"PUT",contentType:"application/json; charset=utf-8",isNeedStringify:!0,data:t},n)},delete:function(e,t,n){var r={url:i.getUrl(s,e),type:"DELETE",dataType:"text"};2===arguments.length?this.service.ajax(r,t):3===arguments.length&&(r.data=t,this.service.ajax(r,n))}},t.exports=o},{"../../qbConfig":43,"../../qbUtils":47}],28:[function(e,t,n){"use strict";var r=e("../../qbConfig"),i=e("../../qbUtils"),s=r.urls.chat+"/Message";function o(e){this.service=e}o.prototype={list:function(e,t){this.service.ajax({url:i.getUrl(s),data:e},t)},create:function(e,t){this.service.ajax({url:i.getUrl(s),type:"POST",data:e},t)},update:function(e,t,n){var r={type:"PUT",dataType:"text",url:i.getUrl(s,e),data:t};this.service.ajax(r,n)},delete:function(e,t,n){var r={url:i.getUrl(s,e),type:"DELETE",dataType:"text"};2===arguments.length?this.service.ajax(r,t):3===arguments.length&&(r.data=t,this.service.ajax(r,n))},unreadCount:function(e,t){e&&e.chat_dialog_ids&&i.isArray(e.chat_dialog_ids)&&(e.chat_dialog_ids=e.chat_dialog_ids.join(", ")),this.service.ajax({url:i.getUrl(s+"/unread"),data:e},t)}},t.exports=o},{"../../qbConfig":43,"../../qbUtils":47}],29:[function(e,t,n){"use strict";var r=e("../qbUtils"),i=e("../qbConfig");function s(e){this.service=e}function o(e){return!!(e&&e.constructor&&e.call&&e.apply)}s.prototype={uploadAddressBook:function(e,t,n){if(Array.isArray(e)){var s,a;o(t)?a=t:(s=t,a=n);var c={contacts:e};s&&(s.force&&(c.force=s.force),s.udid&&(c.udid=s.udid)),this.service.ajax({type:"POST",url:r.getUrl(i.urls.addressbook),data:c,contentType:"application/json; charset=utf-8",isNeedStringify:!0},function(e,t){e?a(e,null):a(null,t)})}else new Error("First parameter must be an Array.")},_isFakeErrorEmptyAddressBook:function(e){var t=e.detail?e.detail:e.message.errors;return 404===e.code&&"Empty address book"===t[0]},get:function(e,t){var n,s,a=this;if(o(e)?s=e:(n=e,s=t),!o(s))throw new Error("The QB.addressbook.get accept callback function is required.");var c={type:"GET",url:r.getUrl(i.urls.addressbook),contentType:"application/json; charset=utf-8",isNeedStringify:!0};n&&(c.data={udid:n}),this.service.ajax(c,function(e,t){e?a._isFakeErrorEmptyAddressBook(e)?s(null,[]):s(e,null):s(null,t)})},getRegisteredUsers:function(e,t){var n,s,a=this;if(o(e)?s=e:(n=e,s=t),!o(s))throw new Error("The QB.addressbook.get accept callback function is required.");var c={type:"GET",url:r.getUrl(i.urls.addressbookRegistered),contentType:"application/json; charset=utf-8"};n&&(c.data={compact:1}),this.service.ajax(c,function(e,t){e?a._isFakeErrorEmptyAddressBook(e)?s(null,[]):s(e,null):s(null,t)})}},t.exports=s},{"../qbConfig":43,"../qbUtils":47}],30:[function(e,t,n){"use strict";var r=e("../qbConfig"),i=e("../qbUtils"),s=e("crypto-js/hmac-sha1"),o=e("crypto-js/hmac-sha256");function a(e){this.service=e}a.prototype={getSession:function(e){this.service.ajax({url:i.getUrl(r.urls.session)},function(t,n){e(t,t?null:n)})},createSession:function(e,t){if(""===r.creds.appId||""===r.creds.authKey||""===r.creds.authSecret)throw new Error("Cannot create a new session without app credentials (app ID, auth key and auth secret)");var n,a=this;"function"==typeof e&&void 0===t&&(t=e,e={}),(n=function(e){var t={application_id:r.creds.appId,auth_key:r.creds.authKey,nonce:i.randomNonce(),timestamp:i.unixTime()};e.login&&e.password?t.user={login:e.login,password:e.password}:e.email&&e.password?t.user={email:e.email,password:e.password}:e.provider&&(t.provider=e.provider,e.scope&&(t.scope=e.scope),e.keys&&e.keys.token&&(t.keys={token:e.keys.token}),e.keys&&e.keys.secret&&(t.keys.secret=e.keys.secret));return t}(e)).signature=function(e,t){var n,i=Object.keys(e).map(function(t){return"object"==typeof e[t]?Object.keys(e[t]).map(function(n){return t+"["+n+"]="+e[t][n]}).sort().join("&"):t+"="+e[t]}).sort().join("&");if("sha1"===r.hash)n=s(i,t).toString();else{if("sha256"!==r.hash)throw new Error("Quickblox SDK: unknown crypto standards, available sha1 or sha256");n=o(i,t).toString()}return n}(n,r.creds.authSecret),this.service.ajax({url:i.getUrl(r.urls.session),type:"POST",data:n},function(e,n){e?t(e,null):(a.service.setSession(n.session),t(null,n.session))})},destroySession:function(e){var t=this;this.service.ajax({url:i.getUrl(r.urls.session),type:"DELETE",dataType:"text"},function(n,r){n?e(n,null):(t.service.setSession(null),e(null,r))})},login:function(e,t){var n={type:"POST",url:i.getUrl(r.urls.login),data:e};this.service.ajax(n,function(e,n){e?t(e,null):t(null,n.user)})},logout:function(e){this.service.ajax({url:i.getUrl(r.urls.login),type:"DELETE",dataType:"text"},e)}},t.exports=a},{"../qbConfig":43,"../qbUtils":47,"crypto-js/hmac-sha1":2,"crypto-js/hmac-sha256":3}],31:[function(e,t,n){"use strict";var r=e("../qbConfig"),i=e("../qbUtils");function s(e){this.service=e}function o(e){for(var t=o.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),r={},i=14;i--;)r[t.key[i]]=n[i]||"";return r[t.q.name]={},r[t.key[12]].replace(t.q.parser,function(e,n,i){n&&(r[t.q.name][n]=i)}),r}s.prototype={list:function(e,t){"function"==typeof e&&void 0===t&&(t=e,e=null),this.service.ajax({url:i.getUrl(r.urls.blobs),data:e,type:"GET"},function(e,n){t(e,e?null:n)})},create:function(e,t){this.service.ajax({type:"POST",data:{blob:e},url:i.getUrl(r.urls.blobs)},function(e,n){t(e,e?null:n.blob)})},delete:function(e,t){this.service.ajax({url:i.getUrl(r.urls.blobs,e),type:"DELETE",dataType:"text"},function(e,n){e?t(e,null):t(null,!0)})},createAndUpload:function(e,t){var n,r,i,s,a,c=this,d={};JSON.parse(JSON.stringify(e)).file.data="...",n=e.file,r=e.name||n.name,i=e.type||n.type,s=e.size||n.size,d.name=r,d.content_type=i,e.public&&(d.public=e.public),e.tag_list&&(d.tag_list=e.tag_list),this.create(d,function(e,r){if(e)t(e,null);else{var i=o(r.blob_object_access.params),d={url:i.protocol+"://"+i.authority+i.path},l={};a=r.id,r.size=s,Object.keys(i.queryKey).forEach(function(e){l[e]=decodeURIComponent(i.queryKey[e])}),l.file=n,d.data=l,c.upload(d,function(e,n){e?t(e,null):c.markUploaded({id:a,size:s},function(e,n){e?t(e,null):t(null,r)})})}})},upload:function(e,t){var n={type:"POST",dataType:"text",contentType:!1,url:e.url,data:e.data};this.service.ajax(n,function(e,n){e?t(e,null):t(null,{})})},markUploaded:function(e,t){this.service.ajax({url:i.getUrl(r.urls.blobs,e.id+"/complete"),type:"PUT",data:{size:e.size},dataType:"text"},function(e,n){e?t(e,null):t(null,n)})},getInfo:function(e,t){this.service.ajax({url:i.getUrl(r.urls.blobs,e)},function(e,n){e?t(e,null):t(null,n)})},getFile:function(e,t){this.service.ajax({url:i.getUrl(r.urls.blobs,e)},function(e,n){e?t(e,null):t(null,n)})},update:function(e,t){var n={blob:{}};void 0!==e.name&&(n.blob.name=e.name),this.service.ajax({url:i.getUrl(r.urls.blobs,e.id),data:n},function(e,n){e?t(e,null):t(null,n)})},privateUrl:function(e){return"https://"+r.endpoints.api+"/blobs/"+e+"?token="+this.service.getSession().token},publicUrl:function(e){return"https://"+r.endpoints.api+"/blobs/"+e}},t.exports=s,o.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}}},{"../qbConfig":43,"../qbUtils":47}],32:[function(e,t,n){"use strict";var r=e("../qbConfig"),i=e("../qbUtils");function s(e){this.service=e}s.prototype={create:function(e,t,n){var s={type:"POST",data:t,isNeedStringify:!0,contentType:"application/json; charset=utf-8",url:i.getUrl(r.urls.data,e)};this.service.ajax(s,function(e,t){n(e,e?null:t)})},list:function(e,t,n){void 0===n&&"function"==typeof t&&(n=t,t=null),this.service.ajax({url:i.getUrl(r.urls.data,e),data:t},function(e,t){n(e,e?null:t)})},update:function(e,t,n){this.service.ajax({url:i.getUrl(r.urls.data,e+"/"+t._id),type:"PUT",contentType:"application/json; charset=utf-8",isNeedStringify:!0,data:t},function(e,t){n(e,e?null:t)})},delete:function(e,t,n){var s,o={id:1,ids:2,criteria:3},a={deleted:[],deletedCount:0},c={type:"DELETE",dataType:"text"};"string"==typeof t?s=o.id:i.isArray(t)?s=o.ids:i.isObject(t)&&(s=o.criteria),s===o.id?c.url=i.getUrl(r.urls.data,e+"/"+t):s===o.ids?c.url=i.getUrl(r.urls.data,e+"/"+t.toString()):s===o.criteria&&(c.url=i.getUrl(r.urls.data,e+"/by_criteria"),c.data=t),this.service.ajax(c,function(e,r){var i;e?n(e,null):(s===o.id?(a.deleted.push(t),a.deletedCount=a.deleted.length):s===o.ids?(i=JSON.parse(r),a.deleted=i.SuccessfullyDeleted.ids.slice(0),a.deletedCount=a.deleted.length):s===o.criteria&&(i=JSON.parse(r),a.deleted=null,a.deletedCount=i.total_deleted),n(e,a))})},uploadFile:function(e,t,n){var s={field_name:t.field_name,file:{data:t.file,name:t.name}};this.service.ajax({url:i.getUrl(r.urls.data,e+"/"+t.id+"/file"),type:"POST",fileToCustomObject:!0,contentType:!1,data:s},function(e,t){n(e,e?null:t)})},downloadFile:function(e,t,n){var s=i.getUrl(r.urls.data,e+"/"+t.id+"/file");n(null,s+="?field_name="+t.field_name+"&token="+this.service.getSession().token)},fileUrl:function(e,t){var n=i.getUrl(r.urls.data,e+"/"+t.id+"/file");return n+="?field_name="+t.field_name+"&token="+this.service.getSession().token},deleteFile:function(e,t,n){this.service.ajax({url:i.getUrl(r.urls.data,e+"/"+t.id+"/file"),data:{field_name:t.field_name},dataType:"text",type:"DELETE"},function(e,t){n(e,!e||null)})}},t.exports=s},{"../qbConfig":43,"../qbUtils":47}],33:[function(e,t,n){"use strict";var r=e("../qbConfig"),i=e("../qbUtils"),s="undefined"!=typeof window;function o(e){this.service=e}function a(e){this.service=e}o.prototype={create:function(e,t){this.service.ajax({url:i.getUrl(r.urls.subscriptions),type:"POST",data:e},t)},list:function(e){this.service.ajax({url:i.getUrl(r.urls.subscriptions)},e)},delete:function(e,t){var n={type:"DELETE",dataType:"text",url:i.getUrl(r.urls.subscriptions,e)};this.service.ajax(n,function(e,n){e?t(e,null):t(null,!0)})}},a.prototype={create:function(e,t){this.service.ajax({url:i.getUrl(r.urls.events),type:"POST",contentType:"application/json; charset=utf-8",isNeedStringify:!0,data:{event:e}},t)},list:function(e,t){"function"==typeof e&&void 0===t&&(t=e,e=null),this.service.ajax({url:i.getUrl(r.urls.events),data:e},t)},get:function(e,t){this.service.ajax({url:i.getUrl(r.urls.events,e)},t)},delete:function(e,t){this.service.ajax({url:i.getUrl(r.urls.events,e),dataType:"text",type:"DELETE"},t)},status:function(e,t){this.service.ajax({url:i.getUrl(r.urls.events,e+"/status")},t)}},t.exports=function(e){this.service=e,this.subscriptions=new o(e),this.events=new a(e),this.base64Encode=function(e){if(s)return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}}},{"../qbConfig":43,"../qbUtils":47}],34:[function(e,t,n){"use strict";var r=e("../qbConfig"),i=e("../qbUtils"),s=["created_at","updated_at","last_request_at"],o=["id","external_user_id"],a=r.urls.users+"/password/reset";function c(e){this.service=e}function d(e){var t=e.field in s?"date":typeof e.value;return i.isArray(e.value)&&("object"===t&&(t=typeof e.value[0]),e.value=e.value.toString()),[t,e.field,e.param,e.value].join(" ")}c.prototype={listUsers:function(e,t){var n,a,c,l={},u=[];"function"==typeof e&&void 0===t&&(t=e,e={}),e&&e.filter&&(i.isArray(e.filter)?e.filter.forEach(function(e){n=d(e),u.push(n)}):(n=d(e.filter),u.push(n)),l.filter=u),e.order&&(l.order=(a=e.order,c=a.field in s?"date":a.field in o?"number":"string",[a.sort,c,a.field].join(" "))),e.page&&(l.page=e.page),e.per_page&&(l.per_page=e.per_page),this.service.ajax({url:i.getUrl(r.urls.users),data:l},t)},get:function(e,t){var n;"number"==typeof e?(n=e,e={}):e.login?n="by_login":e.full_name?n="by_full_name":e.facebook_id?n="by_facebook_id":e.twitter_id?n="by_twitter_id":e.phone?n="phone":e.email?n="by_email":e.tags?n="by_tags":e.external&&(n="external/"+e.external,e={}),this.service.ajax({url:i.getUrl(r.urls.users,n),data:e},function(e,n){e?t(e,null):t(null,n.user||n)})},create:function(e,t){this.service.ajax({url:i.getUrl(r.urls.users),type:"POST",data:{user:e}},function(e,n){e?t(e,null):t(null,n.user)})},update:function(e,t,n){this.service.ajax({url:i.getUrl(r.urls.users,e),type:"PUT",data:{user:t}},function(e,t){e?n(e,null):n(null,t.user)})},delete:function(e,t){var n;"number"==typeof e?n=e:e.external&&(n="external/"+e.external),this.service.ajax({url:i.getUrl(r.urls.users,n),type:"DELETE",dataType:"text"},t)},resetPassword:function(e,t){this.service.ajax({url:i.getUrl(a),data:{email:e},dataType:"text"},t)}},t.exports=c},{"../qbConfig":43,"../qbUtils":47}],35:[function(e,t,n){"use strict";var r=e("../../qbConfig"),i=e("./qbWebRTCHelpers"),s=e("sdp-transform"),o=window.RTCPeerConnection,a=window.RTCSessionDescription,c=window.RTCIceCandidate;function d(e,t,n){if(!n)return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"");for(var r=e.split("\n"),s=-1,o=i.getVersionFirefox()?"TIAS":"AS",a=i.getVersionFirefox()?1024*n:n,c=0;c<r.length;c++)if(0===r[c].indexOf("m="+t)){s=c;break}if(-1===s)return e;for(s++;0===r[s].indexOf("i=")||0===r[s].indexOf("c=");)s++;if(0===r[s].indexOf("b"))return r[s]="b="+o+":"+a,r.join("\n");var d=r.slice(0,s);return d.push("b="+o+":"+a),(d=d.concat(r.slice(s,r.length))).join("\n")}o.State={NEW:1,CONNECTING:2,CHECKING:3,CONNECTED:4,DISCONNECTED:5,FAILED:6,CLOSED:7,COMPLETED:8},o.prototype._init=function(e,t,n,r){i.trace("RTCPeerConnection init. userID: "+t+", sessionID: "+n+", type: "+r),this.delegate=e,this.sessionID=n,this.userID=t,this.type=r,this.remoteSDP=null,this.ice=[],this.state=o.State.NEW,this.onicecandidate=this.onIceCandidateCallback.bind(this),this.onsignalingstatechange=this.onSignalingStateCallback.bind(this),this.oniceconnectionstatechange=this.onIceConnectionStateCallback.bind(this),i.getVersionSafari()>=11?(this.remoteStream=new MediaStream,this.ontrack=this.onAddRemoteMediaCallback.bind(this),this.onStatusClosedChecker=void 0):(this.remoteStream=null,this.onaddstream=this.onAddRemoteMediaCallback.bind(this)),this.dialingTimer=null,this.answerTimeInterval=0,this.statsReportTimer=null,this.iceCandidates=[]},o.prototype.release=function(){var e=this;if(this._clearDialingTimer(),this._clearStatsReportTimer(),"closed"!==this.connectionState){var t={LocalStreams:e.getLocalStreams(),RemoteStreams:e.getRemoteStreams().concat([this.remoteStream]).concat([this.stream])};this.remoteStreams&&this.remoteStreams.length>0&&(t.RemoteStreams=t.RemoteStreams.concat(this.remoteStreams)),Object.keys(t).forEach(function(n){t[n].forEach(function(t,r,i){t&&t.getTracks&&t.getTracks().forEach(function(t){if("RemoteStreams"===n&&t.stop(),e.removeTrack){var r=e.getSenders().find(function(e){return e.track==t});void 0!==r&&e.removeTrack(r)}}),e.removeStream&&"object"==typeof t&&t instanceof MediaStream?e.removeStream(t):i[r]=null})}),this.close(),navigator.userAgent.indexOf("Edge")>-1&&(this.connectionState="closed",this.iceConnectionState="closed")}(i.getVersionSafari()>=11||navigator.userAgent.indexOf("Edge")>-1)&&this.onIceConnectionStateCallback()},o.prototype.updateRemoteSDP=function(e){if(!e)throw new Error("sdp string can't be empty.");this.remoteSDP=e},o.prototype.getRemoteSDP=function(){return this.remoteSDP},o.prototype.setRemoteSessionDescription=function(e,t,n){var r,s=this,o=i.getVersionFirefox();r=null===o||56!==o&&57!==o||s.delegate.bandwidth?d(t,"video",s.delegate.bandwidth):d(t,"video",12288);var c=new a({sdp:r,type:e});s.setRemoteDescription(c).then(function(e){s.ice.length>0&&s.addCandidates(),n(null)},function(e){n(e)})},o.prototype.addLocalStream=function(e){if(!e)throw new Error("'RTCPeerConnection.addStream' error: stream is 'null'.");this.addStream(e)},o.prototype.getAndSetLocalSessionDescription=function(e,t){var n=this;function r(r){var o,c,d=i.getVersionFirefox();null!==d&&d<55&&2===e&&"offer"===n.type&&(r.sdp=(o=r.sdp,(c=s.parse(o)).groups=c.groups?c.groups:[],c.groups.push({mids:"sdparta_0",type:"BUNDLE"}),s.write(c))),n.setLocalDescription(r).then(function(){t(null)}).catch(function(e){a(e)})}function a(e){t(e)}n.state=o.State.CONNECTING,"offer"===n.type?n.createOffer().then(function(e){e.sdp=d(e.sdp,"video",n.delegate.bandwidth),r(e)}).catch(function(e){a(e)}):n.createAnswer().then(function(e){e.sdp=d(e.sdp,"video",n.delegate.bandwidth),r(e)}).catch(function(e){a(e)})},o.prototype._addIceCandidate=function(e){this.addIceCandidate(new c({sdpMLineIndex:e.sdpMLineIndex,sdpMid:e.sdpMid,candidate:e.candidate}),function(){},function(e){i.traceError("Error on 'addIceCandidate': "+e)})},o.prototype.addCandidates=function(e){var t=this;e&&e.length>0&&(e=e.filter(e=>-1===t.ice.indexOf(e)),t.ice=t.ice.concat(e)),t.remoteDescription&&t.remoteDescription.type&&t.ice.forEach(function(e,n){t._addIceCandidate(e),delete t.ice[n]})},o.prototype.toString=function(){return"sessionID: "+this.sessionID+", userID:  "+this.userID+", type: "+this.type+", state: "+this.state},o.prototype.onSignalingStateCallback=function(){"stable"===this.signalingState&&this.iceCandidates.length>0&&(this.delegate.processIceCandidates(this,this.iceCandidates),this.iceCandidates.length=0)},o.prototype.onIceCandidateCallback=function(e){var t=e.candidate;if(t){var n={sdpMLineIndex:t.sdpMLineIndex,sdpMid:t.sdpMid,candidate:t.candidate};"stable"===this.signalingState?this.delegate.processIceCandidates(this,[n]):this.iceCandidates.push(n)}},o.prototype.onAddRemoteMediaCallback=function(e){"function"==typeof this.delegate._onRemoteStreamListener&&("addstream"===e.type?this.remoteStream=e.stream:this.remoteStream.addTrack(e.track),(1==this.delegate.callType&&this.remoteStream.getVideoTracks().length||2==this.delegate.callType&&this.remoteStream.getAudioTracks().length)&&this.delegate._onRemoteStreamListener(this.userID,this.remoteStream),this._getStatsWrap())},o.prototype.onIceConnectionStateCallback=function(){i.trace("onIceConnectionStateCallback: "+this.iceConnectionState);var e=this;if("function"==typeof this.delegate._onSessionConnectionStateChangedListener){var t=null;switch(i.getVersionSafari()>=11&&clearTimeout(this.onStatusClosedChecker),this.iceConnectionState){case"checking":this.state=o.State.CHECKING,t=i.SessionConnectionState.CONNECTING;break;case"connected":this._clearWaitingReconnectTimer(),this.state=o.State.CONNECTED,t=i.SessionConnectionState.CONNECTED;break;case"completed":this._clearWaitingReconnectTimer(),this.state=o.State.COMPLETED,t=i.SessionConnectionState.COMPLETED;break;case"failed":this.state=o.State.FAILED,t=i.SessionConnectionState.FAILED;break;case"disconnected":this._startWaitingReconnectTimer(),this.state=o.State.DISCONNECTED,t=i.SessionConnectionState.DISCONNECTED,i.getVersionSafari()>=11&&(this.onStatusClosedChecker=setTimeout(function(){e.onIceConnectionStateCallback()},500));break;case"closed":this._clearWaitingReconnectTimer(),this.state=o.State.CLOSED,t=i.SessionConnectionState.CLOSED}t&&e.delegate._onSessionConnectionStateChangedListener(this.userID,t)}},o.prototype._clearStatsReportTimer=function(){this.statsReportTimer&&(clearInterval(this.statsReportTimer),this.statsReportTimer=null)},o.prototype._getStatsWrap=function(){var e,t,n=this;if(r.webrtc&&r.webrtc.statsReportTimeInterval){if(isNaN(+r.webrtc.statsReportTimeInterval))return void i.traceError("statsReportTimeInterval ("+r.webrtc.statsReportTimeInterval+") must be integer.");e=1e3*r.webrtc.statsReportTimeInterval;i.trace("Stats tracker has been started."),n.statsReportTimer=setInterval(function(){!function(e,t,n,r){var s={local:{audio:{},video:{},candidate:{}},remote:{audio:{},video:{},candidate:{}}};if(i.getVersionFirefox()){var o=e.getLocalStreams().length?e.getLocalStreams()[0]:e.delegate.localStream,a=o.getVideoTracks().length?o.getVideoTracks()[0].getSettings():null;s.local.video.frameHeight=a&&a.height,s.local.video.frameWidth=a&&a.width}function c(e,t,n){var r,i=t&&t.get(e.id),s=i?(e.timestamp-i.timestamp)/1e3:5;return r=i?n?8*(e.bytesSent-i.bytesSent)/(1024*s):8*(e.bytesReceived-i.bytesReceived)/(1024*s):0,Math.round(r)}function d(e,t,n){var r,i=t&&t.get(e.id),s=i?(e.timestamp-i.timestamp)/1e3:5;return r=i?n?(e.framesSent-i.framesSent)/s:(e.framesReceived-i.framesReceived)/s:0,Math.round(10*r)/10}e.getStats(null).then(function(e){e.forEach(function(e){var n;e.bytesReceived&&"inbound-rtp"===e.type?((n=s.remote[e.mediaType]).bitrate=c(e,t,!1),n.bytesReceived=e.bytesReceived,n.packetsReceived=e.packetsReceived,n.timestamp=e.timestamp,"video"===e.mediaType&&e.framerateMean&&(n.framesPerSecond=Math.round(10*e.framerateMean)/10)):e.bytesSent&&"outbound-rtp"===e.type?((n=s.local[e.mediaType]).bitrate=c(e,t,!0),n.bytesSent=e.bytesSent,n.packetsSent=e.packetsSent,n.timestamp=e.timestamp,"video"===e.mediaType&&e.framerateMean&&(n.framesPerSecond=Math.round(10*e.framerateMean)/10)):"local-candidate"===e.type?(n=s.local.candidate,"host"===e.candidateType&&"udp"===e.mozLocalTransport&&"udp"===e.transport?(n.protocol=e.transport,n.ip=e.ipAddress,n.port=e.portNumber):i.getVersionFirefox()||(n.protocol=e.protocol,n.ip=e.ip,n.port=e.port)):"remote-candidate"===e.type?((n=s.remote.candidate).protocol=e.protocol||e.transport,n.ip=e.ip||e.ipAddress,n.port=e.port||e.portNumber):"track"!==e.type||"video"!==e.kind||i.getVersionFirefox()||(e.remoteSource?((n=s.remote.video).frameHeight=e.frameHeight,n.frameWidth=e.frameWidth,n.framesPerSecond=d(e,t,!1)):((n=s.local.video).frameHeight=e.frameHeight,n.frameWidth=e.frameWidth,n.framesPerSecond=d(e,t,!0)))}),n(s,e)},r)}(n,t,function(e,r){t=r,n.delegate._onCallStatsReport(n.userID,e,null)},function(e){i.traceError("_getStats error. "+e.name+": "+e.message),n.delegate._onCallStatsReport(n.userID,null,e)})},e)}},o.prototype._clearWaitingReconnectTimer=function(){this.waitingReconnectTimeoutCallback&&(i.trace("_clearWaitingReconnectTimer"),clearTimeout(this.waitingReconnectTimeoutCallback),this.waitingReconnectTimeoutCallback=null)},o.prototype._startWaitingReconnectTimer=function(){var e=this,t=1e3*r.webrtc.disconnectTimeInterval;i.trace("_startWaitingReconnectTimer, timeout: "+t),e.waitingReconnectTimeoutCallback||(e.waitingReconnectTimeoutCallback=setTimeout(function(){i.trace("waitingReconnectTimeoutCallback"),clearTimeout(e.waitingReconnectTimeoutCallback),e.release(),e.delegate._closeSessionIfAllConnectionsClosed()},t))},o.prototype._clearDialingTimer=function(){this.dialingTimer&&(i.trace("_clearDialingTimer"),clearInterval(this.dialingTimer),this.dialingTimer=null,this.answerTimeInterval=0)},o.prototype._startDialingTimer=function(e,t){var n=this,s=1e3*r.webrtc.dialingTimeInterval;i.trace("_startDialingTimer, dialingTimeInterval: "+s);var o=function(e,t,s){s||(n.answerTimeInterval+=1e3*r.webrtc.dialingTimeInterval),i.trace("_dialingCallback, answerTimeInterval: "+n.answerTimeInterval),n.answerTimeInterval>=1e3*r.webrtc.answerTimeInterval?(n._clearDialingTimer(),t&&n.delegate.processOnNotAnswer(n)):n.delegate.processCall(n,e)};n.dialingTimer=setInterval(o,s,e,t,!1),o(e,t,!0)},t.exports=o},{"../../qbConfig":43,"./qbWebRTCHelpers":37,"sdp-transform":9}],36:[function(e,t,n){"use strict";var r=e("./qbWebRTCSession"),i=e("./qbWebRTCSignalingProcessor"),s=e("./qbWebRTCSignalingProvider"),o=e("./qbWebRTCHelpers"),a=e("./qbRTCPeerConnection"),c=e("./qbWebRTCSignalingConstants"),d=e("../../qbUtils"),l=e("../../qbConfig");function u(e,t){this.connection=t,this.signalingProcessor=new i(e,this,t),this.signalingProvider=new s(e,t),this.SessionConnectionState=o.SessionConnectionState,this.CallType=o.CallType,this.PeerConnectionState=a.State,this.sessions={},navigator.mediaDevices&&"ondevicechange"in navigator.mediaDevices&&(navigator.mediaDevices.ondevicechange=this._onDevicesChangeListener.bind(this))}u.prototype.getMediaDevices=function(e){var t=[],n="Browser does not support output device selection.";return new Promise(function(r,i){navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(n){e?(n.forEach(function(n,r){n.kind===e&&t.push(n)}),r(t)):r(n)}):(i(n),o.traceWarning(n))})},u.prototype.sessions={},u.prototype.createNewSession=function(e,t,n,i){var s=function(e){var t=[];Object.keys(e).length>0&&Object.keys(e).forEach(function(n,i,s){var o=e[n];o.state!==r.State.NEW&&o.state!==r.State.ACTIVE||t.push(o.opponentsIDs)});return t}(this.sessions),a=n||o.getIdFromNode(this.connection.jid),c=i&&i.bandwidth&&!isNaN(i.bandwidth)?+i.bandwidth:0,d=t||2;if(!e)throw new Error("Can't create a session without the opponentsIDs.");if(function(e,t){var n=!1,r=t.sort();e.length&&e.forEach(function(e){var t=e.sort();n=t.length==r.length&&t.every(function(e,t){return e===r[t]})});return n}(s,e))throw new Error("Can't create a session with the same opponentsIDs. There is a session already in NEW or ACTIVE state.");return this._createAndStoreSession(null,a,e,d,c)},u.prototype._createAndStoreSession=function(e,t,n,i,s){var a=new r({sessionID:e,initiatorID:t,opIDs:n,callType:i,signalingProvider:this.signalingProvider,currentUserID:o.getIdFromNode(this.connection.jid),bandwidth:s});return a.onUserNotAnswerListener=this.onUserNotAnswerListener,a.onRemoteStreamListener=this.onRemoteStreamListener,a.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,a.onSessionCloseListener=this.onSessionCloseListener,a.onCallStatsReport=this.onCallStatsReport,this.sessions[a.ID]=a,a},u.prototype.clearSession=function(e){delete u.sessions[e]},u.prototype.isExistNewOrActiveSessionExceptSessionID=function(e){var t=!1,n=this.sessions;return Object.keys(n).length>0&&(t=Object.keys(n).some(function(t){var i=n[t];return(i.state===r.State.NEW||i.state===r.State.ACTIVE)&&i.ID!==e})),t},u.prototype.getNewSessionsCount=function(e){var t=this.sessions;return Object.keys(t).reduce(function(n,i){var s=t[i];return s.ID===e?n:s.state===r.State.NEW?n+1:n},0)},u.prototype._onCallListener=function(e,t,n){var r=n.userInfo||{};o.trace("onCall. UserID:"+e+". SessionID: "+t);var i=this.isExistNewOrActiveSessionExceptSessionID(t),s=this.getNewSessionsCount(t);if(i&&!this.sessions[t]&&s++,i&&(l.webrtc.autoReject||s>l.webrtc.incomingLimit))o.trace("User with id "+e+" is busy at the moment."),delete n.sdp,delete n.platform,n.sessionID=t,this.signalingProvider.sendMessage(e,n,c.SignalingType.REJECT),"function"==typeof this.onInvalidEventsListener&&d.safeCallbackCall(this.onInvalidEventsListener,"onCall",t,e,r);else{var a=this.sessions[t],u=+r.bandwidth||0;a||(a=this._createAndStoreSession(t,n.callerID,n.opponentsIDs,n.callType,u),"function"==typeof this.onCallListener&&d.safeCallbackCall(this.onCallListener,a,r)),a.processOnCall(e,n)}},u.prototype._onAcceptListener=function(e,t,n){var i=this.sessions[t],s=n.userInfo||{};o.trace("onAccept. UserID:"+e+". SessionID: "+t),i?i.state===r.State.ACTIVE?("function"==typeof this.onAcceptCallListener&&d.safeCallbackCall(this.onAcceptCallListener,i,e,s),i.processOnAccept(e,n)):("function"==typeof this.onInvalidEventsListener&&d.safeCallbackCall(this.onInvalidEventsListener,"onAccept",i,e,s),o.traceWarning("Ignore 'onAccept', the session( "+t+" ) has invalid state.")):o.traceError("Ignore 'onAccept', there is no information about session "+t+" by some reason.")},u.prototype._onRejectListener=function(e,t,n){var r=this.sessions[t];if(o.trace("onReject. UserID:"+e+". SessionID: "+t),r){var i=n.userInfo||{};"function"==typeof this.onRejectCallListener&&d.safeCallbackCall(this.onRejectCallListener,r,e,i),r.processOnReject(e,n)}else o.traceError("Ignore 'onReject', there is no information about session "+t+" by some reason.")},u.prototype._onStopListener=function(e,t,n){o.trace("onStop. UserID:"+e+". SessionID: "+t);var i=this.sessions[t],s=n.userInfo||{};!i||i.state!==r.State.ACTIVE&&i.state!==r.State.NEW?("function"==typeof this.onInvalidEventsListener&&d.safeCallbackCall(this.onInvalidEventsListener,"onStop",i,e,s),o.traceError("Ignore 'onStop', there is no information about session "+t+" by some reason.")):("function"==typeof this.onStopCallListener&&d.safeCallbackCall(this.onStopCallListener,i,e,s),setTimeout(i.processOnStop.bind(i),10,e,n))},u.prototype._onIceCandidatesListener=function(e,t,n){var i=this.sessions[t];o.trace("onIceCandidates. UserID:"+e+". SessionID: "+t+". ICE candidates count: "+n.iceCandidates.length),i?i.state===r.State.ACTIVE?i.processOnIceCandidates(e,n):o.traceWarning("Ignore 'OnIceCandidates', the session ( "+t+" ) has invalid state."):o.traceError("Ignore 'OnIceCandidates', there is no information about session "+t+" by some reason.")},u.prototype._onUpdateListener=function(e,t,n){var r=this.sessions[t],i=n.userInfo||{};o.trace("onUpdate. UserID:"+e+". SessionID: "+t+". Extension: "+JSON.stringify(i)),"function"==typeof this.onUpdateCallListener&&d.safeCallbackCall(this.onUpdateCallListener,r,e,i)},u.prototype._onDevicesChangeListener=function(){"function"==typeof this.onDevicesChangeListener&&d.safeCallbackCall(this.onDevicesChangeListener)},t.exports=u},{"../../qbConfig":43,"../../qbUtils":47,"./qbRTCPeerConnection":35,"./qbWebRTCHelpers":37,"./qbWebRTCSession":38,"./qbWebRTCSignalingConstants":39,"./qbWebRTCSignalingProcessor":40,"./qbWebRTCSignalingProvider":41}],37:[function(e,t,n){"use strict";var r=e("../../qbConfig"),i={};(i={getUserJid:function(e,t){return e+"-"+t+"@"+r.endpoints.chat},getIdFromNode:function(e){return e.indexOf("@")<0?null:parseInt(e.split("@")[0].split("-")[0])},trace:function(e){r.debug&&console.log("[QBWebRTC]:",e)},traceWarning:function(e){r.debug&&console.warn("[QBWebRTC]:",e)},traceError:function(e){r.debug&&console.error("[QBWebRTC]:",e)},getLocalTime:function(){return(new Date).toString().split(" ").slice(1,5).join("-")},dataURItoBlob:function(e,t){for(var n=[],r=window.atob(e.split(",")[1]),i=0,s=r.length;i<s;i++)n.push(r.charCodeAt(i));return new Blob([new Uint8Array(n)],{type:t})},getVersionFirefox:function(){var e,t=!!navigator&&navigator.userAgent;if(t){var n=t.match(/(?:firefox)[ \/](\d+)/i)||[];e=n[1]?+n[1]:null}return e},getVersionSafari:function(){var e,t=!!navigator&&navigator.userAgent;if(t)if((t.match(/(?:safari)[ \/](\d+)/i)||[]).length){var n=t.match(/(?:version)[ \/](\d+)/i)||[];e=n&&n[1]?+n[1]:null}else e=null;return e}}).SessionConnectionState={UNDEFINED:0,CONNECTING:1,CONNECTED:2,FAILED:3,DISCONNECTED:4,CLOSED:5,COMPLETED:6},i.CallType={VIDEO:1,AUDIO:2},t.exports=i},{"../../qbConfig":43}],38:[function(e,t,n){"use strict";var r=e("../../qbConfig"),i=e("./qbRTCPeerConnection"),s=e("../../qbUtils"),o=e("./qbWebRTCHelpers"),a=e("./qbWebRTCSignalingConstants");function c(e){var t;this.ID=e.sessionID?e.sessionID:(t=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)})),this.state=c.State.NEW,this.initiatorID=parseInt(e.initiatorID),this.opponentsIDs=e.opIDs,this.callType=parseInt(e.callType),this.peerConnections={},this.localStream=null,this.mediaParams=null,this.signalingProvider=e.signalingProvider,this.currentUserID=e.currentUserID,this.bandwidth=e.bandwidth,this.answerTimer=null,this.startCallTime=0,this.acceptCallTime=0}function d(e){var t={};try{if("[object Object]"!=={}.toString.call(e))throw new Error('Invalid type of "extension" object.');t.userInfo=e,t=JSON.parse(JSON.stringify(t).replace(/null/g,'""'))}catch(e){o.traceWarning(e.message)}return t}c.State={NEW:1,ACTIVE:2,HUNGUP:3,REJECTED:4,CLOSED:5},c.prototype.getUserMedia=function(e,t){if(!navigator.mediaDevices.getUserMedia)throw new Error("getUserMedia() is not supported in your browser");var n=this;navigator.mediaDevices.getUserMedia({audio:e.audio||!1,video:e.video||!1}).then(function(r){n.localStream=r,n.mediaParams=e,e.elemId&&n.attachMediaStream(e.elemId,r,e.options),t(null,r)}).catch(function(e){t(e,null)})},c.prototype.connectionStateForUser=function(e){var t=this.peerConnections[e];return t?t.state:null},c.prototype.attachMediaStream=function(e,t,n){var r=document.getElementById(e);if(!r)throw new Error("Unable to attach media stream, element "+e+" is undefined");"object"==typeof r.srcObject?r.srcObject=t:r.src=window.URL.createObjectURL(t),n&&n.muted&&(r.muted=!0),n&&n.mirror&&(r.style.webkitTransform="scaleX(-1)",r.style.transform="scaleX(-1)"),r.onloadedmetadata=function(e){r.play()}},c.prototype.detachMediaStream=function(e){var t=document.getElementById(e);t&&(t.pause(),t.srcObject&&"object"==typeof t.srcObject?(t.srcObject.getTracks().forEach(function(e){e.stop(),e.enabled=!1}),t.srcObject=null):t.src="",t.removeAttribute("src"),t.removeAttribute("srcObject"))},c.prototype.switchMediaTracks=function(e,t){if(!navigator.mediaDevices.getUserMedia)throw new Error("getUserMedia() is not supported in your browser");var n=this,r=this.localStream;e&&e.audio&&(n.mediaParams.audio.deviceId=e.audio),e&&e.video&&(n.mediaParams.video.deviceId=e.video),r.getTracks().forEach(function(e){e.stop()}),navigator.mediaDevices.getUserMedia({audio:n.mediaParams.audio||!1,video:n.mediaParams.video||!1}).then(function(e){n._replaceTracks(e),t(null,e)}).catch(function(e){t(e,null)})},c.prototype._replaceTracks=function(e){var t=this.peerConnections,n=this.localStream,r=this.mediaParams.elemId,i=this.mediaParams.options,s=e.getTracks();for(var o in this.detachMediaStream(r),s.forEach(function(e){n.addTrack(e)}),this.attachMediaStream(r,e,i),t)t[o].getSenders().map(function(e){e.replaceTrack(s.find(function(t){return t.kind===e.track.kind}))})},c.prototype.call=function(e,t){var n=this,r=d(e);o.trace("Call, extension: "+JSON.stringify(r.userInfo)),n.state=c.State.ACTIVE,n.opponentsIDs.forEach(function(e,t,i){n._callInternal(e,r,!0)}),"function"==typeof t&&t(null)},c.prototype._callInternal=function(e,t,n){var r=this,i=r._createPeer(e,"offer"),s=o.getVersionSafari();s&&s>=11?r.localStream.getTracks().forEach(function(e){i.addTrack(e,r.localStream)}):i.addLocalStream(r.localStream),this.peerConnections[e]=i,i.getAndSetLocalSessionDescription(this.callType,function(e){e?o.trace("getAndSessionDescription error: "+e):(o.trace("getAndSessionDescription success"),i._startDialingTimer(t,n))})},c.prototype.accept=function(e){var t=this,n=d(e);if(o.trace("Accept, extension: "+JSON.stringify(n.userInfo)),t.state!==c.State.ACTIVE){if(t.state===c.State.CLOSED)return o.traceError("Can't accept, the session is already closed, return."),void t.stop({});t.state=c.State.ACTIVE,t.acceptCallTime=new Date,t._clearAnswerTimer(),t._acceptInternal(t.initiatorID,n);var r=t._uniqueOpponentsIDsWithoutInitiator();if(r.length>0){var i=(t.acceptCallTime-t.startCallTime)/1e3;t._startWaitingOfferOrAnswerTimer(i),r.forEach(function(e,n,r){t.currentUserID>e&&t._callInternal(e,{},!0)})}}else o.traceError("Can't accept, the session is already active, return.")},c.prototype._acceptInternal=function(e,t){var n=this,r=this.peerConnections[e];if(r){var i=o.getVersionSafari();i&&i>=11?n.localStream.getTracks().forEach(function(e){r.addTrack(e,n.localStream)}):r.addLocalStream(n.localStream),r.setRemoteSessionDescription("offer",r.getRemoteSDP(),function(i){i?o.traceError("'setRemoteSessionDescription' error: "+i):(o.trace("'setRemoteSessionDescription' success"),r.getAndSetLocalSessionDescription(n.callType,function(i){i?o.trace("getAndSetLocalSessionDescription error: "+i):(t.sessionID=n.ID,t.callType=n.callType,t.callerID=n.initiatorID,t.opponentsIDs=n.opponentsIDs,t.sdp=r.localDescription.sdp,n.signalingProvider.sendMessage(e,t,a.SignalingType.ACCEPT))}))})}else o.traceError("Can't accept the call, there is no information about peer connection by some reason.")},c.prototype.reject=function(e){var t=d(e),n=Object.keys(this.peerConnections).length;if(o.trace("Reject, extension: "+JSON.stringify(t.userInfo)),this.state=c.State.REJECTED,this._clearAnswerTimer(),t.sessionID=this.ID,t.callType=this.callType,t.callerID=this.initiatorID,t.opponentsIDs=this.opponentsIDs,n>0)for(var r in this.peerConnections){var i=this.peerConnections[r];this.signalingProvider.sendMessage(i.userID,t,a.SignalingType.REJECT)}this._close()},c.prototype.stop=function(e){var t=d(e),n=Object.keys(this.peerConnections).length;if(o.trace("Stop, extension: "+JSON.stringify(t.userInfo)),this.state=c.State.HUNGUP,this.answerTimer&&this._clearAnswerTimer(),t.sessionID=this.ID,t.callType=this.callType,t.callerID=this.initiatorID,t.opponentsIDs=this.opponentsIDs,n>0)for(var r in this.peerConnections){var i=this.peerConnections[r];this.signalingProvider.sendMessage(i.userID,t,a.SignalingType.STOP)}this._close()},c.prototype.closeConnection=function(e){var t=this.peerConnections[e];if(!t)return o.traceWarn("Not found connection with user ("+e+")"),!1;try{t.release()}catch(e){o.traceError(e)}finally{this._closeSessionIfAllConnectionsClosed()}},c.prototype.update=function(e){var t={};if(o.trace("Update, extension: "+JSON.stringify(e)),null!==e)for(var n in(t=d(e)).sessionID=this.ID,this.peerConnections){var r=this.peerConnections[n];this.signalingProvider.sendMessage(r.userID,t,a.SignalingType.PARAMETERS_CHANGED)}else o.trace("extension is null, no parameters to update")},c.prototype.mute=function(e){this._muteStream(0,e)},c.prototype.unmute=function(e){this._muteStream(1,e)},c.prototype.processOnCall=function(e,t){var n=this;n._uniqueOpponentsIDs().forEach(function(r,i,s){var o,a=n.peerConnections[r];a?r==e&&(a.updateRemoteSDP(t.sdp),e!=n.initiatorID&&n.state===c.State.ACTIVE&&n._acceptInternal(e,{})):(o=r!=e&&n.currentUserID>r?n._createPeer(r,"offer"):n._createPeer(r,"answer"),n.peerConnections[r]=o,r==e&&(o.updateRemoteSDP(t.sdp),n._startAnswerTimer()))})},c.prototype.processOnAccept=function(e,t){var n=this.peerConnections[e];n?(n._clearDialingTimer(),n.setRemoteSessionDescription("answer",t.sdp,function(e){e?o.traceError("'setRemoteSessionDescription' error: "+e):o.trace("'setRemoteSessionDescription' success")})):o.traceError("Ignore 'OnAccept', there is no information about peer connection by some reason.")},c.prototype.processOnReject=function(e,t){var n=this.peerConnections[e];this._clearWaitingOfferOrAnswerTimer(),n?n.release():o.traceError("Ignore 'OnReject', there is no information about peer connection by some reason."),this._closeSessionIfAllConnectionsClosed()},c.prototype.processOnStop=function(e,t){this._clearAnswerTimer();var n=this.peerConnections[e];n?n.release():o.traceError("Ignore 'OnStop', there is no information about peer connection by some reason."),this._closeSessionIfAllConnectionsClosed()},c.prototype.processOnIceCandidates=function(e,t){var n=this.peerConnections[e];n?n.addCandidates(t.iceCandidates):o.traceError("Ignore 'OnIceCandidates', there is no information about peer connection by some reason.")},c.prototype.processCall=function(e,t){var n=t||{};n.sessionID=this.ID,n.callType=this.callType,n.callerID=this.initiatorID,n.opponentsIDs=this.opponentsIDs,n.sdp=e.localDescription.sdp,n.userInfo=t.userInfo||{},n.userInfo.bandwidth=this.bandwidth,this.signalingProvider.sendMessage(e.userID,n,a.SignalingType.CALL)},c.prototype.processIceCandidates=function(e,t){var n={};n.sessionID=this.ID,n.callType=this.callType,n.callerID=this.initiatorID,n.opponentsIDs=this.opponentsIDs,this.signalingProvider.sendCandidate(e.userID,t,n)},c.prototype.processOnNotAnswer=function(e){o.trace("Answer timeout callback for session "+this.ID+" for user "+e.userID),this._clearWaitingOfferOrAnswerTimer(),e.release(),"function"==typeof this.onUserNotAnswerListener&&s.safeCallbackCall(this.onUserNotAnswerListener,this,e.userID),this._closeSessionIfAllConnectionsClosed()},c.prototype._onRemoteStreamListener=function(e,t){"function"==typeof this.onRemoteStreamListener&&s.safeCallbackCall(this.onRemoteStreamListener,this,e,t)},c.prototype._onCallStatsReport=function(e,t,n){"function"==typeof this.onCallStatsReport&&s.safeCallbackCall(this.onCallStatsReport,this,e,t,n)},c.prototype._onSessionConnectionStateChangedListener=function(e,t){"function"==typeof this.onSessionConnectionStateChangedListener&&(s.safeCallbackCall(this.onSessionConnectionStateChangedListener,this,e,t),o.SessionConnectionState.CLOSED===t&&this.peerConnections[e]&&(this.peerConnections[e].onicecandidate=null,this.peerConnections[e].onsignalingstatechange=null,this.peerConnections[e].ontrack=null,this.peerConnections[e].oniceconnectionstatechange=null,this.peerConnections[e]._clearWaitingReconnectTimer(),delete this.peerConnections[e]))},c.prototype._createPeer=function(e,t){if(!i)throw new Error("_createPeer error: RTCPeerConnection() is not supported in your browser");this.startCallTime=new Date;var n={iceServers:r.webrtc.iceServers,offerExtmapAllowMixed:!1};o.trace("_createPeer, iceServers: "+JSON.stringify(n));var s=new i(n);return s._init(this,e,this.ID,t),s},c.prototype._close=function(){for(var e in o.trace("_close"),this.peerConnections){var t=this.peerConnections[e];try{t.release()}catch(e){console.warn("Peer close error:",e)}}this._closeLocalMediaStream(),this.state=c.State.CLOSED,"function"==typeof this.onSessionCloseListener&&s.safeCallbackCall(this.onSessionCloseListener,this)},c.prototype._closeSessionIfAllConnectionsClosed=function(){var e=!0;for(var t in this.peerConnections){var n,r=this.peerConnections[t];try{n="closed"===r.iceConnectionState?"closed":r.signalingState}catch(e){o.traceError(e),n="closed"}if("closed"!==n){e=!1;break}}o.trace("All peer connections closed: "+e),e&&(this._closeLocalMediaStream(),"function"==typeof this.onSessionCloseListener&&this.onSessionCloseListener(this),this.state=c.State.CLOSED)},c.prototype._closeLocalMediaStream=function(){this.localStream&&(this.localStream.getAudioTracks().forEach(function(e){e.stop(),e.enabled=!1}),this.localStream.getVideoTracks().forEach(function(e){e.stop(),e.enabled=!1}),this.localStream=null)},c.prototype._muteStream=function(e,t){"audio"===t&&this.localStream.getAudioTracks().length>0?this.localStream.getAudioTracks().forEach(function(t){t.enabled=!!e}):"video"===t&&this.localStream.getVideoTracks().length>0&&this.localStream.getVideoTracks().forEach(function(t){t.enabled=!!e})},c.prototype._clearAnswerTimer=function(){this.answerTimer&&(o.trace("_clearAnswerTimer"),clearTimeout(this.answerTimer),this.answerTimer=null)},c.prototype._startAnswerTimer=function(){o.trace("_startAnswerTimer");var e=this,t=1e3*r.webrtc.answerTimeInterval;this.answerTimer=setTimeout(function(){o.trace("_answerTimeoutCallback"),"function"==typeof e.onSessionCloseListener&&e._close(),e.answerTimer=null},t)},c.prototype._clearWaitingOfferOrAnswerTimer=function(){this.waitingOfferOrAnswerTimer&&(o.trace("_clearWaitingOfferOrAnswerTimer"),clearTimeout(this.waitingOfferOrAnswerTimer),this.waitingOfferOrAnswerTimer=null)},c.prototype._startWaitingOfferOrAnswerTimer=function(e){var t=this,n=r.webrtc.answerTimeInterval-e<0?1:r.webrtc.answerTimeInterval-e;o.trace("_startWaitingOfferOrAnswerTimer, timeout: "+n),this.waitingOfferOrAnswerTimer=setTimeout(function(){o.trace("waitingOfferOrAnswerTimeoutCallback"),Object.keys(t.peerConnections).length>0&&Object.keys(t.peerConnections).forEach(function(e){var n=t.peerConnections[e];n.state!==i.State.CONNECTING&&n.state!==i.State.NEW||t.processOnNotAnswer(n)}),t.waitingOfferOrAnswerTimer=null},1e3*n)},c.prototype._uniqueOpponentsIDs=function(){var e=this,t=[];return this.initiatorID!==this.currentUserID&&t.push(this.initiatorID),this.opponentsIDs.forEach(function(n,r,i){n!=e.currentUserID&&t.push(parseInt(n))}),t},c.prototype._uniqueOpponentsIDsWithoutInitiator=function(){var e=this,t=[];return this.opponentsIDs.forEach(function(n,r,i){n!=e.currentUserID&&t.push(parseInt(n))}),t},c.prototype.toString=function(){return"ID: "+this.ID+", initiatorID:  "+this.initiatorID+", opponentsIDs: "+this.opponentsIDs+", state: "+this.state+", callType: "+this.callType},t.exports=c},{"../../qbConfig":43,"../../qbUtils":47,"./qbRTCPeerConnection":35,"./qbWebRTCHelpers":37,"./qbWebRTCSignalingConstants":39}],39:[function(e,t,n){"use strict";function r(){}r.MODULE_ID="WebRTCVideoChat",r.SignalingType={CALL:"call",ACCEPT:"accept",REJECT:"reject",STOP:"hangUp",CANDIDATE:"iceCandidates",PARAMETERS_CHANGED:"update"},t.exports=r},{}],40:[function(e,t,n){"use strict";e("strophe.js");var r=e("./qbWebRTCSignalingConstants");t.exports=function(e,t,n){var i=this;i.service=e,i.delegate=t,i.connection=n,this._onMessage=function(e,t,n,s){var o=i._getExtension(t),a=o.sessionID,c=o.signalType;switch(delete o.moduleIdentifier,delete o.sessionID,delete o.signalType,c){case r.SignalingType.CALL:"function"==typeof i.delegate._onCallListener&&i.delegate._onCallListener(s,a,o);break;case r.SignalingType.ACCEPT:"function"==typeof i.delegate._onAcceptListener&&i.delegate._onAcceptListener(s,a,o);break;case r.SignalingType.REJECT:"function"==typeof i.delegate._onRejectListener&&i.delegate._onRejectListener(s,a,o);break;case r.SignalingType.STOP:"function"==typeof i.delegate._onStopListener&&i.delegate._onStopListener(s,a,o);break;case r.SignalingType.CANDIDATE:"function"==typeof i.delegate._onIceCandidatesListener&&i.delegate._onIceCandidatesListener(s,a,o);break;case r.SignalingType.PARAMETERS_CHANGED:"function"==typeof i.delegate._onUpdateListener&&i.delegate._onUpdateListener(s,a,o)}},this._getExtension=function(e){if(!e)return null;for(var t,n,r,s,o={},a=[],c=[],d=0,l=e.childNodes.length;d<l;d++)if("iceCandidates"===e.childNodes[d].tagName)for(var u=0,h=(r=e.childNodes[d].childNodes).length;u<h;u++){t={};for(var p=0,f=(s=r[u].childNodes).length;p<f;p++)t[s[p].tagName]=s[p].textContent;a.push(t)}else if("opponentsIDs"===e.childNodes[d].tagName)for(var m=0,g=(r=e.childNodes[d].childNodes).length;m<g;m++)n=r[m].textContent,c.push(parseInt(n));else if(e.childNodes[d].childNodes.length>1)if(e.childNodes[d].textContent.length>4096){for(var v="",S=0;S<e.childNodes[d].childNodes.length;++S)v+=e.childNodes[d].childNodes[S].textContent;o[e.childNodes[d].tagName]=v}else o=i._XMLtoJS(o,e.childNodes[d].tagName,e.childNodes[d]);else"userInfo"===e.childNodes[d].tagName?o=i._XMLtoJS(o,e.childNodes[d].tagName,e.childNodes[d]):o[e.childNodes[d].tagName]=e.childNodes[d].textContent;return a.length>0&&(o.iceCandidates=a),c.length>0&&(o.opponentsIDs=c),o},this._XMLtoJS=function(e,t,n){e[t]={};for(var r=0,i=n.childNodes.length;r<i;r++)n.childNodes[r].childNodes.length>1?e[t]=this._XMLtoJS(e[t],n.childNodes[r].tagName,n.childNodes[r]):e[t][n.childNodes[r].tagName]=n.childNodes[r].textContent;return e}}},{"./qbWebRTCSignalingConstants":39,"strophe.js":13}],41:[function(e,t,n){"use strict";e("strophe.js");var r=e("./qbWebRTCHelpers"),i=e("./qbWebRTCSignalingConstants"),s=e("../../qbUtils"),o=e("../../qbConfig");function a(e,t){this.service=e,this.connection=t}a.prototype.sendCandidate=function(e,t,n){var r=n||{};r.iceCandidates=t,this.sendMessage(e,r,i.SignalingType.CANDIDATE)},a.prototype.sendMessage=function(e,t,n){var a,c,d=t||{},l=this;d.moduleIdentifier=i.MODULE_ID,d.signalType=n,d.platform="web",d.userInfo&&!Object.keys(d.userInfo).length&&delete d.userInfo,c={to:r.getUserJid(e,o.creds.appId),type:"headline",id:s.getBsonObjectId()},a=$msg(c).c("extraParams",{xmlns:Strophe.NS.CLIENT}),Object.keys(d).forEach(function(e){"iceCandidates"===e?(a=a.c("iceCandidates"),d[e].forEach(function(e){a=a.c("iceCandidate"),Object.keys(e).forEach(function(t){a.c(t).t(e[t]).up()}),a.up()}),a.up()):"opponentsIDs"===e?(a=a.c("opponentsIDs"),d[e].forEach(function(e){a=a.c("opponentID").t(e).up()}),a.up()):"object"==typeof d[e]?l._JStoXML(e,d[e],a):a.c(e).t(d[e]).up()}),this.connection.send(a)},a.prototype._JStoXML=function(e,t,n){var r=this;n.c(e),Object.keys(t).forEach(function(e){"object"==typeof t[e]?r._JStoXML(e,t[e],n):n.c(e).t(t[e]).up()}),n.up()},t.exports=a},{"../../qbConfig":43,"../../qbUtils":47,"./qbWebRTCHelpers":37,"./qbWebRTCSignalingConstants":39,"strophe.js":13}],42:[function(e,t,n){"use strict";var r=e("../qbUtils"),i=e("../modules/chat/qbChatHelpers");function s(e){this._NS="urn:xmpp:sm:3",this._isStreamManagementEnabled=!1,this._clientProcessedStanzasCounter=null,this._clientSentStanzasCounter=null,this._timeInterval=2e3,this.sentMessageCallback=null,r.getEnv().browser&&(this._parser=new DOMParser),this._c=null,this._nodeBuilder=null,this._originalSend=null,this._stanzasQueue=[]}s.prototype.enable=function(e,t){var n,s={xmlns:this._NS};this._isStreamManagementEnabled||(this._c=e,this._originalSend=this._c.send,this._c.send=this.send.bind(this)),r.getEnv().browser?(this._clientProcessedStanzasCounter=null,this._clientSentStanzasCounter=null,this._addEnableHandlers(),n=$build("enable",s)):(this._nodeBuilder=t.Stanza,this._addEnableHandlers(),n=i.createStanza(this._nodeBuilder,s,"enable")),this._c.send(n)},s.prototype._timeoutCallback=function(){var e=Date.now(),t=[];if(this._stanzasQueue.length){for(var n=0;n<this._stanzasQueue.length;n++)this._stanzasQueue[n]&&this._stanzasQueue[n].time<e?this.sentMessageCallback(this._stanzasQueue[n].message):t.push(this._stanzasQueue[n]);this._stanzasQueue=t}},s.prototype._addEnableHandlers=function(){var e=this;function t(t){var n=t.name||t.tagName||t.nodeTree.tagName;if("enabled"===n)return e._isStreamManagementEnabled=!0,setInterval(e._timeoutCallback.bind(e),e._timeInterval),!0;if(i.getAttr(t,"xmlns")!==e._NS&&e._increaseReceivedStanzasCounter(),"r"===n){var s={xmlns:e._NS,h:e._clientProcessedStanzasCounter},o=r.getEnv().browser?$build("a",s):i.createStanza(e._nodeBuilder,s,"a");return e._originalSend.call(e._c,o),!0}if("a"===n){var a=parseInt(i.getAttr(t,"h"));e._checkCounterOnIncomeStanza(a)}return!0}r.getEnv().browser?e._c.XAddTrackedHandler(t.bind(e)):e._c.on("stanza",t.bind(e))},s.prototype.send=function(e,t){var n=e.nodeTree?this._parser.parseFromString(e.nodeTree.outerHTML,"application/xml").childNodes[0]:e,r=n.name||n.tagName||n.nodeTree.tagName,s=i.getAttr(n,"type"),o=i.getElementText(n,"body")||"",a=i.getAllElements(n,"attachment")||"";this._originalSend.call(this._c,e),"message"!==r||"chat"!==s&&"groupchat"!==s||!o&&!a.length||this._sendStanzasRequest({message:t,time:Date.now()+this._timeInterval,expect:this._clientSentStanzasCounter}),this._clientSentStanzasCounter++},s.prototype._sendStanzasRequest=function(e){if(this._isStreamManagementEnabled){this._stanzasQueue.push(e);var t=r.getEnv().browser?$build("r",{xmlns:this._NS}):i.createStanza(this._nodeBuilder,{xmlns:this._NS},"r");this._originalSend.call(this._c,t)}},s.prototype.getClientSentStanzasCounter=function(){return this._clientSentStanzasCounter},s.prototype._checkCounterOnIncomeStanza=function(e){this._stanzasQueue[0].expect!==e?this.sentMessageCallback(this._stanzasQueue[0].message):this.sentMessageCallback(null,this._stanzasQueue[0].message),this._stanzasQueue.shift()},s.prototype._increaseReceivedStanzasCounter=function(){this._clientProcessedStanzasCounter++},t.exports=s},{"../modules/chat/qbChatHelpers":26,"../qbUtils":47}],43:[function(e,t,n){"use strict";var r={version:"2.13.6",buildNumber:"1099",creds:{appId:"",authKey:"",authSecret:"",accountKey:""},endpoints:{api:"api.quickblox.com",chat:"chat.quickblox.com",muc:"muc.chat.quickblox.com"},hash:"sha1",streamManagement:{enable:!1},chatProtocol:{bosh:"https://chat.quickblox.com:5281",websocket:"wss://chat.quickblox.com:5291",active:2},pingTimeout:30,chatReconnectionTimeInterval:5,webrtc:{answerTimeInterval:60,autoReject:!0,incomingLimit:1,dialingTimeInterval:5,disconnectTimeInterval:30,statsReportTimeInterval:!1,iceServers:[{urls:["turn:turn.quickblox.com","turns:turn.quickblox.com"],username:"quickblox",credential:"baccb97ba2d92d71e26eb9886da5f1e0"}]},urls:{account:"account_settings",session:"session",login:"login",users:"users",chat:"chat",blobs:"blobs",geodata:"geodata",pushtokens:"push_tokens",subscriptions:"subscriptions",events:"events",data:"data",addressbook:"address_book",addressbookRegistered:"address_book/registered_users",type:".json"},on:{sessionExpired:null},timeout:null,debug:{mode:0,file:null},addISOTime:!1,set:function(e){"object"==typeof e.endpoints&&e.endpoints.chat&&(r.endpoints.muc="muc."+e.endpoints.chat,r.chatProtocol.bosh="https://"+e.endpoints.chat+":5281",r.chatProtocol.websocket="wss://"+e.endpoints.chat+":5291"),Object.keys(e).forEach(function(t){"set"!==t&&r.hasOwnProperty(t)&&("object"!=typeof e[t]?r[t]=e[t]:Object.keys(e[t]).forEach(function(n){r[t].hasOwnProperty(n)&&(r[t][n]=e[t][n])})),"iceServers"===t&&(r.webrtc.iceServers=e[t])})}};t.exports=r},{}],44:[function(e,t,n){"use strict";var r=e("./qbConfig"),i=e("./qbUtils");function s(){}s.prototype={version:r.version,buildNumber:r.buildNumber,_getOS:i.getOS.bind(i),init:function(t,n,s,o,a){"string"==typeof o&&o.length?(a&&"object"==typeof a&&r.set(a),r.creds.accountKey=o):(console.warn('Parameter "accountKey" is missing. This will lead to error in next major release'),console.warn('NOTE: Account migration will not work without "accountKey"'),"object"==typeof o&&r.set(o));var c="api.quickblox.com",d=e("./qbProxy"),l=e("./modules/qbAuth"),u=e("./modules/qbUsers"),h=e("./modules/qbContent"),p=e("./modules/qbPushNotifications"),f=e("./modules/qbData"),m=e("./modules/qbAddressBook"),g=e("./modules/chat/qbChat"),v=e("./modules/chat/qbDialog"),S=e("./modules/chat/qbMessage");if(this.service=new d,this.auth=new l(this.service),this.users=new u(this.service),this.content=new h(this.service),this.pushnotifications=new p(this.service),this.data=new f(this.service),this.addressbook=new m(this.service),this.chat=new g(this.service),this.chat.dialog=new v(this.service),this.chat.message=new S(this.service),i.getEnv().browser)if(e("webrtc-adapter"),i.isWebRTCAvailble()){var y=e("./modules/webrtc/qbWebRTCClient");this.webrtc=new y(this.service,this.chat.connection),this.chat.webrtcSignalingProcessor=this.webrtc.signalingProcessor}else this.webrtc=!1;else this.webrtc=!1;if("string"!=typeof t||n&&"number"!=typeof n||s?(r.creds.appId=t,r.creds.authKey=n,r.creds.authSecret=s):("number"==typeof n&&(r.creds.appId=n),this.service.setSession({token:t})),r.creds.accountKey&&(!r.endpoints.api||r.endpoints.api===c||!r.endpoints.chat||"chat.quickblox.com"===r.endpoints.chat)){var b=["https://",c,"/",r.urls.account,r.urls.type].join("");this.service.ajax({url:b},function(e,t){if(!e&&"object"==typeof t){var n={endpoints:{api:t.api_endpoint.replace(/^https?:\/\//,""),chat:t.chat_endpoint}};r.set(n)}})}},getSession:function(e){this.auth.getSession(e)},createSession:function(e,t){this.auth.createSession(e,t)},destroySession:function(e){this.auth.destroySession(e)},login:function(e,t){this.auth.login(e,t)},logout:function(e){this.auth.logout(e)}};var o=new s;o.QuickBlox=s,t.exports=o},{"./modules/chat/qbChat":25,"./modules/chat/qbDialog":27,"./modules/chat/qbMessage":28,"./modules/qbAddressBook":29,"./modules/qbAuth":30,"./modules/qbContent":31,"./modules/qbData":32,"./modules/qbPushNotifications":33,"./modules/qbUsers":34,"./modules/webrtc/qbWebRTCClient":36,"./qbConfig":43,"./qbProxy":45,"./qbUtils":47,"webrtc-adapter":14}],45:[function(e,t,n){"use strict";var r,i,s=e("./qbConfig"),o=e("./qbUtils");function a(){this.qbInst={config:s,session:null},this.reqCount=0}o.getEnv().node||(r=fetch,i=FormData),a.prototype={_fetchingSettings:!1,_queue:[],setSession:function(e){this.qbInst.session=e},getSession:function(){return this.qbInst.session},handleResponse:function(e,t,n,r){if(e){const i=JSON.stringify(e.message).toLowerCase();"function"==typeof s.on.sessionExpired&&401===e.code&&i.indexOf("session does not exist")>-1?s.on.sessionExpired(function(){n(e,t)},r):n(e,null)}else s.addISOTime&&(t=o.injectISOTimes(t)),n(null,t)},startLogger:function(e){var t;++this.reqCount,e.data&&e.data.file?(t=JSON.parse(JSON.stringify(e.data))).file="...":t=o.getEnv().nativescript?JSON.stringify(e.data):e.data,o.QBLog("[Request]["+this.reqCount+"]",(e.type||"GET")+" "+e.url,t||"")},ajax:function(e,t){if(this._fetchingSettings)this._queue.push([e,t]);else{this.startLogger(e);var n,a,c=this,d=!e.type||"GET"===e.type||"HEAD"===e.type,l=c.qbInst&&c.qbInst.session&&c.qbInst.session.token,u=-1===e.url.indexOf("s3.amazonaws.com"),h=!1===e.contentType,p=e.dataType||"json",f=e.url,m={};m.method=e.type||"GET",e.data&&(n=function(){var t,n=e.data;h?(t=new i,Object.keys(n).forEach(function(r){e.fileToCustomObject&&"file"===r?t.append(r,n[r].data,n[r].name):t.append(r,e.data[r])})):t=e.isNeedStringify?JSON.stringify(n):Object.keys(n).map(function(e){return o.isObject(n[e])?Object.keys(n[e]).map(function(t){return g(e)+"["+(o.isArray(n[e])?"":t)+"]="+g(n[e][t])}).sort().join("&"):g(e)+(o.isArray(n[e])?"[]":"")+"="+g(n[e])}).sort().join("&");return t}(),d?f+="?"+n:m.body=n),h||(m.headers={"Content-Type":e.contentType||"application/x-www-form-urlencoded; charset=UTF-8"}),u&&(m.headers||(m.headers={}),m.headers["QB-OS"]=o.getOS(),m.headers["QB-SDK"]="JS "+s.version+" - Client",l&&(m.headers["QB-Token"]=l),e.url.indexOf(s.urls.account)>-1&&(m.headers["QB-Account-Key"]=s.creds.accountKey,this._fetchingSettings=!0)),s.timeout&&(m.timeout=s.timeout),r(f,m).then(function(e){return a=e,"text"===p?e.text():e.json()},function(){return a={status:200}," "}).then(function(e){v(null,a,e)},function(e){v(e)})}function g(e){return encodeURIComponent(e).replace(/[#$&+,/:;=?@\[\]]/g,function(e){return"%"+e.charCodeAt(0).toString(16)})}function v(e,n,r){var i,s,a=n&&(n.status||n.statusCode);if(e||200!==a&&201!==a&&202!==a){var d;try{d={code:n&&a||e&&e.code,status:n&&n.headers&&n.headers.status||"error",message:r||e&&e.errno,detail:r&&r.errors||e&&e.syscall}}catch(t){d=e}s=r||e||r.errors,i=o.getEnv().nativescript?JSON.stringify(s):s,o.QBLog("[Response]["+c.reqCount+"]","error",a,i),c.handleResponse(d,null,t,S)}else s=r&&" "!==r?r:"empty body",i=o.getEnv().nativescript?JSON.stringify(s):s,o.QBLog("[Response]["+c.reqCount+"]",i),c.handleResponse(null,r,t,S);if(c._fetchingSettings)for(c._fetchingSettings=!1;c._queue.length;){var l=c._queue.shift();c.ajax.apply(c,l)}}function S(n){n&&(c.setSession(n),c.ajax(e,t))}}},t.exports=a},{"./qbConfig":43,"./qbUtils":47}],46:[function(e,t,n){"use strict";e("strophe.js");var r=e("./qbConfig").chatProtocol,i=e("./qbUtils");t.exports=function(){var e=1===r.active?r.bosh:r.websocket,t=new Strophe.Connection(e);return 1===r.active?(t.xmlInput=function(e){if(e.childNodes[0])for(var t=0,n=e.childNodes.length;t<n;t++)i.QBLog("[QBChat]","RECV:",e.childNodes[t])},t.xmlOutput=function(e){if(e.childNodes[0])for(var t=0,n=e.childNodes.length;t<n;t++)i.QBLog("[QBChat]","SENT:",e.childNodes[t])}):(t.xmlInput=function(e){i.QBLog("[QBChat]","RECV:",e)},t.xmlOutput=function(e){i.QBLog("[QBChat]","SENT:",e)}),t}},{"./qbConfig":43,"./qbUtils":47,"strophe.js":13}],47:[function(e,t,n){"use strict";var r=e("./qbConfig");var i={machine:Math.floor(16777216*Math.random()).toString(16),pid:Math.floor(32767*Math.random()).toString(16),increment:0},s={getEnv:function(){return{nativescript:!1,browser:!0,node:!1}},_getOSInfoFromNodeJS:function(){return(void 0).platform()},_getOSInfoFromBrowser:function(){return window.navigator.userAgent},_getOSInfoFromNativeScript:function(){},getOS:function(){var e,t="An unknown OS";return this.getEnv().browser?e=this._getOSInfoFromBrowser():this.getEnv().node||this.getEnv().nativescript,[{osName:"Windows",codeNames:["Windows","win32"]},{osName:"Linux",codeNames:["Linux","linux"]},{osName:"macOS",codeNames:["Mac OS","darwin"]}].forEach(function(n){n.codeNames.forEach(function(r){-1!==e.indexOf(r)&&(t=n.osName)})}),t},safeCallbackCall:function(){for(var e,t=arguments[0].toString().split("(")[0].split(" ")[1],n=[],r=0;r<arguments.length;r++)n.push(arguments[r]);e=n.shift();try{e.apply(null,n)}catch(e){""===t?console.error("Error: "+e):console.error("Error in listener "+t+": "+e)}},randomNonce:function(){return Math.floor(1e4*Math.random())},unixTime:function(){return Math.floor(Date.now()/1e3)},getUrl:function(e,t){var n=t?"/"+t:"";return"https://"+r.endpoints.api+"/"+e+n+r.urls.type},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},getBsonObjectId:function(){var e=this.unixTime().toString(16),t=(i.increment++).toString(16);return t>16777215&&(i.increment=0),"00000000".substr(0,8-e.length)+e+"000000".substr(0,6-i.machine.length)+i.machine+"0000".substr(0,4-i.pid.length)+i.pid+"000000".substr(0,6-t.length)+t},injectISOTimes:function(e){if(e.created_at)"number"==typeof e.created_at&&(e.iso_created_at=new Date(1e3*e.created_at).toISOString()),"number"==typeof e.updated_at&&(e.iso_updated_at=new Date(1e3*e.updated_at).toISOString());else if(e.items)for(var t=0,n=e.items.length;t<n;++t)"number"==typeof e.items[t].created_at&&(e.items[t].iso_created_at=new Date(1e3*e.items[t].created_at).toISOString()),"number"==typeof e.items[t].updated_at&&(e.items[t].iso_updated_at=new Date(1e3*e.items[t].updated_at).toISOString());return e},QBLog:function(){if(this.loggers)for(var e=0;e<this.loggers.length;++e)this.loggers[e](arguments);else{var t;this.loggers=[];var n=function(){return function(e){console.log.apply(console,Array.prototype.slice.call(e))}};if("object"==typeof r.debug){if("number"==typeof r.debug.mode)1==r.debug.mode?(t=n(),this.loggers.push(t)):2==r.debug.mode&&(t=function(e){throw"This function isn't supported outside of the browser (...yet)"},this.loggers.push(t));else if("object"==typeof r.debug.mode){var i=this;r.debug.mode.forEach(function(e){1===e?(t=n(),i.loggers.push(t)):2===e&&(t=function(e){throw"This function isn't supported outside of the browser (...yet)"},i.loggers.push(t))})}}else"boolean"==typeof r.debug&&r.debug&&(t=n(),this.loggers.push(t));if(this.loggers)for(var s=0;s<this.loggers.length;++s)this.loggers[s](arguments)}},isWebRTCAvailble:function(){var e=window.RTCPeerConnection,t=window.RTCIceCandidate,n=window.RTCSessionDescription,r=window.navigator.mediaDevices;return Boolean(e)&&Boolean(t)&&Boolean(n)&&Boolean(r)},getError:function(e,t,n){var r={code:e,status:"error",detail:t};switch(e){case 401:r.message="Unauthorized";break;case 403:r.message="Forbidden";break;case 408:r.message="Request Timeout";break;case 422:r.message="Unprocessable Entity";break;case 502:r.message="Bad Gateway";break;default:r.message="Unknown error"}return this.QBLog("["+n+"]","Error:",t),r},MergeArrayOfObjects:function(e,t){var n=JSON.parse(JSON.stringify(e));e:for(var r=0;r<t.length;r++){for(var i=t[r],s=0;s<n.length;s++)if(i.user_id===n[s].user_id){n[s]=i;continue e}n.push(i)}return n}};t.exports=s},{"./qbConfig":43}]},{},[44])(44)});