!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports.QBVideoConferencingClient=r():e.QBVideoConferencingClient=r()}(self,(function(){return(()=>{"use strict";var e={187:e=>{var r,t="object"==typeof Reflect?Reflect:null,n=t&&"function"==typeof t.apply?t.apply:function(e,r,t){return Function.prototype.apply.call(e,r,t)};r=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}e.exports=i,e.exports.once=function(e,r){return new Promise((function(t,n){function o(){void 0!==i&&e.removeListener("error",i),t([].slice.call(arguments))}var i;"error"!==r&&(i=function(t){e.removeListener(r,o),n(t)},e.once("error",i)),e.once(r,o)}))},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var s=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function d(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function c(e,r,t,n){var o,i,s,c;if(a(t),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",r,t.listener?t.listener:t),i=e._events),s=i[r]),void 0===s)s=i[r]=t,++e._eventsCount;else if("function"==typeof s?s=i[r]=n?[t,s]:[s,t]:n?s.unshift(t):s.push(t),(o=d(e))>0&&s.length>o&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(r)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=r,u.count=s.length,c=u,console&&console.warn&&console.warn(c)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(e,r,t){var n={fired:!1,wrapFn:void 0,target:e,type:r,listener:t},o=u.bind(n);return o.listener=t,n.wrapFn=o,o}function f(e,r,t){var n=e._events;if(void 0===n)return[];var o=n[r];return void 0===o?[]:"function"==typeof o?t?[o.listener||o]:[o]:t?function(e){for(var r=new Array(e.length),t=0;t<r.length;++t)r[t]=e[t].listener||e[t];return r}(o):g(o,o.length)}function v(e){var r=this._events;if(void 0!==r){var t=r[e];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function g(e,r){for(var t=new Array(r),n=0;n<r;++n)t[n]=e[n];return t}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");s=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return d(this)},i.prototype.emit=function(e){for(var r=[],t=1;t<arguments.length;t++)r.push(arguments[t]);var o="error"===e,i=this._events;if(void 0!==i)o=o&&void 0===i.error;else if(!o)return!1;if(o){var s;if(r.length>0&&(s=r[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var d=i[e];if(void 0===d)return!1;if("function"==typeof d)n(d,this,r);else{var c=d.length,u=g(d,c);for(t=0;t<c;++t)n(u[t],this,r)}return!0},i.prototype.addListener=function(e,r){return c(this,e,r,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,r){return c(this,e,r,!0)},i.prototype.once=function(e,r){return a(r),this.on(e,l(this,e,r)),this},i.prototype.prependOnceListener=function(e,r){return a(r),this.prependListener(e,l(this,e,r)),this},i.prototype.removeListener=function(e,r){var t,n,o,i,s;if(a(r),void 0===(n=this._events))return this;if(void 0===(t=n[e]))return this;if(t===r||t.listener===r)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,t.listener||r));else if("function"!=typeof t){for(o=-1,i=t.length-1;i>=0;i--)if(t[i]===r||t[i].listener===r){s=t[i].listener,o=i;break}if(o<0)return this;0===o?t.shift():function(e,r){for(;r+1<e.length;r++)e[r]=e[r+1];e.pop()}(t,o),1===t.length&&(n[e]=t[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||r)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var r,t,n;if(void 0===(t=this._events))return this;if(void 0===t.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==t[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete t[e]),this;if(0===arguments.length){var o,i=Object.keys(t);for(n=0;n<i.length;++n)"removeListener"!==(o=i[n])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(r=t[e]))this.removeListener(e,r);else if(void 0!==r)for(n=r.length-1;n>=0;n--)this.removeListener(e,r[n]);return this},i.prototype.listeners=function(e){return f(this,e,!0)},i.prototype.rawListeners=function(e){return f(this,e,!1)},i.listenerCount=function(e,r){return"function"==typeof e.listenerCount?e.listenerCount(r):v.call(e,r)},i.prototype.listenerCount=v,i.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},761:(e,r,t)=>{t.d(r,{default:()=>a});var n=t(187);i.sessions={},i.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),r=33;return window.navigator.userAgent.match("Linux")&&(r=35),e>=26&&e<=r||i.extension.isInstalled()}return!0};var o={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var r=window.setTimeout((function(){var r=new Error("NavigatorUserMediaError");return r.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(r)}),1e3);this.cache[r]=e,window.postMessage({type:"janusGetScreen",id:r},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",(function(r){if(r.origin==window.location.origin)if("janusGotScreen"==r.data.type&&e[r.data.id]){var t=e[r.data.id];if(delete e[r.data.id],""===r.data.sourceId){var n=new Error("NavigatorUserMediaError");n.name="You cancelled the request for permission, giving up...",t(n)}else t(null,r.data.sourceId)}else"janusGetScreenPending"==r.data.type&&(console.log("clearing ",r.data.id),window.clearTimeout(r.data.id))}))}};function i(e){if((e=e||{}).success="function"==typeof e.success?e.success:i.noop,e.error="function"==typeof e.error?e.error:i.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:i.noop,!i.initDone)return e.error("Library not initialized"),{};if(!i.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(i.log("Library initialized: "+i.initDone),!e.server)return e.error("Invalid server url"),{};var r=!1,t=null,n={},o=null,s=null,a=0,d=e.server;i.isArray(d)?(i.log("Multiple servers provided ("+d.length+"), will use the first that works"),d=null,s=e.server,i.debug(s)):0===d.indexOf("ws")?(r=!0,i.log("Using WebSockets to contact Janus: "+d)):(r=!1,i.log("Using REST API to contact Janus: "+d));var c=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],u=e.iceTransportPolicy,l=e.bundlePolicy,f=!0===e.ipv6,v=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(v=!0===e.withCredentials);var g=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(g=e.max_poll_events),g<1&&(g=1);var m=null;void 0!==e.token&&null!==e.token&&(m=e.token);var p=null;void 0!==e.apisecret&&null!==e.apisecret&&(p=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var h=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(h=e.keepAlivePeriod),isNaN(h)&&(h=25e3);var b=6e4;function w(e){var r={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(r.high=e.high),e.medium&&(r.medium=e.medium),e.low&&(r.low=e.low)),r}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(b=e.longPollTimeout),isNaN(b)&&(b=6e4);var S=!1,y=null,k={},T=this,A=0,R={};function C(){if(null!=y)if(i.debug("Long poll..."),S){var r=d+"/"+y+"?rid="+(new Date).getTime();g&&(r=r+"&maxev="+g),m&&(r=r+"&token="+encodeURIComponent(m)),p&&(r=r+"&apisecret="+encodeURIComponent(p)),i.httpAPICall(r,{verb:"GET",withCredentials:v,success:D,timeout:b,error:function(r,t){if(i.error(r+":",t),++A>3)return S=!1,void e.error("Lost connection to the server (is it down?)");C()}})}else i.warn("Is the server down? (connected=false)")}function D(e,n){if(A=0,r||null==y||!0===n||C(),r||!i.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(!(c=e.sender))return void i.warn("Missing sender...");if(!(l=k[c]))return void i.debug("This handle is not attached to this session");var o=e.candidate;i.debug("Got a trickled candidate on session "+y),i.debug(o);var s=l.webrtcStuff;s.pc&&s.remoteSdp?(i.debug("Adding remote candidate:",o),o&&!0!==o.completed?s.pc.addIceCandidate(o):s.pc.addIceCandidate(i.endOfCandidates)):(i.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),s.candidates||(s.candidates=[]),s.candidates.push(o),i.debug(s.candidates))}else{if("webrtcup"===e.janus)return i.debug("Got a webrtcup event on session "+y),i.debug(e),(c=e.sender)?(l=k[c])?void l.webrtcState(!0):void i.debug("This handle is not attached to this session"):void i.warn("Missing sender...");if("hangup"===e.janus){if(i.debug("Got a hangup event on session "+y),i.debug(e),!(c=e.sender))return void i.warn("Missing sender...");if(!(l=k[c]))return void i.debug("This handle is not attached to this session");l.webrtcState(!1,e.reason),l.hangup()}else if("detached"===e.janus){if(i.debug("Got a detached event on session "+y),i.debug(e),!(c=e.sender))return void i.warn("Missing sender...");if(!(l=k[c]))return;l.detached=!0,l.ondetached(),l.detach()}else if("media"===e.janus){if(i.debug("Got a media event on session "+y),i.debug(e),!(c=e.sender))return void i.warn("Missing sender...");if(!(l=k[c]))return void i.debug("This handle is not attached to this session");l.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(i.debug("Got a slowlink event on session "+y),i.debug(e),!(c=e.sender))return void i.warn("Missing sender...");if(!(l=k[c]))return void i.debug("This handle is not attached to this session");l.slowLink(e.uplink,e.lost)}else{var a,d;if("error"===e.janus)return i.error("Ooops: "+e.error.code+" "+e.error.reason),i.debug(e),void((a=e.transaction)&&((d=R[a])&&d(e),delete R[a]));if("event"===e.janus){var c;if(i.debug("Got a plugin event on session "+y),i.debug(e),!(c=e.sender))return void i.warn("Missing sender...");var u=e.plugindata;if(!u)return void i.warn("Missing plugindata...");i.debug("  -- Event is coming from "+c+" ("+u.plugin+")");var l,f=u.data;if(i.debug(f),!(l=k[c]))return void i.warn("This handle is not attached to this session");var v=e.jsep;v&&(i.debug("Handling SDP as well..."),i.debug(v));var g=l.onmessage;g?(i.debug("Notifying application..."),g(f,v)):i.debug("No provided notification callback")}else{if("timeout"===e.janus)return i.error("Timeout on session "+y),i.debug(e),void(r&&t.close(3504,"Gateway timeout"));i.warn("Unknown message/event  '"+e.janus+"' on session "+y),i.debug(e)}}}else i.debug("Got a success on session "+y),i.debug(e),(a=e.transaction)&&((d=R[a])&&d(e),delete R[a]);else i.debug("Got an ack on session "+y),i.debug(e),(a=e.transaction)&&((d=R[a])&&d(e),delete R[a]);else i.debug("Got info on the Janus instance"),i.debug(e),(a=e.transaction)&&((d=R[a])&&d(e),delete R[a]);else i.vdebug("Got a keepalive on session "+y);else for(var m=0;m<e.length;m++)D(e[m],!0)}function I(){if(d&&r&&S){o=setTimeout(I,h);var e={janus:"keepalive",session_id:y,transaction:i.randomString(12)};m&&(e.token=m),p&&(e.apisecret=p),t.send(JSON.stringify(e))}}function _(c){var u=i.randomString(12),l={janus:"create",transaction:u};if(c.reconnect&&(S=!1,l.janus="claim",l.session_id=y,t&&(t.onopen=null,t.onerror=null,t.onclose=null,o&&(clearTimeout(o),o=null))),m&&(l.token=m),p&&(l.apisecret=p),!d&&i.isArray(s)&&(0===(d=s[a]).indexOf("ws")?(r=!0,i.log("Server #"+(a+1)+": trying WebSockets to contact Janus ("+d+")")):(r=!1,i.log("Server #"+(a+1)+": trying REST API to contact Janus ("+d+")"))),r)for(var f in t=i.newWebSocket(d,"janus-protocol"),n={error:function(){if(i.error("Error connecting to the Janus WebSockets server... "+d),i.isArray(s)&&!c.reconnect)return++a===s.length?void c.error("Error connecting to any of the provided Janus servers: Is the server down?"):(d=null,void setTimeout((function(){_(c)}),200));c.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){R[u]=function(e){if(i.debug(e),"success"!==e.janus)return i.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);o=setTimeout(I,h),S=!0,y=e.session_id?e.session_id:e.data.id,c.reconnect?i.log("Claimed session: "+y):i.log("Created session: "+y),i.sessions[y]=T,c.success()},t.send(JSON.stringify(l))},message:function(e){D(JSON.parse(e.data))},close:function(){d&&S&&(S=!1,e.error("Lost connection to the server (is it down?)"))}})t.addEventListener(f,n[f]);else i.httpAPICall(d,{verb:"POST",withCredentials:v,body:l,success:function(e){if(i.debug(e),"success"!==e.janus)return i.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);S=!0,y=e.session_id?e.session_id:e.data.id,c.reconnect?i.log("Claimed session: "+y):i.log("Created session: "+y),i.sessions[y]=T,C(),c.success()},error:function(e,r){if(i.error(e+":",r),i.isArray(s)&&!c.reconnect)return++a===s.length?void c.error("Error connecting to any of the provided Janus servers: Is the server down?"):(d=null,void setTimeout((function(){_(c)}),200));""===r?c.error(e+": Is the server down?"):c.error(e+": "+r)}})}function P(e,n){if((n=n||{}).success="function"==typeof n.success?n.success:i.noop,n.error="function"==typeof n.error?n.error:i.noop,!S)return i.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var o=k[e];if(!o||!o.webrtcStuff)return i.warn("Invalid handle"),void n.error("Invalid handle");var s=n.message,a=n.jsep,c=i.randomString(12),u={janus:"message",body:s,transaction:c};if(o.token&&(u.token=o.token),p&&(u.apisecret=p),a&&(u.jsep={type:a.type,sdp:a.sdp},a.e2ee&&(u.jsep.e2ee=!0),"hml"!==a.rid_order&&"lmh"!==a.rid_order||(u.jsep.rid_order=a.rid_order)),i.debug("Sending message to plugin (handle="+e+"):"),i.debug(u),r)return u.session_id=y,u.handle_id=e,R[c]=function(e){if(i.debug("Message sent!"),i.debug(e),"success"===e.janus){var r=e.plugindata;if(!r)return i.warn("Request succeeded, but missing plugindata..."),void n.success();i.log("Synchronous transaction successful ("+r.plugin+")");var t=r.data;return i.debug(t),void n.success(t)}"ack"===e.janus?n.success():e.error?(i.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(i.error("Unknown error"),n.error("Unknown error"))},void t.send(JSON.stringify(u));i.httpAPICall(d+"/"+y+"/"+e,{verb:"POST",withCredentials:v,body:u,success:function(e){if(i.debug("Message sent!"),i.debug(e),"success"===e.janus){var r=e.plugindata;if(!r)return i.warn("Request succeeded, but missing plugindata..."),void n.success();i.log("Synchronous transaction successful ("+r.plugin+")");var t=r.data;return i.debug(t),void n.success(t)}"ack"===e.janus?n.success():e.error?(i.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(i.error("Unknown error"),n.error("Unknown error"))},error:function(e,r){i.error(e+":",r),n.error(e+": "+r)}})}function E(e,n){if(S){var o=k[e];if(o&&o.webrtcStuff){var s={janus:"trickle",candidate:n,transaction:i.randomString(12)};if(o.token&&(s.token=o.token),p&&(s.apisecret=p),i.vdebug("Sending trickle candidate (handle="+e+"):"),i.vdebug(s),r)return s.session_id=y,s.handle_id=e,void t.send(JSON.stringify(s));i.httpAPICall(d+"/"+y+"/"+e,{verb:"POST",withCredentials:v,body:s,success:function(e){i.vdebug("Candidate sent!"),i.vdebug(e),"ack"===e.janus||i.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,r){i.error(e+":",r)}})}else i.warn("Invalid handle")}else i.warn("Is the server down? (connected=false)")}function O(e,r,t,n,o){var s=k[e];if(s&&s.webrtcStuff){var a=s.webrtcStuff;if(a.pc){var d=function(e){i.log("Received state change on data channel:",e);var r=e.target.label,t=e.target.protocol,n=a.dataChannel[r]?a.dataChannel[r].readyState:"null";if(i.log("State change on <"+r+"> data channel: "+n),"open"===n){if(a.dataChannel[r].pending&&a.dataChannel[r].pending.length>0){for(var o of(i.log("Sending pending messages on <"+r+">:",a.dataChannel[r].pending.length),a.dataChannel[r].pending))i.log("Sending data on data channel <"+r+">"),i.debug(o),a.dataChannel[r].send(o);a.dataChannel[r].pending=[]}s.ondataopen(r,t)}};if(n)a.dataChannel[r]=n;else{var c={ordered:!0};t&&(c.protocol=t),a.dataChannel[r]=a.pc.createDataChannel(r,c)}a.dataChannel[r].onmessage=function(e){i.log("Received message on data channel:",e);var r=e.target.label;s.ondata(e.data,r)},a.dataChannel[r].onopen=d,a.dataChannel[r].onclose=d,a.dataChannel[r].onerror=function(e){i.error("Got error on data channel:",e)},a.dataChannel[r].pending=[],o&&a.dataChannel[r].pending.push(o)}else i.warn("Invalid PeerConnection")}else i.warn("Invalid handle")}function V(e,r){(r=r||{}).success="function"==typeof r.success?r.success:i.noop,r.error="function"==typeof r.error?r.error:i.noop;var t=k[e];if(!t||!t.webrtcStuff)return i.warn("Invalid handle"),void r.error("Invalid handle");var n=t.webrtcStuff,o=r.text||r.data;if(!o)return i.warn("Invalid data"),void r.error("Invalid data");var s=r.label?r.label:i.dataChanDefaultLabel;return n.dataChannel[s]?"open"!==n.dataChannel[s].readyState?(n.dataChannel[s].pending.push(o),void r.success()):(i.log("Sending data on data channel <"+s+">"),i.debug(o),n.dataChannel[s].send(o),void r.success()):(O(e,s,r.protocol,!1,o,r.protocol),void r.success())}function j(e,r){(r=r||{}).success="function"==typeof r.success?r.success:i.noop,r.error="function"==typeof r.error?r.error:i.noop;var t=k[e];if(!t||!t.webrtcStuff)return i.warn("Invalid handle"),void r.error("Invalid handle");var n=t.webrtcStuff;if(!n.dtmfSender){if(n.pc){var o=n.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!o)return i.warn("Invalid DTMF configuration (no audio track)"),void r.error("Invalid DTMF configuration (no audio track)");n.dtmfSender=o.dtmf,n.dtmfSender&&(i.log("Created DTMF Sender"),n.dtmfSender.ontonechange=function(e){i.debug("Sent DTMF tone: "+e.tone)})}if(!n.dtmfSender)return i.warn("Invalid DTMF configuration"),void r.error("Invalid DTMF configuration")}var s=r.dtmf;if(!s)return i.warn("Invalid DTMF parameters"),void r.error("Invalid DTMF parameters");var a=s.tones;if(!a)return i.warn("Invalid DTMF string"),void r.error("Invalid DTMF string");var d="number"==typeof s.duration?s.duration:500,c="number"==typeof s.gap?s.gap:50;i.debug("Sending DTMF string "+a+" (duration "+d+"ms, gap "+c+"ms)"),n.dtmfSender.insertDTMF(a,d,c),r.success()}function M(e,n){(n=n||{}).success="function"==typeof n.success?n.success:i.noop,n.error="function"==typeof n.error?n.error:i.noop;var o=!0===n.noRequest;i.log("Destroying handle "+e+" (only-locally="+o+")"),G(e);var s=k[e];if(!s||s.detached)return delete k[e],void n.success();if(o)return delete k[e],void n.success();if(!S)return i.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var a={janus:"detach",transaction:i.randomString(12)};if(s.token&&(a.token=s.token),p&&(a.apisecret=p),r)return a.session_id=y,a.handle_id=e,t.send(JSON.stringify(a)),delete k[e],void n.success();i.httpAPICall(d+"/"+y+"/"+e,{verb:"POST",withCredentials:v,body:a,success:function(r){i.log("Destroyed handle:"),i.debug(r),"success"!==r.janus&&i.error("Ooops: "+r.error.code+" "+r.error.reason),delete k[e],n.success()},error:function(r,t){i.error(r+":",t),delete k[e],n.success()}})}function x(e,r,t,n,o){var s=k[e];if(!s||!s.webrtcStuff)return i.warn("Invalid handle"),n.stream||i.stopAllTracks(o),void n.error("Invalid handle");var a=s.webrtcStuff;i.debug("streamsDone:",o),o&&(i.debug("  -- Audio tracks:",o.getAudioTracks()),i.debug("  -- Video tracks:",o.getVideoTracks()));var d=!1;if(a.myStream&&t.update&&!a.streamExternal){if((!t.update&&q(t)||t.update&&(t.addAudio||t.replaceAudio))&&o.getAudioTracks()&&o.getAudioTracks().length)if(a.myStream.addTrack(o.getAudioTracks()[0]),i.unifiedPlan){i.log((t.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]);var v=null;if((m=a.pc.getTransceivers())&&m.length>0)for(var g of m)if(g.sender&&g.sender.track&&"audio"===g.sender.track.kind||g.receiver&&g.receiver.track&&"audio"===g.receiver.track.kind){v=g;break}v&&v.sender?v.sender.replaceTrack(o.getAudioTracks()[0]):a.pc.addTrack(o.getAudioTracks()[0],o)}else i.log((t.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]),a.pc.addTrack(o.getAudioTracks()[0],o);if((!t.update&&H(t)||t.update&&(t.addVideo||t.replaceVideo))&&o.getVideoTracks()&&o.getVideoTracks().length)if(a.myStream.addTrack(o.getVideoTracks()[0]),i.unifiedPlan){i.log((t.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]);var m,p=null;if((m=a.pc.getTransceivers())&&m.length>0)for(var g of m)if(g.sender&&g.sender.track&&"video"===g.sender.track.kind||g.receiver&&g.receiver.track&&"video"===g.receiver.track.kind){p=g;break}p&&p.sender?p.sender.replaceTrack(o.getVideoTracks()[0]):a.pc.addTrack(o.getVideoTracks()[0],o)}else i.log((t.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]),a.pc.addTrack(o.getVideoTracks()[0],o)}else a.myStream=o,d=!0;if(!a.pc){var h={iceServers:c,iceTransportPolicy:u,bundlePolicy:l};"chrome"===i.webRTCAdapter.browserDetails.browser&&(h.sdpSemantics=i.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var b={optional:[{DtlsSrtpKeyAgreement:!0}]};if(f&&b.optional.push({googIPv6:!0}),n.rtcConstraints&&"object"==typeof n.rtcConstraints)for(var S in i.debug("Adding custom PeerConnection constraints:",n.rtcConstraints),n.rtcConstraints)b.optional.push(n.rtcConstraints[S]);"edge"===i.webRTCAdapter.browserDetails.browser&&(h.bundlePolicy="max-bundle"),RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&(n.senderTransforms||n.receiverTransforms)&&(a.senderTransforms=n.senderTransforms,a.receiverTransforms=n.receiverTransforms,h.forceEncodedAudioInsertableStreams=!0,h.forceEncodedVideoInsertableStreams=!0,h.encodedInsertableStreams=!0),i.log("Creating PeerConnection"),i.debug(b),a.pc=new RTCPeerConnection(h,b),i.debug(a.pc),a.pc.getStats&&(a.volume={},a.bitrate.value="0 kbits/sec"),i.log("Preparing local SDP and gathering candidates (trickle="+a.trickle+")"),a.pc.oniceconnectionstatechange=function(e){a.pc&&s.iceState(a.pc.iceConnectionState)},a.pc.onicecandidate=function(r){if(!r.candidate||"edge"===i.webRTCAdapter.browserDetails.browser&&r.candidate.candidate.indexOf("endOfCandidates")>0)i.log("End of candidates."),a.iceDone=!0,!0===a.trickle?E(e,{completed:!0}):function(e,r){(r=r||{}).success="function"==typeof r.success?r.success:i.noop,r.error="function"==typeof r.error?r.error:i.noop;var t=k[e];if(t&&t.webrtcStuff){var n=t.webrtcStuff;i.log("Sending offer/answer SDP..."),n.mySdp?(n.mySdp={type:n.pc.localDescription.type,sdp:n.pc.localDescription.sdp},!1===n.trickle&&(n.mySdp.trickle=!1),i.debug(r),n.sdpSent=!0,r.success(n.mySdp)):i.warn("Local SDP instance is invalid, not sending anything...")}else i.warn("Invalid handle, not sending anything")}(e,n);else{var t={candidate:r.candidate.candidate,sdpMid:r.candidate.sdpMid,sdpMLineIndex:r.candidate.sdpMLineIndex};!0===a.trickle&&E(e,t)}},a.pc.ontrack=function(e){if(i.log("Handling Remote Track"),i.debug(e),e.streams&&(a.remoteStream=e.streams[0],s.onremotestream(a.remoteStream),!e.track.onended)){if(a.receiverTransforms){var r=null;RTCRtpSender.prototype.createEncodedStreams?r=e.receiver.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===e.track.kind&&a.receiverTransforms.audio?r=e.receiver.createEncodedAudioStreams():"video"===e.track.kind&&a.receiverTransforms.video&&(r=e.receiver.createEncodedVideoStreams())),r&&(console.log(r),r.readableStream&&r.writableStream?r.readableStream.pipeThrough(a.receiverTransforms[e.track.kind]).pipeTo(r.writableStream):r.readable&&r.writable&&r.readable.pipeThrough(a.receiverTransforms[e.track.kind]).pipeTo(r.writable))}var t=null;i.log("Adding onended callback to track:",e.track),e.track.onended=function(e){i.log("Remote track removed:",e),a.remoteStream&&(clearTimeout(t),a.remoteStream.removeTrack(e.target),s.onremotestream(a.remoteStream))},e.track.onmute=function(e){i.log("Remote track muted:",e),a.remoteStream&&null==t&&(t=setTimeout((function(){i.log("Removing remote track"),a.remoteStream&&(a.remoteStream.removeTrack(e.target),s.onremotestream(a.remoteStream)),t=null}),2520))},e.track.onunmute=function(e){if(i.log("Remote track flowing again:",e),null!=t)clearTimeout(t),t=null;else try{a.remoteStream.addTrack(e.target),s.onremotestream(a.remoteStream)}catch(e){i.error(e)}}}}}if(d&&o){i.log("Adding local stream");var y=!0===n.simulcast2;o.getTracks().forEach((function(e){i.log("Adding local track:",e);var r=null;if(y&&"audio"!==e.kind){i.log("Enabling rid-based simulcasting:",e);var t=w(n.simulcastMaxBitrates),s=a.pc.addTransceiver(e,{direction:"sendrecv",streams:[o],sendEncodings:n.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}]});s&&(r=s.sender)}else r=a.pc.addTrack(e,o);if(r&&a.senderTransforms){var d=null;RTCRtpSender.prototype.createEncodedStreams?d=r.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===r.track.kind&&a.senderTransforms.audio?d=r.createEncodedAudioStreams():"video"===r.track.kind&&a.senderTransforms.video&&(d=r.createEncodedVideoStreams())),d&&(console.log(d),d.readableStream&&d.writableStream?d.readableStream.pipeThrough(a.senderTransforms[r.track.kind]).pipeTo(d.writableStream):d.readable&&d.writable&&d.readable.pipeThrough(a.senderTransforms[r.track.kind]).pipeTo(d.writable))}}))}(function(e){return i.debug("isDataEnabled:",e),"edge"===i.webRTCAdapter.browserDetails.browser?(i.warn("Edge doesn't support data channels yet"),!1):null!=e&&!0===e.data})(t)&&!a.dataChannel[i.dataChanDefaultLabel]&&(i.log("Creating default data channel"),O(e,i.dataChanDefaultLabel,null,!1),a.pc.ondatachannel=function(r){i.log("Data channel created by Janus:",r),O(e,r.channel.label,r.channel.protocol,r.channel)}),a.myStream&&s.onlocalstream(a.myStream),r?a.pc.setRemoteDescription(r).then((function(){if(i.log("Remote description accepted!"),a.remoteSdp=r.sdp,a.candidates&&a.candidates.length>0){for(var o=0;o<a.candidates.length;o++){var s=a.candidates[o];i.debug("Adding remote candidate:",s),s&&!0!==s.completed?a.pc.addIceCandidate(s):a.pc.addIceCandidate(i.endOfCandidates)}a.candidates=[]}!function(e,r,t){(t=t||{}).success="function"==typeof t.success?t.success:i.noop,t.error="function"==typeof t.error?t.error:i.noop,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:i.noop;var n=k[e];if(!n||!n.webrtcStuff)return i.warn("Invalid handle"),void t.error("Invalid handle");var o=n.webrtcStuff,s=!0===t.simulcast;s?i.log("Creating answer (iceDone="+o.iceDone+", simulcast="+s+")"):i.log("Creating answer (iceDone="+o.iceDone+")");var a=null;if(i.unifiedPlan){a={};var d=null,c=null,u=o.pc.getTransceivers();if(u&&u.length>0)for(var l of u)l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind?d||(d=l):(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind)&&(c||(c=l));var f=q(r),v=z(r);if(f||v){if(f&&v){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",i.log("Setting audio transceiver to sendrecv:",d)}catch(e){i.error(e)}}else if(f&&!v)try{d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",i.log("Setting audio transceiver to sendonly:",d))}catch(e){i.error(e)}else if(!f&&v)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",i.log("Setting audio transceiver to recvonly:",d)}catch(e){i.error(e)}else d=o.pc.addTransceiver("audio",{direction:"recvonly"}),i.log("Adding recvonly audio transceiver:",d)}else if(r.removeAudio&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",i.log("Setting audio transceiver to inactive:",d)}catch(e){i.error(e)}var g=H(r),m=Q(r);if(g||m){if(g&&m){if(c)try{c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",i.log("Setting video transceiver to sendrecv:",c)}catch(e){i.error(e)}}else if(g&&!m){if(c)try{c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",i.log("Setting video transceiver to sendonly:",c)}catch(e){i.error(e)}}else if(!g&&m)if(c)try{c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",i.log("Setting video transceiver to recvonly:",c)}catch(e){i.error(e)}else c=o.pc.addTransceiver("video",{direction:"recvonly"}),i.log("Adding recvonly video transceiver:",c)}else if(r.removeVideo&&c)try{c.setDirection?c.setDirection("inactive"):c.direction="inactive",i.log("Setting video transceiver to inactive:",c)}catch(e){i.error(e)}}else a="firefox"===i.webRTCAdapter.browserDetails.browser||"edge"===i.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:z(r),offerToReceiveVideo:Q(r)}:{mandatory:{OfferToReceiveAudio:z(r),OfferToReceiveVideo:Q(r)}};i.debug(a);var p=H(r);if(p&&s&&"firefox"===i.webRTCAdapter.browserDetails.browser){i.log("Enabling Simulcasting for Firefox (RID)");var h=o.pc.getSenders()[1];i.log(h);var b=h.getParameters();i.log(b);var S=w(t.simulcastMaxBitrates);h.setParameters({encodings:t.sendEncodings||[{rid:"h",active:!0,maxBitrate:S.high},{rid:"m",active:!0,maxBitrate:S.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:S.low,scaleResolutionDownBy:4}]})}o.pc.createAnswer(a).then((function(e){i.debug(e);var r={type:e.type,sdp:e.sdp};t.customizeSdp(r),e.sdp=r.sdp,i.log("Setting local description"),p&&s&&("chrome"===i.webRTCAdapter.browserDetails.browser?i.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==i.webRTCAdapter.browserDetails.browser&&i.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp={type:"answer",sdp:e.sdp},o.pc.setLocalDescription(e).catch(t.error),o.mediaConstraints=a,o.iceDone||o.trickle?((o.senderTransforms||o.receiverTransforms)&&(e.e2ee=!0),t.success(e)):i.log("Waiting for all candidates...")}),t.error)}(e,t,n)}),n.error):function(e,r,t){(t=t||{}).success="function"==typeof t.success?t.success:i.noop,t.error="function"==typeof t.error?t.error:i.noop,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:i.noop;var n=k[e];if(!n||!n.webrtcStuff)return i.warn("Invalid handle"),void t.error("Invalid handle");var o=n.webrtcStuff,s=!0===t.simulcast;s?i.log("Creating offer (iceDone="+o.iceDone+", simulcast="+s+")"):i.log("Creating offer (iceDone="+o.iceDone+")");var a={};if(i.unifiedPlan){var d=null,c=null,u=o.pc.getTransceivers();if(u&&u.length>0)for(var l of u)l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind?d||(d=l):(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind)&&(c||(c=l));var f=q(r),v=z(r);f||v?f&&v?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",i.log("Setting audio transceiver to sendrecv:",d)):f&&!v?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",i.log("Setting audio transceiver to sendonly:",d)):!f&&v&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",i.log("Setting audio transceiver to recvonly:",d)):(d=o.pc.addTransceiver("audio",{direction:"recvonly"}),i.log("Adding recvonly audio transceiver:",d))):r.removeAudio&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",i.log("Setting audio transceiver to inactive:",d));var g=H(r),m=Q(r);g||m?g&&m?c&&(c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",i.log("Setting video transceiver to sendrecv:",c)):g&&!m?c&&(c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",i.log("Setting video transceiver to sendonly:",c)):!g&&m&&(c?(c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",i.log("Setting video transceiver to recvonly:",c)):(c=o.pc.addTransceiver("video",{direction:"recvonly"}),i.log("Adding recvonly video transceiver:",c))):r.removeVideo&&c&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive",i.log("Setting video transceiver to inactive:",c))}else a.offerToReceiveAudio=z(r),a.offerToReceiveVideo=Q(r);!0===t.iceRestart&&(a.iceRestart=!0),i.debug(a);var p=H(r);if(p&&s&&"firefox"===i.webRTCAdapter.browserDetails.browser){i.log("Enabling Simulcasting for Firefox (RID)");var h=o.pc.getSenders().find((function(e){return"video"===e.track.kind}));if(h){var b=h.getParameters();b||(b={});var S=w(t.simulcastMaxBitrates);b.encodings=t.sendEncodings||[{rid:"h",active:!0,maxBitrate:S.high},{rid:"m",active:!0,maxBitrate:S.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:S.low,scaleResolutionDownBy:4}],h.setParameters(b)}}o.pc.createOffer(a).then((function(e){i.debug(e);var r={type:e.type,sdp:e.sdp};t.customizeSdp(r),e.sdp=r.sdp,i.log("Setting local description"),p&&s&&("chrome"===i.webRTCAdapter.browserDetails.browser||"safari"===i.webRTCAdapter.browserDetails.browser?(i.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var r=e.split("\r\n"),t=!1,n=[-1],o=[-1],s=null,a=null,d=null,c=null,u=-1,l=0;l<r.length;l++)if(v=r[l].match(/m=(\w+) */)){if("video"===v[1]){if(!(n[0]<0)){u=l;break}t=!0}else if(n[0]>-1){u=l;break}}else if(t){if(r[l].match(/a=ssrc-group:SIM (\d+) (\d+) (\d+)/))return i.warn("The SDP already contains a SIM attribute, munging will be skipped"),e;var f=r[l].match(/a=ssrc-group:FID (\d+) (\d+)/);if(f)n[0]=f[1],o[0]=f[2],r.splice(l,1),l--;else{if(n[0]){if((m=r[l].match("a=ssrc:"+n[0]+" cname:(.+)"))&&(s=m[1]),(m=r[l].match("a=ssrc:"+n[0]+" msid:(.+)"))&&(a=m[1]),(m=r[l].match("a=ssrc:"+n[0]+" mslabel:(.+)"))&&(d=m[1]),(m=r[l].match("a=ssrc:"+n[0]+" label:(.+)"))&&(c=m[1]),0===r[l].indexOf("a=ssrc:"+o[0])){r.splice(l,1),l--;continue}if(0===r[l].indexOf("a=ssrc:"+n[0])){r.splice(l,1),l--;continue}}0!=r[l].length||(r.splice(l,1),l--)}}if(n[0]<0)for(u=-1,t=!1,l=0;l<r.length;l++){var v;if(v=r[l].match(/m=(\w+) */)){if("video"===v[1]){if(!(n[0]<0)){u=l;break}t=!0}else if(n[0]>-1){u=l;break}}else if(t){if(n[0]<0){var g=r[l].match(/a=ssrc:(\d+)/);if(g){n[0]=g[1],r.splice(l,1),l--;continue}}else{var m;if((m=r[l].match("a=ssrc:"+n[0]+" cname:(.+)"))&&(s=m[1]),(m=r[l].match("a=ssrc:"+n[0]+" msid:(.+)"))&&(a=m[1]),(m=r[l].match("a=ssrc:"+n[0]+" mslabel:(.+)"))&&(d=m[1]),(m=r[l].match("a=ssrc:"+n[0]+" label:(.+)"))&&(c=m[1]),0===r[l].indexOf("a=ssrc:"+o[0])){r.splice(l,1),l--;continue}if(0===r[l].indexOf("a=ssrc:"+n[0])){r.splice(l,1),l--;continue}}0!==r[l].length||(r.splice(l,1),l--)}}if(n[0]<0)return i.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;for(u<0&&(u=r.length),n[1]=Math.floor(4294967295*Math.random()),n[2]=Math.floor(4294967295*Math.random()),o[1]=Math.floor(4294967295*Math.random()),o[2]=Math.floor(4294967295*Math.random()),l=0;l<n.length;l++)s&&(r.splice(u,0,"a=ssrc:"+n[l]+" cname:"+s),u++),a&&(r.splice(u,0,"a=ssrc:"+n[l]+" msid:"+a),u++),d&&(r.splice(u,0,"a=ssrc:"+n[l]+" mslabel:"+d),u++),c&&(r.splice(u,0,"a=ssrc:"+n[l]+" label:"+c),u++),s&&(r.splice(u,0,"a=ssrc:"+o[l]+" cname:"+s),u++),a&&(r.splice(u,0,"a=ssrc:"+o[l]+" msid:"+a),u++),d&&(r.splice(u,0,"a=ssrc:"+o[l]+" mslabel:"+d),u++),c&&(r.splice(u,0,"a=ssrc:"+o[l]+" label:"+c),u++);return r.splice(u,0,"a=ssrc-group:FID "+n[2]+" "+o[2]),r.splice(u,0,"a=ssrc-group:FID "+n[1]+" "+o[1]),r.splice(u,0,"a=ssrc-group:FID "+n[0]+" "+o[0]),r.splice(u,0,"a=ssrc-group:SIM "+n[0]+" "+n[1]+" "+n[2]),(e=r.join("\r\n")).endsWith("\r\n")||(e+="\r\n"),e}(e.sdp)):"firefox"!==i.webRTCAdapter.browserDetails.browser&&i.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp={type:"offer",sdp:e.sdp},o.pc.setLocalDescription(e).catch(t.error),o.mediaConstraints=a,o.iceDone||o.trickle?((o.senderTransforms||o.receiverTransforms)&&(e.e2ee=!0),t.success(e)):i.log("Waiting for all candidates...")}),t.error)}(e,t,n)}function L(e,r,t){(t=t||{}).success="function"==typeof t.success?t.success:i.noop,t.error="function"==typeof t.error?t.error:B;var n=t.jsep;if(r&&n)return i.error("Provided a JSEP to a createOffer"),void t.error("Provided a JSEP to a createOffer");if(!(r||n&&n.type&&n.sdp))return i.error("A valid JSEP is required for createAnswer"),void t.error("A valid JSEP is required for createAnswer");t.media="object"==typeof t.media&&t.media?t.media:{audio:!0,video:!0};var o=t.media,s=k[e];if(!s||!s.webrtcStuff)return i.warn("Invalid handle"),void t.error("Invalid handle");var a,d=s.webrtcStuff;if(d.trickle=(a=t.trickle,i.debug("isTrickleEnabled:",a),!1!==a),d.pc){if(i.log("Updating existing media session"),o.update=!0,t.stream)t.stream!==d.myStream&&i.log("Renegotiation involves a new external stream");else{if(o.addAudio){if(o.keepAudio=!1,o.replaceAudio=!1,o.removeAudio=!1,o.audioSend=!0,d.myStream&&d.myStream.getAudioTracks()&&d.myStream.getAudioTracks().length)return i.error("Can't add audio stream, there already is one"),void t.error("Can't add audio stream, there already is one")}else o.removeAudio?(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!1,o.audioSend=!1):o.replaceAudio&&(o.keepAudio=!1,o.addAudio=!1,o.removeAudio=!1,o.audioSend=!0);if(d.myStream&&d.myStream.getAudioTracks()&&0!==d.myStream.getAudioTracks().length?!q(o)||o.removeAudio||o.replaceAudio||(o.keepAudio=!0):(o.replaceAudio&&(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),q(o)&&(o.keepAudio=!1,o.addAudio=!0)),o.addVideo){if(o.keepVideo=!1,o.replaceVideo=!1,o.removeVideo=!1,o.videoSend=!0,d.myStream&&d.myStream.getVideoTracks()&&d.myStream.getVideoTracks().length)return i.error("Can't add video stream, there already is one"),void t.error("Can't add video stream, there already is one")}else o.removeVideo?(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!1,o.videoSend=!1):o.replaceVideo&&(o.keepVideo=!1,o.addVideo=!1,o.removeVideo=!1,o.videoSend=!0);d.myStream&&d.myStream.getVideoTracks()&&0!==d.myStream.getVideoTracks().length?!H(o)||o.removeVideo||o.replaceVideo||(o.keepVideo=!0):(o.replaceVideo&&(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),H(o)&&(o.keepVideo=!1,o.addVideo=!0)),o.addData&&(o.data=!0)}if(q(o)&&o.keepAudio&&H(o)&&o.keepVideo)return s.consentDialog(!1),void x(e,n,o,t,d.myStream)}else o.update=!1,o.keepAudio=!1,o.keepVideo=!1;if(o.update&&!d.streamExternal){if(o.removeAudio||o.replaceAudio){if(d.myStream&&d.myStream.getAudioTracks()&&d.myStream.getAudioTracks().length){var c=d.myStream.getAudioTracks()[0];i.log("Removing audio track:",c),d.myStream.removeTrack(c);try{c.stop()}catch(e){}}if(d.pc.getSenders()&&d.pc.getSenders().length){var u=!0;if(o.replaceAudio&&i.unifiedPlan&&(u=!1),u)for(var l of d.pc.getSenders())l&&l.track&&"audio"===l.track.kind&&(i.log("Removing audio sender:",l),d.pc.removeTrack(l))}}if(o.removeVideo||o.replaceVideo){if(d.myStream&&d.myStream.getVideoTracks()&&d.myStream.getVideoTracks().length){var f=d.myStream.getVideoTracks()[0];i.log("Removing video track:",f),d.myStream.removeTrack(f);try{f.stop()}catch(e){}}if(d.pc.getSenders()&&d.pc.getSenders().length){var v=!0;if(o.replaceVideo&&i.unifiedPlan&&(v=!1),v)for(var g of d.pc.getSenders())g&&g.track&&"video"===g.track.kind&&(i.log("Removing video sender:",g),d.pc.removeTrack(g))}}}if(t.stream){var m=t.stream;return i.log("MediaStream provided by the application"),i.debug(m),o.update&&d.myStream&&d.myStream!==t.stream&&!d.streamExternal&&(i.stopAllTracks(d.myStream),d.myStream=null),d.streamExternal=!0,s.consentDialog(!1),void x(e,n,o,t,m)}if(q(o)||H(o)){if(!i.isGetUserMediaAvailable())return void t.error("getUserMedia not available");var p={mandatory:{},optional:[]};s.consentDialog(!0);var h=q(o);h&&o&&"object"==typeof o.audio&&(h=o.audio);var b=H(o);if(b&&o){var w=!0===t.simulcast,S=!0===t.simulcast2;if(!w&&!S||n||o.video||(o.video="hires"),o.video&&"screen"!=o.video&&"window"!=o.video)if("object"==typeof o.video)b=o.video;else{var y=0,T=0;"lowres"===o.video?(T=240,y=320):"lowres-16:9"===o.video?(T=180,y=320):"hires"===o.video||"hires-16:9"===o.video||"hdres"===o.video?(T=720,y=1280):"fhdres"===o.video?(T=1080,y=1920):"4kres"===o.video?(T=2160,y=3840):"stdres"===o.video?(T=480,y=640):"stdres-16:9"===o.video?(T=360,y=640):(i.log("Default video setting is stdres 4:3"),T=480,y=640),i.log("Adding media constraint:",o.video),b={height:{ideal:T},width:{ideal:y}},i.log("Adding video constraint:",b)}else if("screen"===o.video||"window"===o.video){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return p.video={},o.screenshareFrameRate&&(p.video.frameRate=o.screenshareFrameRate),o.screenshareHeight&&(p.video.height=o.screenshareHeight),o.screenshareWidth&&(p.video.width=o.screenshareWidth),p.audio=o.captureDesktopAudio,void navigator.mediaDevices.getDisplayMedia(p).then((function(r){s.consentDialog(!1),q(o)&&!o.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(i){r.addTrack(i.getAudioTracks()[0]),x(e,n,o,t,r)})):x(e,n,o,t,r)}),(function(e){s.consentDialog(!1),t.error(e)}));function A(r,i){s.consentDialog(!1),r?t.error(r):x(e,n,o,t,i)}function R(e,r,t){i.log("Adding media constraint (screen capture)"),i.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){t?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(t){e.addTrack(t.getAudioTracks()[0]),r(null,e)})):r(null,e)})).catch((function(e){s.consentDialog(!1),r(e)}))}if("chrome"===i.webRTCAdapter.browserDetails.browser){var C=i.webRTCAdapter.browserDetails.version,D=33;window.navigator.userAgent.match("Linux")&&(D=35),C>=26&&C<=D?R(p={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate,chromeMediaSource:"screen"}},audio:q(o)&&!o.keepAudio},A):i.extension.getScreen((function(e,r){if(e)return s.consentDialog(!1),t.error(e);(p={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=r,R(p,A,q(o)&&!o.keepAudio)}))}else if("firefox"===i.webRTCAdapter.browserDetails.browser){if(!(i.webRTCAdapter.browserDetails.version>=33)){var I=new Error("NavigatorUserMediaError");return I.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",s.consentDialog(!1),void t.error(I)}R(p={video:{mozMediaSource:o.video,mediaSource:o.video},audio:q(o)&&!o.keepAudio},(function(e,r){if(A(e,r),!e)var t=r.currentTime,n=window.setInterval((function(){r||window.clearInterval(n),r.currentTime==t&&(window.clearInterval(n),r.onended&&r.onended()),t=r.currentTime}),500)}))}return}}o&&"screen"===o.video||navigator.mediaDevices.enumerateDevices().then((function(r){var a=r.some((function(e){return"audioinput"===e.kind})),d=function(e){if(i.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var r=e.video.mandatory;return r.chromeMediaSource?"desktop"===r.chromeMediaSource||"screen"===r.chromeMediaSource:r.mozMediaSource?"window"===r.mozMediaSource||"screen"===r.mozMediaSource:!!r.mediaSource&&("window"===r.mediaSource||"screen"===r.mediaSource)}(o)||r.some((function(e){return"videoinput"===e.kind})),c=q(o),u=H(o),l=function(e){return i.debug("isAudioSendRequired:",e),!!e&&!1!==e.audio&&!1!==e.audioSend&&void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio}(o),f=function(e){return i.debug("isVideoSendRequired:",e),!!e&&!1!==e.video&&!1!==e.videoSend&&void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo}(o);if(c||u||l||f){var v=!!c&&a,g=!!u&&d;if(!v&&!g)return s.consentDialog(!1),t.error("No capture device found"),!1;if(!v&&l)return s.consentDialog(!1),t.error("Audio capture is required, but no capture device found"),!1;if(!g&&f)return s.consentDialog(!1),t.error("Video capture is required, but no capture device found"),!1}var p={audio:!(!a||o.keepAudio)&&h,video:!(!d||o.keepVideo)&&b};i.debug("getUserMedia constraints",p),p.audio||p.video?navigator.mediaDevices.getUserMedia(p).then((function(r){s.consentDialog(!1),x(e,n,o,t,r)})).catch((function(e){s.consentDialog(!1),t.error({code:e.code,name:e.name,message:e.message})})):(s.consentDialog(!1),x(e,n,o,t,m))})).catch((function(e){s.consentDialog(!1),t.error(e)}))}else x(e,n,o,t)}function N(e,r){(r=r||{}).success="function"==typeof r.success?r.success:i.noop,r.error="function"==typeof r.error?r.error:B,r.customizeSdp="function"==typeof r.customizeSdp?r.customizeSdp:i.noop;var t=r.jsep,n=k[e];if(!n||!n.webrtcStuff)return i.warn("Invalid handle"),void r.error("Invalid handle");var o=n.webrtcStuff;if(t){if(!o.pc)return i.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void r.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");r.customizeSdp(t),o.pc.setRemoteDescription(t).then((function(){if(i.log("Remote description accepted!"),o.remoteSdp=t.sdp,o.candidates&&o.candidates.length>0){for(var e=0;e<o.candidates.length;e++){var n=o.candidates[e];i.debug("Adding remote candidate:",n),n&&!0!==n.completed?o.pc.addIceCandidate(n):o.pc.addIceCandidate(i.endOfCandidates)}o.candidates=[]}r.success()}),r.error)}else r.error("Invalid JSEP")}function F(e,r){var t=k[e];if(!t||!t.webrtcStuff)return i.warn("Invalid handle"),0;var n=r?"remote":"local",o=t.webrtcStuff;return o.volume[n]||(o.volume[n]={value:0}),!o.pc.getStats||"chrome"!==i.webRTCAdapter.browserDetails.browser&&"safari"!==i.webRTCAdapter.browserDetails.browser?(i.warn("Getting the "+n+" volume unsupported by browser"),0):r&&!o.remoteStream?(i.warn("Remote stream unavailable"),0):r||o.myStream?o.volume[n].timer?o.volume[n].value:(i.log("Starting "+n+" volume monitor"),o.volume[n].timer=setInterval((function(){o.pc.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(r&&!e.remoteSource||!r&&"media-source"!==e.type||(o.volume[n].value=e.audioLevel?e.audioLevel:0))}))}))}),200),0):(i.warn("Local stream unavailable"),0)}function J(e,r){var t=k[e];if(!t||!t.webrtcStuff)return i.warn("Invalid handle"),!0;var n=t.webrtcStuff;return n.pc?n.myStream?r?n.myStream.getVideoTracks()&&0!==n.myStream.getVideoTracks().length?!n.myStream.getVideoTracks()[0].enabled:(i.warn("No video track"),!0):n.myStream.getAudioTracks()&&0!==n.myStream.getAudioTracks().length?!n.myStream.getAudioTracks()[0].enabled:(i.warn("No audio track"),!0):(i.warn("Invalid local MediaStream"),!0):(i.warn("Invalid PeerConnection"),!0)}function U(e,r,t){var n=k[e];if(!n||!n.webrtcStuff)return i.warn("Invalid handle"),!1;var o=n.webrtcStuff;return o.pc?o.myStream?r?o.myStream.getVideoTracks()&&0!==o.myStream.getVideoTracks().length?(o.myStream.getVideoTracks()[0].enabled=!t,!0):(i.warn("No video track"),!1):o.myStream.getAudioTracks()&&0!==o.myStream.getAudioTracks().length?(o.myStream.getAudioTracks()[0].enabled=!t,!0):(i.warn("No audio track"),!1):(i.warn("Invalid local MediaStream"),!1):(i.warn("Invalid PeerConnection"),!1)}function W(e){var r=k[e];if(!r||!r.webrtcStuff)return i.warn("Invalid handle"),"Invalid handle";var t=r.webrtcStuff;return t.pc?t.pc.getStats?t.bitrate.timer?t.bitrate.value:(i.log("Starting bitrate timer (via getStats)"),t.bitrate.timer=setInterval((function(){t.pc.getStats().then((function(e){e.forEach((function(e){if(e){var r=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?r=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(r=!0),r)if(t.bitrate.bsnow=e.bytesReceived,t.bitrate.tsnow=e.timestamp,null===t.bitrate.bsbefore||null===t.bitrate.tsbefore)t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow;else{var n=t.bitrate.tsnow-t.bitrate.tsbefore;"safari"===i.webRTCAdapter.browserDetails.browser&&(n/=1e3);var o=Math.round(8*(t.bitrate.bsnow-t.bitrate.bsbefore)/n);"safari"===i.webRTCAdapter.browserDetails.browser&&(o=parseInt(o/1e3)),t.bitrate.value=o+" kbits/sec",t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):(i.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function B(e){i.error("WebRTC error:",e)}function G(e,n){i.log("Cleaning WebRTC stuff");var o=k[e];if(o){var s=o.webrtcStuff;if(s){if(!0===n){var a={janus:"hangup",transaction:i.randomString(12)};o.token&&(a.token=o.token),p&&(a.apisecret=p),i.debug("Sending hangup request (handle="+e+"):"),i.debug(a),r?(a.session_id=y,a.handle_id=e,t.send(JSON.stringify(a))):i.httpAPICall(d+"/"+y+"/"+e,{verb:"POST",withCredentials:v,body:a})}s.remoteStream=null,s.volume&&(s.volume.local&&s.volume.local.timer&&clearInterval(s.volume.local.timer),s.volume.remote&&s.volume.remote.timer&&clearInterval(s.volume.remote.timer)),s.volume={},s.bitrate.timer&&clearInterval(s.bitrate.timer),s.bitrate.timer=null,s.bitrate.bsnow=null,s.bitrate.bsbefore=null,s.bitrate.tsnow=null,s.bitrate.tsbefore=null,s.bitrate.value=null,!s.streamExternal&&s.myStream&&(i.log("Stopping local stream tracks"),i.stopAllTracks(s.myStream)),s.streamExternal=!1,s.myStream=null;try{s.pc.close()}catch(e){}s.pc=null,s.candidates=null,s.mySdp=null,s.remoteSdp=null,s.iceDone=!1,s.dataChannel={},s.dtmfSender=null,s.senderTransforms=null,s.receiverTransforms=null}o.oncleanup()}}function q(e){return i.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function z(e){return i.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function H(e){return i.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function Q(e){return i.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}_(e),this.getServer=function(){return d},this.isConnected=function(){return S},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:i.noop,e.error="function"==typeof e.error?e.error:i.noop,e.reconnect=!0,_(e)},this.getSessionId=function(){return y},this.getInfo=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:i.noop,e.error="function"==typeof e.error?e.error:i.noop,i.log("Getting info on Janus instance"),!S)return i.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=i.randomString(12),o={janus:"info",transaction:n};if(m&&(o.token=m),p&&(o.apisecret=p),r)return R[n]=function(r){i.log("Server info:"),i.debug(r),"server_info"!==r.janus&&i.error("Ooops: "+r.error.code+" "+r.error.reason),e.success(r)},void t.send(JSON.stringify(o));i.httpAPICall(d,{verb:"POST",withCredentials:v,body:o,success:function(r){i.log("Server info:"),i.debug(r),"server_info"!==r.janus&&i.error("Ooops: "+r.error.code+" "+r.error.reason),e.success(r)},error:function(r,t){i.error(r+":",t),""===t?e.error(r+": Is the server down?"):e.error(r+": "+t)}})}(e)},this.destroy=function(s){!function(s){(s=s||{}).success="function"==typeof s.success?s.success:i.noop,s.error="function"==typeof s.error?s.error:i.noop;var a=!0===s.unload,c=!0;void 0!==s.notifyDestroyed&&null!==s.notifyDestroyed&&(c=!0===s.notifyDestroyed);var u=!0===s.cleanupHandles;if(i.log("Destroying session "+y+" (unload="+a+")"),!y)return i.warn("No session to destroy"),s.success(),void(c&&e.destroyed());if(u)for(var l in k)M(l,{noRequest:!0});if(!S)return i.warn("Is the server down? (connected=false)"),y=null,void s.success();var f={janus:"destroy",transaction:i.randomString(12)};if(m&&(f.token=m),p&&(f.apisecret=p),a)return r?(t.onclose=null,t.close(),t=null):navigator.sendBeacon(d+"/"+y,JSON.stringify(f)),i.log("Destroyed session:"),y=null,S=!1,s.success(),void(c&&e.destroyed());if(r){f.session_id=y;var g=function(){for(var e in n)t.removeEventListener(e,n[e]);t.removeEventListener("message",h),t.removeEventListener("error",b),o&&clearTimeout(o),t.close()},h=function(r){var t=JSON.parse(r.data);t.session_id==f.session_id&&t.transaction==f.transaction&&(g(),s.success(),c&&e.destroyed())},b=function(r){g(),s.error("Failed to destroy the server: Is the server down?"),c&&e.destroyed()};return t.addEventListener("message",h),t.addEventListener("error",b),void(1===t.readyState?t.send(JSON.stringify(f)):b())}i.httpAPICall(d+"/"+y,{verb:"POST",withCredentials:v,body:f,success:function(r){i.log("Destroyed session:"),i.debug(r),y=null,S=!1,"success"!==r.janus&&i.error("Ooops: "+r.error.code+" "+r.error.reason),s.success(),c&&e.destroyed()},error:function(r,t){i.error(r+":",t),y=null,S=!1,s.success(),c&&e.destroyed()}})}(s)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:i.noop,e.error="function"==typeof e.error?e.error:i.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:i.noop,e.iceState="function"==typeof e.iceState?e.iceState:i.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:i.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:i.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:i.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:i.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:i.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:i.noop,e.ondata="function"==typeof e.ondata?e.ondata:i.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:i.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:i.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:i.noop,!S)return i.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=e.plugin;if(!n)return i.error("Invalid plugin"),void e.error("Invalid plugin");var o=e.opaqueId,s=e.token?e.token:m,a=i.randomString(12),c={janus:"attach",plugin:n,opaque_id:o,transaction:a};if(s&&(c.token=s),p&&(c.apisecret=p),r)return R[a]=function(r){if(i.debug(r),"success"!==r.janus)return i.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);var t=r.data.id;i.log("Created handle: "+t);var o={session:T,plugin:n,id:t,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return t},getPlugin:function(){return n},getVolume:function(){return F(t,!0)},getRemoteVolume:function(){return F(t,!0)},getLocalVolume:function(){return F(t,!1)},isAudioMuted:function(){return J(t,!1)},muteAudio:function(){return U(t,!1,!0)},unmuteAudio:function(){return U(t,!1,!1)},isVideoMuted:function(){return J(t,!0)},muteVideo:function(){return U(t,!0,!0)},unmuteVideo:function(){return U(t,!0,!1)},getBitrate:function(){return W(t)},send:function(e){P(t,e)},data:function(e){V(t,e)},dtmf:function(e){j(t,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){L(t,!0,e)},createAnswer:function(e){L(t,!1,e)},handleRemoteJsep:function(e){N(t,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){G(t,!0===e)},detach:function(e){M(t,e)}};k[t]=o,e.success(o)},c.session_id=y,void t.send(JSON.stringify(c));i.httpAPICall(d+"/"+y,{verb:"POST",withCredentials:v,body:c,success:function(r){if(i.debug(r),"success"!==r.janus)return i.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);var t=r.data.id;i.log("Created handle: "+t);var o={session:T,plugin:n,id:t,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return t},getPlugin:function(){return n},getVolume:function(){return F(t,!0)},getRemoteVolume:function(){return F(t,!0)},getLocalVolume:function(){return F(t,!1)},isAudioMuted:function(){return J(t,!1)},muteAudio:function(){return U(t,!1,!0)},unmuteAudio:function(){return U(t,!1,!1)},isVideoMuted:function(){return J(t,!0)},muteVideo:function(){return U(t,!0,!0)},unmuteVideo:function(){return U(t,!0,!1)},getBitrate:function(){return W(t)},send:function(e){P(t,e)},data:function(e){V(t,e)},dtmf:function(e){j(t,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){L(t,!0,e)},createAnswer:function(e){L(t,!1,e)},handleRemoteJsep:function(e){N(t,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){G(t,!0===e)},detach:function(e){M(t,e)}};k[t]=o,e.success(o)},error:function(r,t){i.error(r+":",t),""===t?e.error(r+": Is the server down?"):e.error(r+": "+t)}})}(e)}}i.useDefaultDependencies=function(e){var r=e&&e.fetch||fetch,t=e&&e.Promise||Promise,n=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,r){return new n(e,r)},extension:e&&e.extension||o,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,n){var o={method:n.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===n.verb&&(o.headers["Content-Type"]="application/json"),void 0!==n.withCredentials&&(o.credentials=!0===n.withCredentials?"include":n.withCredentials?n.withCredentials:"omit"),n.body&&(o.body=JSON.stringify(n.body));var s=r(e,o).catch((function(e){return t.reject({message:"Probably a network error, is the server down?",error:e})}));if(n.timeout){var a=new t((function(e,r){var t=setTimeout((function(){return clearTimeout(t),r({message:"Request timed out",timeout:n.timeout})}),n.timeout)}));s=t.race([s,a])}return s.then((function(e){return e.ok?typeof n.success==typeof i.noop?e.json().then((function(e){n.success(e)})).catch((function(r){return t.reject({message:"Failed to parse response body",error:r,response:e})})):void 0:t.reject({message:"API call failed",response:e})})).catch((function(e){typeof n.error==typeof i.noop&&n.error(e.message||"<< internal error >>",e)})),s}}},i.useOldDependencies=function(e){var r=e&&e.jQuery||jQuery,t=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,r){return new t(e,r)},isArray:function(e){return r.isArray(e)},extension:e&&e.extension||o,webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,t){var n=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},o=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return r.ajax(r.extend(n,o,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof i.noop&&t.success(e)},error:function(e,r,n){typeof t.error==typeof i.noop&&t.error(r,n)}}))}}},i.noop=function(){},i.dataChanDefaultLabel="JanusDataChannel",i.endOfCandidates=null,i.stopAllTracks=function(e){try{var r=e.getTracks();for(var t of r)i.log(t),t&&t.stop()}catch(e){}},i.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:i.noop,i.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),i.trace=i.noop,i.debug=i.noop,i.vdebug=i.noop,i.log=i.noop,i.warn=i.noop,i.error=i.noop,!0===e.debug||"all"===e.debug)i.trace=console.trace.bind(console),i.debug=console.debug.bind(console),i.vdebug=console.debug.bind(console),i.log=console.log.bind(console),i.warn=console.warn.bind(console),i.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var r of e.debug)switch(r){case"trace":i.trace=console.trace.bind(console);break;case"debug":i.debug=console.debug.bind(console);break;case"vdebug":i.vdebug=console.debug.bind(console);break;case"log":i.log=console.log.bind(console);break;case"warn":i.warn=console.warn.bind(console);break;case"error":i.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+r+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}i.log("Initializing library");var t=e.dependencies||i.useDefaultDependencies();i.isArray=t.isArray,i.webRTCAdapter=t.webRTCAdapter,i.httpAPICall=t.httpAPICall,i.newWebSocket=t.newWebSocket,i.extension=t.extension,i.extension.init(),i.listDevices=function(e,r){e="function"==typeof e?e:i.noop,null==r&&(r={audio:!0,video:!0}),i.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(r).then((function(r){navigator.mediaDevices.enumerateDevices().then((function(t){i.debug(t),e(t),i.stopAllTracks(r)}))})).catch((function(r){i.error(r),e([])})):(i.warn("navigator.mediaDevices unavailable"),e([]))},i.attachMediaStream=function(e,r){try{e.srcObject=r}catch(t){try{e.src=URL.createObjectURL(r)}catch(e){i.error("Error attaching stream to element")}}},i.reattachMediaStream=function(e,r){try{e.srcObject=r.srcObject}catch(t){try{e.src=r.src}catch(e){i.error("Error reattaching stream to element")}}};var n=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",o=window["on"+n];if(window.addEventListener(n,(function(e){for(var r in i.log("Closing window"),i.sessions)i.sessions[r]&&i.sessions[r].destroyOnUnload&&(i.log("Destroying session "+r),i.sessions[r].destroy({unload:!0,notifyDestroyed:!1}));o&&"function"==typeof o&&o()})),i.safariVp8=!1,"safari"===i.webRTCAdapter.browserDetails.browser&&i.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var s of RTCRtpSender.getCapabilities("video").codecs)if(s&&s.mimeType&&"video/vp8"===s.mimeType.toLowerCase()){i.safariVp8=!0;break}i.safariVp8?i.log("This version of Safari supports VP8"):i.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var a=new RTCPeerConnection({});a.createOffer({offerToReceiveVideo:!0}).then((function(e){i.safariVp8=-1!==e.sdp.indexOf("VP8"),i.safariVp8?i.log("This version of Safari supports VP8"):i.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),a.close(),a=null}))}if(i.unifiedPlan=!1,"firefox"===i.webRTCAdapter.browserDetails.browser&&i.webRTCAdapter.browserDetails.version>=59)i.unifiedPlan=!0;else if("chrome"===i.webRTCAdapter.browserDetails.browser&&i.webRTCAdapter.browserDetails.version>=72)i.unifiedPlan=!0;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){var d=new RTCPeerConnection;try{d.addTransceiver("audio"),i.unifiedPlan=!0}catch(e){}d.close()}else i.unifiedPlan=!1;i.initDone=!0,e.callback()}},i.isWebrtcSupported=function(){return!!window.RTCPeerConnection},i.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},i.randomString=function(e){for(var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",n=0;n<e;n++){var o=Math.floor(Math.random()*r.length);t+=r.substring(o,o+1)}return t};class s extends n.EventEmitter{constructor(e){super(),this.pluginInstance=e,this.events={CLEANUP:"cleanup",CONSENT_DIALOG:"consentDialog",DATA:"data",DATA_OPEN:"dataopen",DETACHED:"detached",ICE_STATE:"iceState",MEDIA_STATE:"mediaState",SESSION_DESTROYED:"destroyed",SLOW_LINK:"slowLink",WEBRTC_STATE:"webrtcState"},e.consentDialog=this.emit.bind(this,this.events.CONSENT_DIALOG),e.iceState=this.emit.bind(this,this.events.ICE_STATE),e.mediaState=this.emit.bind(this,this.events.MEDIA_STATE),e.oncleanup=this.emit.bind(this,this.events.CLEANUP),e.ondata=this.emit.bind(this,this.events.DATA),e.ondataopen=this.emit.bind(this,this.events.DATA_OPEN),e.ondetached=this.emit.bind(this,this.events.DETACHED),e.slowLink=this.emit.bind(this,this.events.SLOW_LINK),e.webrtcState=this.emit.bind(this,this.events.WEBRTC_STATE);for(let e in this.pluginInstance){const r=e;Object.defineProperty(this,r,{enumerable:!0,value:this.pluginInstance[r]})}}get getId(){return this.pluginInstance.getId}get getPlugin(){return this.pluginInstance.getPlugin}get getVolume(){return this.pluginInstance.getVolume}get getRemoteVolume(){return this.pluginInstance.getRemoteVolume}get getLocalVolume(){return this.pluginInstance.getLocalVolume}get isAudioMuted(){return this.pluginInstance.isAudioMuted}get muteAudio(){return this.pluginInstance.muteAudio}get unmuteAudio(){return this.pluginInstance.unmuteAudio}get send(){return this.pluginInstance.send}get createOffer(){return this.pluginInstance.createOffer}get createAnswer(){return this.pluginInstance.createAnswer}get handleRemoteJsep(){return this.pluginInstance.handleRemoteJsep}get dtmf(){return this.pluginInstance.dtmf}get data(){return this.pluginInstance.data}get isVideoMuted(){return this.pluginInstance.isVideoMuted}get muteVideo(){return this.pluginInstance.muteVideo}get unmuteVideo(){return this.pluginInstance.unmuteVideo}get getBitrate(){return this.pluginInstance.getBitrate}get hangup(){return this.pluginInstance.hangup}get detach(){return this.pluginInstance.detach}get consentDialog(){return this.pluginInstance.consentDialog}get webrtcState(){return this.pluginInstance.webrtcState}get iceState(){return this.pluginInstance.iceState}get mediaState(){return this.pluginInstance.mediaState}get slowLink(){return this.pluginInstance.slowLink}get onmessage(){return this.pluginInstance.onmessage}get onlocalstream(){return this.pluginInstance.onlocalstream}get onremotestream(){return this.pluginInstance.onremotestream}get ondataopen(){return this.pluginInstance.ondataopen}get ondata(){return this.pluginInstance.ondata}get oncleanup(){return this.pluginInstance.oncleanup}get ondetached(){return this.pluginInstance.ondetached}}class a extends n.EventEmitter{constructor(e){if(super(),this._isOnlyAudio=!1,this._remoteFeeds={},this._sharingScreen=!1,this._bitrateTimers={},this.events={ERROR:"error",LOCAL_STREAM:"localStream",PARTICIPANT_JOINED:"participantjoined",PARTICIPANT_LEFT:"participantleft",REMOTE_STREAM:"remoteStream",SESSION_DESTROYED:"destroyed"},this.screenSharingEnabled=()=>this._sharingScreen,this.isVideoMuted=()=>!!this._videoRoomPlugin&&this._videoRoomPlugin.isVideoMuted(),this.isAudioMuted=()=>!!this._videoRoomPlugin&&this._videoRoomPlugin.isAudioMuted(),this.createSession=()=>new Promise(((e,r)=>{try{i.init({debug:this._config.debug,callback:()=>{this._engine=new i({destroyed:this.emit.bind(this,this.events.SESSION_DESTROYED),error:this.emit.bind(this,this.events.ERROR),iceServers:this._config.iceServers,server:this._config.server,success:e})}})}catch(e){r(e)}})),this.reconnect=()=>new Promise(((e,r)=>{if(!this._engine)return r('No janus instance. Check if "createSession" method has been called.');this._engine.reconnect({error:r,success:e})})),this.toggleAudioMute=()=>!!this._videoRoomPlugin&&(this._videoRoomPlugin.isAudioMuted()?this._videoRoomPlugin.unmuteAudio():this._videoRoomPlugin.muteAudio(),this._videoRoomPlugin.isAudioMuted()),this.toggleRemoteAudioMute=e=>{const r=this._remoteFeeds[e];if(!r)return!1;const t=r.webrtcStuff.remoteStream.getAudioTracks();if(t&&t.length>0){for(let e=0;e<t.length;e++)t[e].enabled=!t[e].enabled;return!t[0].enabled}return!1},this.isRemoteAudioMuted=e=>{const r=this._remoteFeeds[e];if(!r)return!1;const t=r.webrtcStuff.remoteStream.getAudioTracks();return!!(t&&t.length>0)&&!t.some((e=>e.enabled))},this.toggleVideoMute=()=>!!this._videoRoomPlugin&&(this._videoRoomPlugin.isVideoMuted()?this._videoRoomPlugin.unmuteVideo():this._videoRoomPlugin.muteVideo(),this._videoRoomPlugin.isVideoMuted()),this.toggleRemoteVideoMute=e=>{const r=this._remoteFeeds[e];if(!r)return!1;const t=r.webrtcStuff.remoteStream.getVideoTracks();if(t&&t.length>0){for(let e=0;e<t.length;e++)t[e].enabled=!t[e].enabled;return!t[0].enabled}return!1},this.isRemoteVideoMuted=e=>{const r=this._remoteFeeds[e];if(!r)return!1;const t=r.webrtcStuff.remoteStream.getVideoTracks();return!!(t&&t.length>0)&&!t.some((e=>e.enabled))},this.switchVideoInput=e=>new Promise(((r,t)=>this._videoRoomPlugin?this._isOnlyAudio?t(new Error("Can't switch video input in audio only call")):void this._createOffer({media:{video:{deviceId:e},replaceVideo:!0}}).then(r).catch(t):t(new Error("There is no videoroom plugin instance")))),this.switchAudioInput=e=>new Promise(((r,t)=>{if(!this._videoRoomPlugin)return t(new Error("There is no videoroom plugin instance"));this._createOffer({media:{audio:{deviceId:e},replaceAudio:!0}}).then(r).catch(t)})),this.showBitrate=(e,r)=>{const t=this._remoteFeeds[e];t&&r&&!this._bitrateTimers[e]&&(this._bitrateTimers[e]=window.setInterval((()=>{r.innerText=""+t.getBitrate()}),1e3))},this.hideBitrate=(e,r)=>{this._bitrateTimers[e]&&(clearInterval(this._bitrateTimers[e]),delete this._bitrateTimers[e]),r.innerText=""},this.destroySession=()=>new Promise(((e,r)=>{if(!this._engine)return r(new Error('No janus instance. Check if "createSession" method has been called.'));this._engine.destroy({error:r,success:e})})),this.attachVideoConferencingPlugin=(e,r)=>new Promise(((t,n)=>{if(!this._engine)return n(new Error('No janus instance. Check if "createSession" method has been called.'));if(e){if(this._remoteFeeds[r])return t(this._remoteFeeds[r])}else if(this._videoRoomPlugin)return t(this._videoRoomPlugin);this._engine.attach({plugin:"janus.plugin.videoroom",success:n=>{n.onmessage=this._onPluginmessage.bind(this,e,n),n.onlocalstream=e?void 0:e=>this.emit(this.events.LOCAL_STREAM,e),n.onremotestream=e?e=>this.emit(this.events.REMOTE_STREAM,e,r):void 0;const o=new s(n);if(e){this._remoteFeeds[r]=o;const e={request:"join",room:this._currentRoomId,ptype:"subscriber",feed:r,display:this._display};o.send({message:e})}else this._videoRoomPlugin=o;t(o)},error:n})})),this.detachVideoConferencingPlugin=()=>new Promise(((e,r)=>{if(!this._videoRoomPlugin)return r(new Error("There is no plugin to detach"));const t=()=>{this._videoRoomPlugin=void 0;const e=Object.keys(this._remoteFeeds).map(Number).map(this._detachRemoteFeed);return this._remoteFeeds={},Promise.all(e)};this._videoRoomPlugin.detach({success:()=>{t().then((()=>e())).catch(r)},error:e=>{t(),r(e)}})})),this.iceRestart=e=>new Promise(((r,t)=>{if(e){i.log("Performing remote ICE restart for user: ",e);const n=this._remoteFeeds[e];if(!n)return t(new Error("No remote feed for userId "+e));n.send({message:{request:"configure",restart:!0},success:()=>r(),error:t})}else i.log("Performing local ICE restart"),this._createOffer({iceRestart:!0}).then(r).catch(t)})),this.join=e=>new Promise(((r,t)=>{const{roomId:n,userId:o,display:s,onlyAudio:a=!1,role:d="publisher",video:c="lowres"}=e;return this._videoRoomPlugin?"boolean"!=typeof a?t(new Error('Parameter "onlyAudio" can be of type "boolean" only')):void 0!==d&&"publisher"!==d&&"subscriber"!==d?t(new Error(`"${d}" is not a valid value for "role" parameter`)):(this._isOnlyAudio=a,this._config.videoQuality=c,this._display=s,i.log(`Joining room ${n} with onlyAudio: ${this._isOnlyAudio}`),void this._videoRoomPlugin.send({message:{request:"join",room:n,ptype:d,id:o,display:s},success:()=>{this._currentRoomId=n,this._currentUserId=o,this._role=d,r()},error:t})):t(new Error("There is no videoroom plugin instance"))})),this.leave=()=>(i.log("Leaving room"),new Promise(((e,r)=>this._engine?this._engine.isConnected()?this._videoRoomPlugin?void this._videoRoomPlugin.send({message:{request:"leave",room:this._currentRoomId,id:this._currentUserId},success:()=>{this._currentRoomId=void 0,this._currentUserId=void 0,this._role=void 0,e()},error:r}):r(new Error("There is no videoroom plugin instance")):e():r(new Error('No janus instance. Check if "createSession" method has been called.'))))),this.listOnlineParticipants=e=>new Promise(((r,t)=>{if(!this._videoRoomPlugin)return t("There is no videoroom plugin instance");this._videoRoomPlugin.send({message:{request:"listparticipants",room:e},success:e=>{r(e&&e.participants?e.participants:[])},error:t})})),this.toggleScreenSharing=()=>this._isOnlyAudio?Promise.reject(new Error("Can't share screen in audio only call")):new Promise(((e,r)=>{this._createOffer(this._sharingScreen?{media:{replaceVideo:!0}}:{media:{audio:!0,video:"screen",replaceVideo:!0}}).then((()=>{this._sharingScreen=!this._sharingScreen,e()})).catch((e=>{this._sharingScreen&&(this._sharingScreen=!1),r(e)}))})),this._onPluginmessage=(e,r,t,n)=>{const o=t.videoroom;if(e)o&&t.error&&this.emit(this.events.ERROR,t.error),n&&r&&this._createAnswer(r,n).catch(this.emit.bind(this,this.events.ERROR));else{if(o)if("joined"===o)("publisher"===this._role?this._createOffer({media:{audioSend:!0,videoSend:!this._isOnlyAudio}}):Promise.resolve()).then((()=>{if(t.publishers){const e=t.publishers;for(const r of e)this.emit(this.events.PARTICIPANT_JOINED,r)}})).catch((e=>{this.emit(this.events.ERROR,e)}));else if("event"===o)if(t.publishers){const e=t.publishers;for(const r of e)this.emit(this.events.PARTICIPANT_JOINED,r)}else if(t.leaving){const e=t.leaving;this._detachRemoteFeed(e).then((()=>this.emit(this.events.PARTICIPANT_LEFT,e))).catch((e=>{this.emit(this.events.ERROR,e)}))}else if(t.unpublished){const e=t.unpublished;"ok"!=e&&this._detachRemoteFeed(e).then((()=>this.emit(this.events.PARTICIPANT_LEFT,e))).catch(this.emit.bind(this,this.events.ERROR))}else t.error&&this.emit(this.events.ERROR,t.error);n&&this._videoRoomPlugin&&this._videoRoomPlugin.handleRemoteJsep({jsep:n})}},this._detachRemoteFeed=e=>new Promise(((r,t)=>{const n=this._remoteFeeds[e];n?n.detach({success:()=>{this._bitrateTimers[e]&&(clearInterval(this._bitrateTimers[e]),delete this._bitrateTimers[e]),delete this._remoteFeeds[e],r()},error:t}):r()})),this._createOffer=e=>new Promise(((r,t)=>{if(!this._videoRoomPlugin)return t(new Error("There is no videoroom plugin instance"));i.log("createOffer, inputParams: ",e);const{media:n={}}=e,{audioSend:o=!0,videoSend:s=!this._isOnlyAudio,replaceVideo:a=!1}=n,d=function(e,r){var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&r.indexOf(n)<0&&(t[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)r.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(t[n[o]]=e[n[o]])}return t}(n,["audioSend","videoSend","replaceVideo"]),c=e.stream?e.stream:void 0,u=!!e.iceRestart&&e.iceRestart,l={media:{}};c?l.stream=c:a?l.media=Object.assign(Object.assign({},d),{replaceVideo:!0}):u?l.iceRestart=u:l.media=Object.assign({audioRecv:!1,videoRecv:!1,audioSend:o,videoSend:s},d),this._config.videoQuality&&l.media&&(void 0===l.media.video||"object"!=typeof l.media.video&&!1!==l.media.video&&"screen"!==l.media.video)&&(l.media.video=this._config.videoQuality),i.log("createOffer params: ",l),l.success=e=>{if(!this._videoRoomPlugin)throw new Error("There is no videoroom plugin instance");const t={jsep:e,message:{request:"configure"}};return a||u?t.message.restart=!0:(t.message.audio=o,t.message.video=s),i.log("createOffer publish: ",t),this._videoRoomPlugin.send(t),r()},l.error=e=>{i.error("Error in createOffer: ",e),t(e instanceof Error?e:new Error([e.code||"",e.name||"",e.message||""].join(" ")))},this._videoRoomPlugin.createOffer(l)})),this._createAnswer=(e,r)=>new Promise(((t,n)=>{e.createAnswer({jsep:r,media:{audioSend:!1,videoSend:!1},success:r=>{e.send({message:{request:"start",room:this._currentRoomId},jsep:r,success:()=>t(),error:n})},error:e=>{i.error("createAnswer error: ",e),n(e)}})})),!i.isWebrtcSupported())throw new Error("Your browser doesn't support WebRTC, so you can't use this functionality.");if(!e.server)throw new Error('Parameter "server" is mandatory');this._config=e}static listDevices(){return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices():Promise.resolve([])}static listVideoInputDevices(){return a.listDevices().then((e=>e.filter((e=>"videoinput"===e.kind))))}static listAudioInputDevices(){return a.listDevices().then((e=>e.filter((e=>"audioinput"===e.kind))))}get pluginId(){return this._videoRoomPlugin?this._videoRoomPlugin.getId():void 0}get sessionId(){return this._engine?this._engine.getSessionId():void 0}get currentRoomId(){return this._currentRoomId}get connected(){return!!this._engine&&this._engine.isConnected()}}a.attachMediaStream=(e,r)=>i.attachMediaStream(e,r)}},r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{}};return e[n](o,o.exports,t),o.exports}return t.d=(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),t(761)})().default}));